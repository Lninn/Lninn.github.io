import{s as w,j as e}from"./index-BsX8sO8e.js";import{b as i}from"./vendor-C_ovgAfI.js";import{c as q,f as z}from"./utils-CWHH1IbV.js";import{M as _}from"./index-uM9-ZLQG.js";import{z as A}from"./zh-CN-CCt-M6vz.js";const E=q(s=>({list:[],fetchBookmarks:async()=>{const{data:t,error:n}=await w.from("bookmark").select("*").order("create_at",{ascending:!1});if(n){console.error("Failed to fetch bookmark data:",n);return}s({list:t})}})),M=async s=>{var t,n,r,o;try{const m="https://api.allorigins.win/get?url="+encodeURIComponent(s),g=await(await fetch(m)).json();if(!g.contents)throw new Error("无法获取网站内容");const u=new DOMParser().parseFromString(g.contents,"text/html");let a=((t=u.querySelector("title"))==null?void 0:t.textContent)||"";a||(a=((n=u.querySelector('meta[property="og:title"]'))==null?void 0:n.getAttribute("content"))||"");let x="";const f=u.querySelector('link[rel="icon"]')||u.querySelector('link[rel="shortcut icon"]');f&&(x=new URL(f.getAttribute("href"),s).href),x||(x=`https://www.google.com/s2/favicons?domain=${s}`);let j=((r=u.querySelector('meta[name="keywords"]'))==null?void 0:r.getAttribute("content"))||"",y=((o=u.querySelector('meta[name="description"]'))==null?void 0:o.getAttribute("content"))||"",N=O(j+" "+y)||R(new URL(s).hostname);return{title:a||$(s),icon:x,suggestedCategory:N}}catch(m){return console.error("获取网站信息失败:",m),D(s)}},O=(s="")=>{const t=s.toLowerCase(),n={技术:["programming","developer","coding","编程","开发","技术"],新闻:["news","daily","report","新闻","资讯"],购物:["shop","store","buy","price","商城","购物"],教育:["learn","course","education","study","教育","学习"],娱乐:["game","entertainment","movie","music","游戏","电影","音乐"],社交:["social","community","forum","社区","论坛"]};for(const[r,o]of Object.entries(n))if(o.some(m=>t.includes(m)))return r;return null},$=s=>{try{const t=new URL(s).hostname;return t.split(".")[0].charAt(0).toUpperCase()+t.split(".")[0].slice(1)}catch{return s}},D=s=>{try{const t=new URL(s).hostname;return{title:$(s),icon:`https://www.google.com/s2/favicons?domain=${s}`,suggestedCategory:R(t)}}catch{throw new Error("无效的URL格式")}},R=s=>{const t={github:"开发工具",stackoverflow:"开发工具",youtube:"视频",bilibili:"视频",google:"搜索",baidu:"搜索",zhihu:"社交",weibo:"社交",twitter:"社交",facebook:"社交",instagram:"社交",amazon:"购物",taobao:"购物",jd:"购物"};for(const[n,r]of Object.entries(t))if(s.includes(n))return r;return"其他"},U=(s,t)=>{const n=s.toLowerCase().replace(/\/$/,"");return t.some(r=>r.url.toLowerCase().replace(/\/$/,"")===n)};function B({formData:s,setFormData:t,categories:n,onSubmit:r,onCancel:o}){const[m,p]=i.useState(!1);i.useEffect(()=>{const d=u=>{m&&!u.target.closest(".category-select-container")&&p(!1)};return document.addEventListener("mousedown",d),()=>document.removeEventListener("mousedown",d)},[m]);const g=d=>{d.preventDefault(),r(s)};return e.jsxs("form",{onSubmit:g,className:"bookmark-form",children:[e.jsx("h3",{children:"书签信息"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:s.name,onChange:d=>t(u=>({...u,name:d.target.value})),placeholder:"书签名称",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:s.category,onChange:d=>t(u=>({...u,category:d.target.value})),onFocus:()=>p(!0),placeholder:"选择或输入新分类",required:!0}),m&&n.length>0&&e.jsx("div",{className:"category-dropdown",children:n.map((d,u)=>e.jsx("div",{className:`category-option ${s.category===d?"selected":""}`,onClick:()=>{t(a=>({...a,category:d})),p(!1)},children:d},u))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-preview",children:[s.icon&&e.jsx("img",{src:s.icon,alt:"网站图标"}),e.jsx("input",{type:"text",value:s.icon,onChange:d=>t(u=>({...u,icon:d.target.value})),placeholder:"图标URL"})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:o,children:"取消"}),e.jsx("button",{type:"submit",className:"submit-button",children:"添加书签"})]})]})}function F({analyzing:s,analysisStep:t,analysisError:n,urlExists:r}){const o=["开始分析","验证URL格式","获取网站元数据","处理分析结果","分析完成"];return e.jsxs(e.Fragment,{children:[s&&e.jsxs("div",{className:"analysis-status",children:[e.jsx("h3",{children:"正在分析网站..."}),e.jsx("div",{className:"analysis-steps",children:o.map((m,p)=>e.jsxs("div",{className:`analysis-step ${t===m?"active":""} ${o.indexOf(m)<o.indexOf(t)?"complete":""}`,children:[e.jsx("div",{className:"step-indicator",children:p+1}),e.jsx("div",{className:"step-label",children:m})]},p))})]}),r&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:"该URL已存在于您的书签中"}),e.jsx("p",{className:"error-tip",children:"提示：您可以在书签列表中查找此网站。"})]}),n&&!r&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:n}),e.jsx("p",{className:"error-tip",children:"提示：请检查网址是否正确，或稍后再试。"})]})]})}function H({onClose:s,onSubmit:t}){const{list:n}=E(),[r,o]=i.useState(""),[m,p]=i.useState({url:"",name:"",category:"",icon:""}),[g,d]=i.useState(!1),[u,a]=i.useState(null),[x,f]=i.useState(null),[j,y]=i.useState(!1),[N,h]=i.useState([]),[b,k]=i.useState(!1);i.useEffect(()=>{if(n&&n.length>0){const c=[...new Set(n.map(v=>v.category).filter(Boolean))];h(c)}},[n]);const S=async()=>{if(!(!r||!r.trim())){d(!0),a("开始分析"),f(null),y(!1),k(!1);try{a("验证URL格式");let c=r;!r.startsWith("http://")&&!r.startsWith("https://")&&(c="https://"+r);const v=c.toLowerCase().replace(/\/$/,"");if(U(v,n)){k(!0),f("该URL已存在于您的书签中"),d(!1);return}a("获取网站元数据");const L=await M(c);a("处理分析结果"),p({url:c,name:L.title||"",icon:L.icon||"",category:L.suggestedCategory||""}),a("分析完成"),y(!0)}catch(c){f(`在"${u}"步骤失败: ${c.message}`)}finally{d(!1)}}},l=c=>{const v=c.url.toLowerCase().replace(/\/$/,"");if(U(v,n)){k(!0),f("该URL已存在于您的书签中");return}t(c),s()};return e.jsx(_,{isOpen:!0,onClose:s,title:"添加新书签",size:"md",position:"center",children:e.jsxs("div",{className:"bookmark-modal-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"网址"}),e.jsxs("div",{className:"url-input-container",children:[e.jsx("input",{type:"url",value:r,onChange:c=>o(c.target.value),placeholder:"输入网站地址",required:!0}),e.jsx("button",{type:"button",className:"analyze-button",onClick:S,disabled:g||!r,children:"分析"})]})]}),e.jsx(F,{analyzing:g,analysisStep:u,analysisError:x,urlExists:b}),j&&e.jsx(B,{formData:m,setFormData:p,categories:N,onSubmit:l,onCancel:s})]})})}function I({bookmark:s,onClose:t,onSubmit:n}){const{list:r}=E(),[o,m]=i.useState({name:s.name,category:s.category,icon:s.icon}),[p,g]=i.useState([]),[d,u]=i.useState(!1),[a,x]=i.useState(!1),[f,j]=i.useState(!1),y=i.useRef({name:s.name,category:s.category,icon:s.icon}).current;i.useEffect(()=>{const h=o.name!==y.name||o.category!==y.category||o.icon!==y.icon;j(h)},[o,y]),i.useEffect(()=>{if(r&&r.length>0){const h=[...new Set(r.map(b=>b.category).filter(Boolean))];g(h)}},[r]),i.useEffect(()=>{const h=b=>{d&&!b.target.closest(".category-select-container")&&u(!1)};return document.addEventListener("mousedown",h),()=>document.removeEventListener("mousedown",h)},[d]);const N=async h=>{if(h.preventDefault(),!(!f||a)){x(!0);try{await n({...s,...o}),t()}catch(b){console.error("保存书签失败:",b)}finally{x(!1)}}};return e.jsx(_,{isOpen:!0,onClose:t,title:"编辑书签",size:"md",position:"center",children:e.jsx("div",{className:"bookmark-modal-content",children:e.jsxs("form",{onSubmit:N,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:o.name,onChange:h=>m({...o,name:h.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-input-container",children:[e.jsx("input",{type:"text",value:o.icon,onChange:h=>m({...o,icon:h.target.value}),placeholder:"输入图标 URL"}),o.icon&&e.jsx("div",{className:"icon-preview",children:e.jsx("img",{src:o.icon,alt:"图标预览",onError:h=>h.target.src="/fallback-icon.svg"})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:o.category,onChange:h=>m({...o,category:h.target.value}),onFocus:()=>u(!0),placeholder:"选择或输入新分类"}),d&&p.length>0&&e.jsx("div",{className:"category-dropdown",children:p.map(h=>e.jsx("div",{className:`category-option ${h===o.category?"selected":""}`,onClick:()=>{m({...o,category:h}),u(!1)},children:h},h))})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:t,disabled:a,children:"取消"}),e.jsx("button",{type:"submit",className:`submit-button ${a?"loading":""}`,disabled:!f||a,children:a?"保存中...":"保存修改"})]})]})})})}function T({message:s,type:t="success",onClose:n,duration:r=3e3}){return i.useEffect(()=>{const o=setTimeout(()=>{n()},r);return()=>clearTimeout(o)},[r,n]),e.jsxs("div",{className:`notification notification-${t}`,children:[e.jsx("span",{className:"notification-icon",children:t==="success"?"✓":"✕"}),e.jsx("span",{className:"notification-message",children:s})]})}function W({onRestore:s,onNotify:t}){const[n,r]=i.useState([]),[o,m]=i.useState(!1),[p,g]=i.useState(new Set),d=async()=>{m(!0);try{const{data:a}=await w.from("bookmark_history").select("restored_from_id").not("restored_from_id","is",null),x=new Set((a==null?void 0:a.map(y=>y.restored_from_id))||[]);g(x);const{data:f,error:j}=await w.from("bookmark_history").select("*").order("created_at",{ascending:!1});if(j)throw j;r(f)}catch(a){console.error("获取历史记录失败:",a),t==null||t({type:"error",message:"获取历史记录失败"})}finally{m(!1)}};i.useEffect(()=>{d()},[]);const u=async a=>{try{const{bookmark_data:x}=a,{error:f}=await w.from("bookmark").insert([x]);if(f)throw f;const{error:j}=await w.from("bookmark_history").insert([{action:"restore",bookmark_id:x.id,bookmark_data:x,restored_from_id:a.id}]);if(j)throw j;t==null||t({type:"success",message:"书签恢复成功"}),s==null||s(),d()}catch(x){console.error("恢复书签失败:",x),t==null||t({type:"error",message:"恢复书签失败"})}};return e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"操作历史"}),e.jsx("span",{className:"history-count",children:o?"加载中...":`${n.length} 条记录`})]}),o?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载历史记录..."})]}):e.jsx("div",{className:"history-list",children:n.map(a=>e.jsxs("div",{className:"history-item",children:[e.jsxs("div",{className:"history-content",children:[e.jsxs("span",{className:"history-action",children:[a.action==="add"&&"添加了",a.action==="delete"&&"删除了",a.action==="update"&&"修改了",a.action==="restore"&&"恢复了"]}),e.jsx("span",{className:"history-name",children:a.bookmark_data.name}),e.jsx("span",{className:"history-time",children:z(new Date(a.created_at),{addSuffix:!0,locale:A})})]}),a.action==="delete"&&!p.has(a.id)&&e.jsx("button",{className:"restore-button",onClick:()=>u(a),children:"恢复"})]},a.id))})]})}function V(){const[s,t]=i.useState(!0),{list:n,fetchBookmarks:r}=E();i.useEffect(()=>{(async()=>{t(!0),await r(),t(!1)})()},[]);const[o,m]=i.useState(!1),[p,g]=i.useState(null),d=l=>{navigator.clipboard.writeText(l).then(()=>{g({type:"success",message:"URL已复制到剪贴板"})}).catch(()=>{g({type:"error",message:"复制失败，请手动复制"})})},u=async l=>{try{const c=Date.now()+Math.floor(Math.random()*1e3),v={...l,id:c,create_at:new Date().toISOString()},{error:C}=await w.from("bookmark").insert([v]).select();if(C)throw C;await S("add",v),g({type:"success",message:"成功添加书签"}),r()}catch(c){console.log(c),g({type:"error",message:"添加书签失败，请稍后重试"})}},a=async l=>{try{const{error:c}=await w.from("bookmark").delete().eq("url",l.url);if(c)throw c;await S("delete",l),g({type:"success",message:"成功删除书签"}),r()}catch(c){console.error(c),g({type:"error",message:"删除书签失败"})}},[x,f]=i.useState(!1),[j,y]=i.useState(null),N=l=>{y(l),f(!0)},h=async l=>{try{const{error:c}=await w.from("bookmark").update({name:l.name,category:l.category,icon:l.icon}).eq("url",l.url);if(c)throw c;await S("update",l),g({type:"success",message:"成功更新书签"}),r()}catch(c){console.error(c),g({type:"error",message:"更新书签失败"})}f(!1),y(null)},[b,k]=i.useState(!1),S=async(l,c)=>{try{await w.from("bookmark_history").insert([{action:l,bookmark_id:c.id,bookmark_data:c}])}catch(v){console.error("记录历史失败:",v)}};return e.jsxs("div",{className:"dashboard",children:[e.jsxs("div",{className:"dashboard-tabs",children:[e.jsx("button",{className:`tab-button ${b?"":"active"}`,onClick:()=>k(!1),children:"书签列表"}),e.jsx("button",{className:`tab-button ${b?"active":""}`,onClick:()=>k(!0),children:"操作历史"})]}),e.jsx("div",{className:"dashboard-content",children:b?e.jsx(W,{onRestore:r,onNotify:g}):e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"书签列表"}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{className:"add-button",onClick:()=>m(!0),children:[e.jsx("span",{className:"button-icon",children:"+"}),"添加书签"]}),e.jsx("span",{className:"bookmark-count",children:s?"加载中...":`${n.length} 个书签`})]})]}),s?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载书签..."})]}):e.jsx("div",{className:"bookmark-list",children:n.map(l=>e.jsxs("div",{className:"bookmark-item",children:[e.jsx("div",{className:"bookmark-icon-wrapper",children:e.jsx("img",{"data-name":l.name,"data-category":l.category,src:l.icon,alt:"",className:"bookmark-icon",loading:"lazy",onError:c=>{c.target.src="/fallback-icon.svg"}})}),e.jsxs("div",{className:"bookmark-info",children:[e.jsx("h3",{children:l.name}),e.jsx("p",{className:"category-tag",children:l.category}),e.jsxs("div",{className:"url-container",children:[e.jsx("a",{href:l.url,target:"_blank",rel:"noopener noreferrer",children:l.url}),e.jsx("button",{className:"copy-button",onClick:c=>{c.preventDefault(),d(l.url)},title:"复制URL",children:"📋"})]})]}),e.jsxs("div",{className:"bookmark-actions",children:[e.jsx("button",{className:"edit-button",onClick:()=>N(l),title:"编辑书签",children:"✏️"}),e.jsx("button",{className:"delete-button",onClick:()=>a(l),title:"删除书签",children:e.jsx("span",{className:"delete-icon",children:"×"})})]})]},l.url))})]})}),o&&e.jsx(H,{onClose:()=>m(!1),onSubmit:u}),x&&j&&e.jsx(I,{bookmark:j,onClose:()=>{f(!1),y(null)},onSubmit:h}),p&&e.jsx(T,{type:p.type,message:p.message,onClose:()=>g(null)})]})}export{V as default};
