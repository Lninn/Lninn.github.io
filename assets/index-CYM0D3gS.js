import{j as l,s as G}from"./index-CvC0IVlO.js";import{M as H}from"./index-Cw3Sa-D2.js";import{b as A}from"./vendor-D6FSTBK7.js";import{u as mt,N as pt}from"./useNotification-CIolVn4i.js";import{P as gt}from"./index-NgApjOQs.js";import ht from"./MapContainer-BolWF1Rt.js";import"./utils-B-ph8sPT.js";function y(t,e){return Array.from(t.getElementsByTagName(e))}function E(t){return t[0]==="#"?t:`#${t}`}function yt(t,e,n){return Array.from(t.getElementsByTagNameNS(n,e))}function p(t){return t==null||t.normalize(),(t==null?void 0:t.textContent)||""}function f(t,e,n){const r=t.getElementsByTagName(e);return r.length?r[0]:null}function d(t,e,n){const r={};if(!t)return r;const o=t.getElementsByTagName(e),i=o.length?o[0]:null;return i&&n?n(i,r):r}function P(t,e,n){const r=p(f(t,e));return r&&n?n(r)||{}:{}}function m(t,e,n){const r=Number.parseFloat(p(f(t,e)));if(!Number.isNaN(r))return n&&n(r),r}function v(t,e){const n={};for(const r of e)P(t,r,o=>{n[r]=o});return n}function W(t){return(t==null?void 0:t.nodeType)===1}function K(t,e){const n={},r=e==="stroke"||e==="fill"?e:`${e}-color`;return t[0]==="#"&&(t=t.substring(1)),t.length===6||t.length===3?n[r]=`#${t}`:t.length===8&&(n[`${e}-opacity`]=Number.parseInt(t.substring(0,2),16)/255,n[r]=`#${t.substring(6,8)}${t.substring(4,6)}${t.substring(2,4)}`),n}function M(t,e,n){const r={};return m(t,e,o=>{r[n]=o}),r}function B(t,e){return d(t,"color",n=>K(p(n),e))}function D(t){return d(t,"Icon",(e,n)=>(P(e,"href",r=>{n.icon=r}),n))}function dt(t){return d(t,"IconStyle",e=>Object.assign(B(e,"icon"),M(e,"scale","icon-scale"),M(e,"heading","icon-heading"),d(e,"hotSpot",n=>{const r=Number.parseFloat(n.getAttribute("x")||""),o=Number.parseFloat(n.getAttribute("y")||""),i=n.getAttribute("xunits")||"",s=n.getAttribute("yunits")||"";return!Number.isNaN(r)&&!Number.isNaN(o)?{"icon-offset":[r,o],"icon-offset-units":[i,s]}:{}}),D(e)))}function bt(t){return d(t,"LabelStyle",e=>Object.assign(B(e,"label"),M(e,"scale","label-scale")))}function xt(t){return d(t,"LineStyle",e=>Object.assign(B(e,"stroke"),M(e,"width","stroke-width")))}function Lt(t){return d(t,"PolyStyle",(e,n)=>Object.assign(n,d(e,"color",r=>K(p(r),"fill")),P(e,"fill",r=>{if(r==="0")return{"fill-opacity":0}}),P(e,"outline",r=>{if(r==="0")return{"stroke-opacity":0}})))}function R(t){return Object.assign({},Lt(t),xt(t),bt(t),dt(t))}const Nt=/\s*/g,Ot=/^\s*|\s*$/g,Tt=/\s+/;function J(t){return t.replace(Nt,"").split(",").map(Number.parseFloat).filter(e=>!Number.isNaN(e)).slice(0,3)}function C(t){return t.replace(Ot,"").split(Tt).map(J).filter(e=>e.length>=2)}function At(t){let e=y(t,"coord");e.length===0&&(e=yt(t,"coord","*"));const n=e.map(r=>p(r).split(" ").map(Number.parseFloat));return n.length===0?null:{geometry:n.length>2?{type:"LineString",coordinates:n}:{type:"Point",coordinates:n[0]},times:y(t,"when").map(r=>p(r))}}function X(t){if(t.length===0)return t;const e=t[0],n=t[t.length-1];let r=!0;for(let o=0;o<Math.max(e.length,n.length);o++)if(e[o]!==n[o]){r=!1;break}return r?t:t.concat([t[0]])}function w(t){return p(f(t,"coordinates"))}function Y(t){let e=[],n=[];for(let r=0;r<t.childNodes.length;r++){const o=t.childNodes.item(r);if(W(o))switch(o.tagName){case"MultiGeometry":case"MultiTrack":case"gx:MultiTrack":{const i=Y(o);e=e.concat(i.geometries),n=n.concat(i.coordTimes);break}case"Point":{const i=J(w(o));i.length>=2&&e.push({type:"Point",coordinates:i});break}case"LinearRing":case"LineString":{const i=C(w(o));i.length>=2&&e.push({type:"LineString",coordinates:i});break}case"Polygon":{const i=[];for(const s of y(o,"LinearRing")){const a=X(C(w(s)));a.length>=4&&i.push(a)}i.length&&e.push({type:"Polygon",coordinates:i});break}case"Track":case"gx:Track":{const i=At(o);if(!i)break;const{times:s,geometry:a}=i;e.push(a),s.length&&n.push(s);break}}}return{geometries:e,coordTimes:n}}const T=t=>Number(t),F={string:t=>t,int:T,uint:T,short:T,ushort:T,float:T,double:T,bool:t=>!!t};function I(t,e){return d(t,"ExtendedData",(n,r)=>{for(const o of y(n,"Data"))r[o.getAttribute("name")||""]=p(f(o,"value"));for(const o of y(n,"SimpleData")){const i=o.getAttribute("name")||"",s=e[i]||F.string;r[i]=s(p(o))}return r})}function U(t){const e=f(t,"description");for(const n of Array.from((e==null?void 0:e.childNodes)||[]))if(n.nodeType===4)return{description:{"@type":"html",value:p(n)}};return{}}function $(t){return d(t,"TimeSpan",e=>({timespan:{begin:p(f(e,"begin")),end:p(f(e,"end"))}}))}function V(t){return d(t,"TimeStamp",e=>({timestamp:p(f(e,"when"))}))}function z(t,e){return P(t,"styleUrl",n=>(n=E(n),e[n]?Object.assign({styleUrl:n},e[n]):{styleUrl:n}))}var h;(function(t){t.ABSOLUTE="absolute",t.RELATIVE_TO_GROUND="relativeToGround",t.CLAMP_TO_GROUND="clampToGround",t.CLAMP_TO_SEAFLOOR="clampToSeaFloor",t.RELATIVE_TO_SEAFLOOR="relativeToSeaFloor"})(h||(h={}));function Pt(t){switch(t==null?void 0:t.textContent){case h.ABSOLUTE:return h.ABSOLUTE;case h.CLAMP_TO_GROUND:return h.CLAMP_TO_GROUND;case h.CLAMP_TO_SEAFLOOR:return h.CLAMP_TO_SEAFLOOR;case h.RELATIVE_TO_GROUND:return h.RELATIVE_TO_GROUND;case h.RELATIVE_TO_SEAFLOOR:return h.RELATIVE_TO_SEAFLOOR}return null}function kt(t){return f(t,"gx:LatLonQuad")?{geometry:{type:"Polygon",coordinates:[X(C(w(t)))]}}:wt(t)}const St=Math.PI/180;function jt(t,e,n){const r=[(t[0]+t[2])/2,(t[1]+t[3])/2];return[e[0].map(o=>{const i=o[1]-r[1],s=o[0]-r[0],a=Math.sqrt(i**2+s**2),u=Math.atan2(i,s)+n*St;return[r[0]+Math.cos(u)*a,r[1]+Math.sin(u)*a]})]}function wt(t){const e=f(t,"LatLonBox");if(e){const n=m(e,"north"),r=m(e,"west"),o=m(e,"east"),i=m(e,"south"),s=m(e,"rotation");if(typeof n=="number"&&typeof i=="number"&&typeof r=="number"&&typeof o=="number"){const a=[r,i,o,n];let u=[[[r,n],[o,n],[o,i],[r,i],[r,n]]];return typeof s=="number"&&(u=jt(a,u,s)),{bbox:a,geometry:{type:"Polygon",coordinates:u}}}}return null}function Et(t,e,n,r){var u;const o=kt(t),i=(o==null?void 0:o.geometry)||null;if(!i&&r.skipNullGeometry)return null;const s={type:"Feature",geometry:i,properties:Object.assign({"@geometry-type":"groundoverlay"},v(t,["name","address","visibility","open","phoneNumber","description"]),U(t),z(t,e),R(t),D(t),I(t,n),$(t),V(t))};o!=null&&o.bbox&&(s.bbox=o.bbox),((u=s.properties)==null?void 0:u.visibility)!==void 0&&(s.properties.visibility=s.properties.visibility!=="0");const a=t.getAttribute("id");return a!==null&&a!==""&&(s.id=a),s}function Mt(t){const e=f(t,"Region");return e?{coordinateBox:Rt(e),lod:vt(t)}:null}function vt(t){const e=f(t,"Lod");return e?[m(e,"minLodPixels")??-1,m(e,"maxLodPixels")??-1,m(e,"minFadeExtent")??null,m(e,"maxFadeExtent")??null]:null}function Rt(t){const e=f(t,"LatLonAltBox");if(e){const n=m(e,"north"),r=m(e,"west"),o=m(e,"east"),i=m(e,"south");if(Pt(f(e,"altitudeMode")||f(e,"gx:altitudeMode"))&&console.debug("Encountered an unsupported feature of KML for togeojson: please contact developers for support of altitude mode."),typeof n=="number"&&typeof i=="number"&&typeof r=="number"&&typeof o=="number")return{bbox:[r,i,o,n],geometry:{type:"Polygon",coordinates:[[[r,n],[o,n],[o,i],[r,i],[r,n]]]}}}return null}function _t(t){const e=f(t,"Link");return e?v(e,["href","refreshMode","refreshInterval","viewRefreshMode","viewRefreshTime","viewBoundScale","viewFormat","httpQuery"]):{}}function Ct(t,e,n,r){var u,L,j;const o=Mt(t),i=((u=o==null?void 0:o.coordinateBox)==null?void 0:u.geometry)||null;if(!i&&r.skipNullGeometry)return null;const s={type:"Feature",geometry:i,properties:Object.assign({"@geometry-type":"networklink"},v(t,["name","address","visibility","open","phoneNumber","styleUrl","refreshVisibility","flyToView","description"]),U(t),z(t,e),R(t),D(t),I(t,n),$(t),V(t),_t(t),o!=null&&o.lod?{lod:o.lod}:{})};(L=o==null?void 0:o.coordinateBox)!=null&&L.bbox&&(s.bbox=o.coordinateBox.bbox),((j=s.properties)==null?void 0:j.visibility)!==void 0&&(s.properties.visibility=s.properties.visibility!=="0");const a=t.getAttribute("id");return a!==null&&a!==""&&(s.id=a),s}function Ft(t){return t.length===0?null:t.length===1?t[0]:{type:"GeometryCollection",geometries:t}}function Gt(t,e,n,r){var L;const{coordTimes:o,geometries:i}=Y(t),s=Ft(i);if(!s&&r.skipNullGeometry)return null;const a={type:"Feature",geometry:s,properties:Object.assign(v(t,["name","address","visibility","open","phoneNumber","description"]),U(t),z(t,e),R(t),I(t,n),$(t),V(t),o.length?{coordinateProperties:{times:o.length===1?o[0]:o}}:{})};((L=a.properties)==null?void 0:L.visibility)!==void 0&&(a.properties.visibility=a.properties.visibility!=="0");const u=t.getAttribute("id");return u!==null&&u!==""&&(a.id=u),a}function Bt(t){let e=t.getAttribute("id");const n=t.parentNode;return!e&&W(n)&&n.localName==="CascadingStyle"&&(e=n.getAttribute("kml:id")||n.getAttribute("id")),E(e||"")}function Dt(t){const e={};for(const n of y(t,"Style"))e[Bt(n)]=R(n);for(const n of y(t,"StyleMap")){const r=E(n.getAttribute("id")||"");P(n,"styleUrl",o=>{o=E(o),e[o]&&(e[r]=e[o])})}return e}function It(t){const e={};for(const n of y(t,"SimpleField"))e[n.getAttribute("name")||""]=F[n.getAttribute("type")||""]||F.string;return e}function*Ut(t,e={skipNullGeometry:!1}){const n=t,r=Dt(n),o=It(n);for(const i of y(n,"Placemark")){const s=Gt(i,r,o,e);s&&(yield s)}for(const i of y(n,"GroundOverlay")){const s=Et(i,r,o,e);s&&(yield s)}for(const i of y(n,"NetworkLink")){const s=Ct(i,r,o,e);s&&(yield s)}}function $t(t,e={skipNullGeometry:!1}){return{type:"FeatureCollection",features:Array.from(Ut(t,e))}}function ee(){const[t,e]=A.useState(!1),[n,r]=A.useState(!1),o=A.useRef(null),{notification:i,notify:s,clearNotification:a}=mt(),{userPathList:u,refresh:L}=Qt(),[j,Q]=A.useState(0);function Z(){e(!0)}function tt(){r(!0)}function et(){s("success","添加成功"),o.current=null,Q(0),e(!1),L()}function nt(c){s("success","删除 "+c.name+" 成功"),L()}async function rt(c){const b=c.name,N=await at(c),g=st(N),O=it(g),q=(await ot(O)).map(S=>S.toArray()).join("|"),_=O.map(S=>S.join(",")).join("|"),k={name:b,originalPath:_,gpsPath:q};try{await zt(k),et()}catch{s("error","添加路径接口失败")}}async function ot(c,b="gps",N=400){let g=0;const O=[];for(let x=0;x<c.length;x+=N){const _=c.slice(x,x+N).map(k=>k.join(",")).join("|");await new Promise(k=>{window.AMap.convertFrom(_,b,(S,lt)=>{if(S==="complete"){O.push(...lt.locations),k();const ft=(Math.min(x+N,c.length)/c.length*100).toFixed(2);Q(ft)}})}),g%2===0?(await Vt(1),g=0):g++}return O}function it(c){return c.features[2].geometry.coordinates.map(x=>[x[0],x[1]])}function st(c){return $t(new DOMParser().parseFromString(c,"text/xml"))}function at(c){return new Promise((b,N)=>{const g=new FileReader;g.readAsText(c),g.onerror=()=>{N(g.error)},g.onload=()=>{const O=g.result;b(O)}})}function ct(c){const b=c.target.files;b.length<=0||(o.current=b[0])}function ut(){const c=o.current;c?rt(c):s("error","没有选择文件")}return l.jsxs("div",{children:[l.jsx("button",{className:"btn btn-primary",onClick:Z,children:"导入轨迹"}),l.jsx("button",{className:"btn btn-primary",onClick:tt,children:"路径管理"}),l.jsx(ht,{userPathList:u}),l.jsx(qt,{open:n,onClose:()=>r(!1),userPathList:u,onDelete:c=>{nt(c)}}),l.jsx(H,{isOpen:t,onClose:()=>e(!1),title:"导入轨迹",size:"md",position:"center",children:l.jsxs("form",{children:[l.jsxs("div",{className:"form-item",children:[l.jsx("label",{children:"坐标解析进度"}),l.jsx(gt,{percent:j})]}),l.jsx("div",{className:"form-item",children:l.jsx("input",{type:"file",onChange:ct})}),l.jsx("div",{className:"form-item",children:l.jsx("button",{className:"btn btn-primary",onClick:ut,children:"同步"})})]})}),i&&l.jsx(pt,{type:i.type,message:i.message,onClose:a})]})}function Vt(t){return new Promise(e=>setTimeout(e,t*1e3))}async function zt({name:t,originalPath:e,gpsPath:n}){const{error:r}=await G.from("user_paths").insert([{name:t,original_path:e,gps_path:n}]).select();if(r)throw r}function Qt(){const[t,e]=A.useState([]);async function n(){let{data:r}=await G.from("user_paths").select("*");e(r)}return A.useEffect(()=>{async function r(){await n()}r()},[]),{userPathList:t,refresh:n}}function qt({open:t,onClose:e,userPathList:n,onDelete:r}){async function o(i){const{error:s}=await G.from("user_paths").delete().eq("name",i.name);s||r(i)}return l.jsx(H,{isOpen:t,onClose:e,title:"导入轨迹",size:"md",position:"center",children:n.map(i=>l.jsx("div",{children:l.jsxs("div",{children:[i.name," ",l.jsx("button",{onClick:()=>o(i),children:"删除"})]})},i.name))})}export{ee as default};
