import{s as N,j as e}from"./index-gUxgvQXj.js";import{b as i}from"./vendor-BcWs5nYV.js";import{c as F,f as R}from"./utils-B751hktW.js";import{M as B,F as z,a as q,b as D,c as M,d as O,e as I,f as H}from"./index-C2eAltcX.js";import{z as P}from"./zh-CN-CbY1ib9b.js";import{b as L}from"./bookmark--cKmty33.js";const E=F(s=>({list:[],fetchBookmarks:async()=>{const{data:t,error:r}=await N.from("bookmark").select("*").order("create_at",{ascending:!1});if(r){console.error("Failed to fetch bookmark data:",r);return}s({list:t})}})),T=async s=>{var t,r,n,o;try{const c="https://api.allorigins.win/get?url="+encodeURIComponent(s),h=await(await fetch(c)).json();if(!h.contents)throw new Error("无法获取网站内容");const d=new DOMParser().parseFromString(h.contents,"text/html");let a=((t=d.querySelector("title"))==null?void 0:t.textContent)||"";a||(a=((r=d.querySelector('meta[property="og:title"]'))==null?void 0:r.getAttribute("content"))||"");let l="";const p=d.querySelector('link[rel="icon"]')||d.querySelector('link[rel="shortcut icon"]');p&&(l=new URL(p.getAttribute("href"),s).href),l||(l=`https://www.google.com/s2/favicons?domain=${s}`);let g=((n=d.querySelector('meta[name="keywords"]'))==null?void 0:n.getAttribute("content"))||"",f=((o=d.querySelector('meta[name="description"]'))==null?void 0:o.getAttribute("content"))||"",k=W(g+" "+f)||$(new URL(s).hostname);return{title:a||_(s),icon:l,suggestedCategory:k}}catch(c){return console.error("获取网站信息失败:",c),G(s)}},W=(s="")=>{const t=s.toLowerCase(),r={技术:["programming","developer","coding","编程","开发","技术"],新闻:["news","daily","report","新闻","资讯"],购物:["shop","store","buy","price","商城","购物"],教育:["learn","course","education","study","教育","学习"],娱乐:["game","entertainment","movie","music","游戏","电影","音乐"],社交:["social","community","forum","社区","论坛"]};for(const[n,o]of Object.entries(r))if(o.some(c=>t.includes(c)))return n;return null},_=s=>{try{const t=new URL(s).hostname;return t.split(".")[0].charAt(0).toUpperCase()+t.split(".")[0].slice(1)}catch{return s}},G=s=>{try{const t=new URL(s).hostname;return{title:_(s),icon:`https://www.google.com/s2/favicons?domain=${s}`,suggestedCategory:$(t)}}catch{throw new Error("无效的URL格式")}},$=s=>{const t={github:"开发工具",stackoverflow:"开发工具",youtube:"视频",bilibili:"视频",google:"搜索",baidu:"搜索",zhihu:"社交",weibo:"社交",twitter:"社交",facebook:"社交",instagram:"社交",amazon:"购物",taobao:"购物",jd:"购物"};for(const[r,n]of Object.entries(t))if(s.includes(r))return n;return"其他"},U=(s,t)=>{const r=s.toLowerCase().replace(/\/$/,"");return t.some(n=>n.url.toLowerCase().replace(/\/$/,"")===r)};function J({formData:s,setFormData:t,categories:r,onSubmit:n,onCancel:o}){const[c,j]=i.useState(!1),[h,u]=i.useState(!1);i.useEffect(()=>{const a=l=>{c&&!l.target.closest(".category-select-container")&&j(!1)};return document.addEventListener("mousedown",a),()=>document.removeEventListener("mousedown",a)},[c]);const d=async a=>{if(a.preventDefault(),!h){u(!0);try{await n(s)}catch{throw new Error("添加书签失败")}finally{u(!1)}}};return e.jsxs("form",{onSubmit:d,className:"bookmark-form",children:[e.jsx("h3",{children:"书签信息"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:s.name,onChange:a=>t(l=>({...l,name:a.target.value})),placeholder:"书签名称",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:s.category,onChange:a=>t(l=>({...l,category:a.target.value})),onFocus:()=>j(!0),placeholder:"选择或输入新分类",required:!0}),c&&r.length>0&&e.jsx("div",{className:"category-dropdown",children:r.map((a,l)=>e.jsx("div",{className:`category-option ${s.category===a?"selected":""}`,onClick:()=>{t(p=>({...p,category:a})),j(!1)},children:a},l))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-input-container",children:[e.jsx("input",{type:"text",value:s.icon,onChange:a=>t(l=>({...l,icon:a.target.value})),placeholder:"图标URL"}),s.icon&&e.jsx("div",{className:"icon-preview",children:e.jsx("img",{src:s.icon,alt:"网站图标",onError:a=>a.target.src="/fallback-icon.svg"})})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:o,disabled:h,children:"取消"}),e.jsx("button",{type:"submit",className:`submit-button ${h?"loading":""}`,disabled:h,children:h?"添加中...":"添加书签"})]})]})}function K({analyzing:s,analysisStep:t,analysisError:r,urlExists:n}){const o=["开始分析","验证URL格式","获取网站元数据","处理分析结果","分析完成"];return e.jsxs(e.Fragment,{children:[s&&e.jsxs("div",{className:"analysis-status",children:[e.jsx("h3",{children:"正在分析网站..."}),e.jsx("div",{className:"analysis-steps",children:o.map((c,j)=>e.jsxs("div",{className:`analysis-step ${t===c?"active":""} ${o.indexOf(c)<o.indexOf(t)?"complete":""}`,children:[e.jsx("div",{className:"step-indicator",children:j+1}),e.jsx("div",{className:"step-label",children:c})]},j))})]}),n&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:"该URL已存在于您的书签中"}),e.jsx("p",{className:"error-tip",children:"提示：您可以在书签列表中查找此网站。"})]}),r&&!n&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:r}),e.jsx("p",{className:"error-tip",children:"提示：请检查网址是否正确，或稍后再试。"})]})]})}function Q({onClose:s,onSubmit:t}){const{list:r}=E(),[n,o]=i.useState(""),[c,j]=i.useState({url:"",name:"",category:"",icon:""}),[h,u]=i.useState(!1),[d,a]=i.useState(null),[l,p]=i.useState(null),[g,f]=i.useState(!1),[k,m]=i.useState([]),[y,v]=i.useState(!1);i.useEffect(()=>{if(r&&r.length>0){const x=[...new Set(r.map(b=>b.category).filter(Boolean))];m(x)}},[r]);const w=async()=>{if(!(!n||!n.trim())){u(!0),a("开始分析"),p(null),f(!1),v(!1);try{a("验证URL格式");let x=n;!n.startsWith("http://")&&!n.startsWith("https://")&&(x="https://"+n);const b=x.toLowerCase().replace(/\/$/,"");if(U(b,r)){v(!0),p("该URL已存在于您的书签中"),u(!1);return}a("获取网站元数据");const C=await T(x);a("处理分析结果"),j({url:x,name:C.title||"",icon:C.icon||"",category:C.suggestedCategory||""}),a("分析完成"),f(!0)}catch(x){p(`在"${d}"步骤失败: ${x.message}`)}finally{u(!1)}}},S=async x=>{try{const b=x.url.toLowerCase().replace(/\/$/,"");if(U(b,r)){v(!0),p("该URL已存在于您的书签中");return}await t(x),s()}catch(b){console.error("添加书签失败:",b),p("添加书签失败，请重试")}};return e.jsx(B,{isOpen:!0,onClose:s,title:"添加新书签",size:"md",position:"center",children:e.jsxs("div",{className:"bookmark-modal-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"网址"}),e.jsxs("div",{className:"url-input-container",children:[e.jsx("input",{type:"url",value:n,onChange:x=>o(x.target.value),placeholder:"输入网站地址",required:!0}),e.jsx("button",{type:"button",className:`analyze-button ${h?"loading":""}`,onClick:w,disabled:h||!n,children:h?"分析中...":"分析"})]})]}),e.jsx(K,{analyzing:h,analysisStep:d,analysisError:l,urlExists:y}),g&&e.jsx(J,{formData:c,setFormData:j,categories:k,onSubmit:S,onCancel:s})]})})}function V({bookmark:s,onClose:t,onSubmit:r}){const{list:n}=E(),[o,c]=i.useState({name:s.name,category:s.category,icon:s.icon}),[j,h]=i.useState([]),[u,d]=i.useState(!1),[a,l]=i.useState(!1),[p,g]=i.useState(!1),f=i.useRef({name:s.name,category:s.category,icon:s.icon}).current;i.useEffect(()=>{const m=o.name!==f.name||o.category!==f.category||o.icon!==f.icon;g(m)},[o,f]),i.useEffect(()=>{if(n&&n.length>0){const m=[...new Set(n.map(y=>y.category).filter(Boolean))];h(m)}},[n]),i.useEffect(()=>{const m=y=>{u&&!y.target.closest(".category-select-container")&&d(!1)};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[u]);const k=async m=>{if(m.preventDefault(),!(!p||a)){l(!0);try{await r({...s,...o}),t()}catch(y){console.error("保存书签失败:",y)}finally{l(!1)}}};return e.jsx(B,{isOpen:!0,onClose:t,title:"编辑书签",size:"md",position:"center",children:e.jsx("div",{className:"bookmark-modal-content",children:e.jsxs("form",{onSubmit:k,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:o.name,onChange:m=>c({...o,name:m.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-input-container",children:[e.jsx("input",{type:"text",value:o.icon,onChange:m=>c({...o,icon:m.target.value}),placeholder:"输入图标 URL"}),o.icon&&e.jsx("div",{className:"icon-preview",children:e.jsx("img",{src:o.icon,alt:"图标预览",onError:m=>m.target.src="/fallback-icon.svg"})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:o.category,onChange:m=>c({...o,category:m.target.value}),onFocus:()=>d(!0),placeholder:"选择或输入新分类"}),u&&j.length>0&&e.jsx("div",{className:"category-dropdown",children:j.map(m=>e.jsx("div",{className:`category-option ${m===o.category?"selected":""}`,onClick:()=>{c({...o,category:m}),d(!1)},children:m},m))})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:t,disabled:a,children:"取消"}),e.jsx("button",{type:"submit",className:`submit-button ${a?"loading":""}`,disabled:!p||a,children:a?"保存中...":"保存修改"})]})]})})})}function X({message:s,type:t="success",onClose:r,duration:n=3e3}){return i.useEffect(()=>{const o=setTimeout(()=>{r()},n);return()=>clearTimeout(o)},[n,r]),e.jsxs("div",{className:`notification notification-${t}`,children:[e.jsx("span",{className:"notification-icon",children:t==="success"?"✓":"✕"}),e.jsx("span",{className:"notification-message",children:s})]})}function Y({bookmark:s,onEdit:t,onDelete:r,onCopyUrl:n}){const o=s.url?new URL(s.url).hostname.replace("www.",""):"";return e.jsxs("div",{className:"bookmark-card",children:[e.jsxs("div",{className:"bookmark-card-header",children:[e.jsx("div",{className:"bookmark-icon-container",children:s.icon?e.jsx("img",{src:s.icon,alt:s.name,className:"bookmark-icon",onError:c=>c.target.src="/fallback-icon.svg"}):e.jsx("div",{className:"bookmark-icon-placeholder"})}),e.jsxs("div",{className:"bookmark-title-container",children:[e.jsx("h3",{title:s.name,children:s.name}),e.jsxs("div",{className:"bookmark-meta-info",children:[e.jsx("span",{className:"bookmark-domain",children:o}),s.category&&e.jsx("span",{className:"category-tag",children:s.category})]})]})]}),e.jsx("div",{className:"bookmark-card-body",children:e.jsx("div",{className:"bookmark-url-container",children:e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",title:s.url,className:"bookmark-url",children:s.url})})}),e.jsxs("div",{className:"bookmark-card-footer",children:[e.jsx("div",{className:"bookmark-meta",children:e.jsx("span",{className:"bookmark-date",children:s.created_at&&new Date(s.created_at).toLocaleDateString("zh-CN")})}),e.jsxs("div",{className:"bookmark-actions",children:[e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",className:"action-button visit-button",title:"访问网站",children:e.jsx(z,{})}),e.jsx("button",{className:"action-button copy-button",onClick:()=>n(s.url),title:"复制链接",children:e.jsx(q,{})}),e.jsx("button",{className:"action-button edit-button",onClick:()=>t(s),title:"编辑书签",children:e.jsx(D,{})}),e.jsx("button",{className:"action-button delete-button",onClick:()=>r(s),title:"删除书签",children:e.jsx(M,{})})]})]})]})}function Z({bookmarks:s,isLoading:t,onEdit:r,onDelete:n,onCopyUrl:o}){return t?e.jsx("div",{className:"list-section",children:e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载书签..."})]})}):!s||s.length===0?e.jsx("div",{className:"list-section",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"暂无书签"}),e.jsx("p",{className:"empty-tip",children:'点击"添加书签"按钮开始添加'})]})}):e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"书签列表"}),e.jsxs("span",{className:"item-count",children:[s.length," 个书签"]})]}),e.jsx("div",{className:"bookmark-list bookmark-list-wrap",children:s.map(c=>e.jsx(Y,{bookmark:c,onEdit:r,onDelete:n,onCopyUrl:o},c.id))})]})}function ee({onRestore:s,onNotify:t}){const[r,n]=i.useState([]),[o,c]=i.useState(!1),[j,h]=i.useState(new Set),u=async()=>{c(!0);try{const{data:a}=await N.from("bookmark_history").select("restored_from_id").not("restored_from_id","is",null),l=new Set((a==null?void 0:a.map(f=>f.restored_from_id))||[]);h(l);const{data:p,error:g}=await N.from("bookmark_history").select("*").order("created_at",{ascending:!1});if(g)throw g;n(p)}catch(a){console.error("获取历史记录失败:",a),t==null||t({type:"error",message:"获取历史记录失败"})}finally{c(!1)}};i.useEffect(()=>{u()},[]);const d=async a=>{try{const{bookmark_data:l}=a,{error:p}=await N.from("bookmark").insert([l]);if(p)throw p;const{error:g}=await N.from("bookmark_history").insert([{action:"restore",bookmark_id:l.id,bookmark_data:l,restored_from_id:a.id}]);if(g)throw g;t==null||t({type:"success",message:"书签恢复成功"}),s==null||s(),u()}catch(l){console.error("恢复书签失败:",l),t==null||t({type:"error",message:"恢复书签失败"})}};return o?e.jsx("div",{className:"list-section",children:e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载历史记录..."})]})}):!r||r.length===0?e.jsx("div",{className:"list-section",children:e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"暂无历史记录"}),e.jsx("p",{className:"empty-tip",children:"操作书签后将显示在这里"})]})}):e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"操作历史"}),e.jsxs("span",{className:"item-count",children:[r.length," 条记录"]})]}),e.jsx("div",{className:"history-list",children:r.map(a=>e.jsxs("div",{className:"history-item",children:[e.jsxs("div",{className:"history-content",children:[e.jsxs("span",{className:"history-action",children:[a.action==="add"&&"添加了",a.action==="delete"&&"删除了",a.action==="update"&&"修改了",a.action==="restore"&&"恢复了"]}),e.jsx("span",{className:"history-name",children:a.bookmark_data.name}),e.jsx("span",{className:"history-time",children:R(new Date(a.created_at),{addSuffix:!0,locale:P})})]}),a.action==="delete"&&!j.has(a.id)&&e.jsx("button",{className:"restore-button",onClick:()=>d(a),children:"恢复"})]},a.id))})]})}function se(){const[s,t]=i.useState(null);return{notification:s,notify:(o,c)=>{t({type:o,message:c})},clearNotification:()=>{t(null)}}}function te(s,t){const[r,n]=i.useState(!1);return{isProcessing:r,addBookmark:async u=>{n(!0);try{await L.create(u),t("success","成功添加书签"),await s()}catch(d){console.error("添加书签失败:",d),t("error","添加书签失败，请稍后重试")}finally{n(!1)}},updateBookmark:async u=>{n(!0);try{await L.update(u),t("success","成功更新书签"),await s()}catch(d){console.error("更新书签失败:",d),t("error","更新书签失败，请稍后重试")}finally{n(!1)}},deleteBookmark:async u=>{n(!0);try{await L.delete(u),t("success","成功删除书签"),await s()}catch(d){console.error("删除书签失败:",d),t("error","删除书签失败")}finally{n(!1)}},copyUrl:u=>{navigator.clipboard.writeText(u).then(()=>t("success","URL已复制到剪贴板")).catch(()=>t("error","复制失败，请手动复制"))}}}function ae({onAddClick:s,activeTab:t,onTabChange:r}){return e.jsxs("div",{className:"dashboard-header",children:[e.jsx("div",{className:"header-main",children:r&&e.jsx("div",{className:"header-tabs",children:e.jsxs("div",{className:"dashboard-tabs",children:[e.jsxs("button",{className:`tab-button ${t==="bookmarks"?"active":""}`,onClick:()=>r("bookmarks"),title:"书签列表",children:[e.jsx(O,{}),e.jsx("span",{className:"tab-label",children:"书签"})]}),e.jsxs("button",{className:`tab-button ${t==="history"?"active":""}`,onClick:()=>r("history"),title:"历史记录",children:[e.jsx(I,{}),e.jsx("span",{className:"tab-label",children:"历史"})]})]})})}),e.jsx("div",{className:"header-actions",children:t==="bookmarks"&&e.jsxs("button",{className:"add-button",onClick:s,children:[e.jsx("span",{className:"button-icon",children:e.jsx(H,{})}),"添加书签"]})})]})}function de(){const[s,t]=i.useState(!0),{list:r,fetchBookmarks:n}=E(),[o,c]=i.useState("bookmarks"),[j,h]=i.useState(!1),[u,d]=i.useState(null),{notification:a,notify:l,clearNotification:p}=se(),{addBookmark:g,updateBookmark:f,deleteBookmark:k,copyUrl:m}=te(n,l);i.useEffect(()=>{(async()=>{t(!0);try{await n()}catch(b){console.error("加载书签失败:",b),l("error","加载书签失败")}finally{t(!1)}})()},[]);const y=async x=>{await g(x),h(!1)},v=async x=>{await f(x),d(null)},w=async x=>{window.confirm(`确定要删除书签 "${x.name}" 吗？`)&&await k(x)},S=async()=>{await n(),l("success","书签已恢复")};return e.jsxs(e.Fragment,{children:[e.jsx(ae,{onAddClick:()=>h(!0),bookmarkCount:(r==null?void 0:r.length)||0,activeTab:o,onTabChange:c}),e.jsx("div",{className:"dashboard-content",children:o==="bookmarks"?e.jsx(Z,{bookmarks:r,isLoading:s,onEdit:d,onDelete:w,onCopyUrl:m}):e.jsx(ee,{onRestore:S,onNotify:l})}),j&&e.jsx(Q,{onClose:()=>h(!1),onSubmit:y}),u&&e.jsx(V,{bookmark:u,onClose:()=>d(null),onSubmit:v}),a&&e.jsx(X,{type:a.type,message:a.message,onClose:p})]})}export{de as default};
