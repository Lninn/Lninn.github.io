import{s as k,h as L,j as e}from"./index-mXNNK3Tk.js";import{b as c}from"./vendor-BcWs5nYV.js";import{M as f}from"./index-SAo8iik8.js";import{f as D}from"./utils-B751hktW.js";import{z as y}from"./zh-CN-CbY1ib9b.js";const N={async fetchLogs({environment:s,startDate:t,endDate:l,searchTerm:a,limit:o=100}){try{let n=k.from("error_logs").select("*").order("timestamp",{ascending:!1});s&&(n=n.eq("environment",s)),t&&(n=n.gte("timestamp",t)),l&&(n=n.lte("timestamp",l)),a&&(n=n.or(`error.ilike.%${a}%,component_info.ilike.%${a}%`));const{data:r,error:i}=await n.limit(o);if(i)throw i;return r}catch(n){throw new Error(L(n))}},async deleteLogs(s){try{const{error:t}=await k.from("error_logs").delete().lt("timestamp",s);if(t)throw t}catch(t){throw new Error(L(t))}},async exportLogs(s){const t=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...s.map(a=>[new Date(a.timestamp).toLocaleString(),a.environment,a.component_info,`"${a.error.replace(/"/g,'""')}"`,a.url,`"${a.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([t],{type:"text/csv;charset=utf-8;"})}};function C(){const[s,t]=c.useState([]),[l,a]=c.useState(!0),[o,n]=c.useState(null),[r,i]=c.useState({environment:"",startDate:"",endDate:"",searchTerm:""}),x=[...new Set(s.map(h=>h.environment))],m=c.useCallback(async()=>{try{a(!0);const h=await N.fetchLogs(r);t(h),n(null)}catch(h){n(h.message)}finally{a(!1)}},[r]);c.useEffect(()=>{m()},[m]);const u=c.useCallback((h,v)=>{i(g=>({...g,[h]:v}))},[]);return{logs:s,isLoading:l,error:o,setError:n,filters:r,environments:x,updateFilter:u,fetchLogs:m}}function S({filters:s,environments:t,onFilterChange:l}){const[a,o]=c.useState(!1),n=[{value:"",label:"所有环境"},...t.map(r=>({value:r,label:r}))];return e.jsxs("div",{className:"filters-container",children:[e.jsxs("div",{className:"filters-header",children:[e.jsx("h3",{className:"filters-title",children:"筛选条件"}),e.jsxs("button",{className:"filters-toggle",onClick:()=>o(!a),"aria-expanded":a,children:[a?"收起":"展开",e.jsx("span",{className:`toggle-icon ${a?"expanded":""}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})})})]})]}),e.jsxs("div",{className:`filters-wrapper ${a?"expanded":""}`,children:[e.jsxs("div",{className:"filter-item filter-item-search",children:[e.jsx("label",{className:"filter-label",children:"全局搜索"}),e.jsxs("div",{className:"search-input-wrapper",children:[e.jsx("input",{type:"text",value:s.searchTerm,onChange:r=>l("searchTerm",r.target.value),placeholder:"搜索错误信息、组件或URL...",className:"filter-input search-input"}),s.searchTerm&&e.jsx("button",{className:"search-clear-btn",onClick:()=>l("searchTerm",""),"aria-label":"清除搜索",children:"×"})]})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"运行环境"}),e.jsx("select",{value:s.environment,onChange:r=>l("environment",r.target.value),className:"filter-input",children:n.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"起始日期"}),e.jsx("input",{type:"date",value:s.startDate,onChange:r=>l("startDate",r.target.value),className:"filter-input"})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"截止日期"}),e.jsx("input",{type:"date",value:s.endDate,onChange:r=>l("endDate",r.target.value),className:"filter-input"})]})]}),(s.environment||s.startDate||s.endDate||s.searchTerm)&&e.jsxs("div",{className:"active-filters",children:[e.jsx("span",{className:"active-filters-label",children:"已应用筛选:"}),e.jsxs("div",{className:"filter-tags",children:[s.environment&&e.jsxs("span",{className:"filter-tag",children:["环境: ",s.environment,e.jsx("button",{className:"tag-remove",onClick:()=>l("environment",""),"aria-label":"移除环境筛选",children:"×"})]}),s.startDate&&e.jsxs("span",{className:"filter-tag",children:["开始: ",s.startDate,e.jsx("button",{className:"tag-remove",onClick:()=>l("startDate",""),"aria-label":"移除开始日期筛选",children:"×"})]}),s.endDate&&e.jsxs("span",{className:"filter-tag",children:["结束: ",s.endDate,e.jsx("button",{className:"tag-remove",onClick:()=>l("endDate",""),"aria-label":"移除结束日期筛选",children:"×"})]}),s.searchTerm&&e.jsxs("span",{className:"filter-tag",children:["搜索: ",s.searchTerm,e.jsx("button",{className:"tag-remove",onClick:()=>l("searchTerm",""),"aria-label":"移除搜索筛选",children:"×"})]}),e.jsx("button",{className:"clear-all-btn",onClick:()=>{l("environment",""),l("startDate",""),l("endDate",""),l("searchTerm","")},children:"清除全部"})]})]})]})}function E({log:s}){const[t,l]=c.useState(!1),a=(r,i=120)=>r?r.length>i?`${r.substring(0,i)}...`:r:"",o=D(new Date(s.timestamp),{addSuffix:!0,locale:y}),n=e.jsx("button",{onClick:()=>l(!1),children:"关闭"});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"log-item",children:[e.jsxs("div",{className:"log-item-header",children:[e.jsx("div",{className:"log-item-time",children:o}),e.jsx("div",{className:"log-item-env",children:s.environment})]}),e.jsxs("div",{className:"log-item-content",children:[e.jsx("div",{className:"log-item-component",children:s.component_info}),e.jsx("div",{className:"log-item-message",children:s.error}),e.jsx("div",{className:"log-item-url",children:e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",title:s.url,children:a(s.url,50)})})]}),e.jsx("div",{className:"log-item-actions",children:e.jsxs("button",{className:"log-item-details-btn",onClick:()=>l(!0),children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]}),"查看详情"]})})]}),e.jsx(f,{isOpen:t,onClose:()=>l(!1),title:"错误日志详情",size:"md",footer:n,children:e.jsxs("div",{className:"log-details",children:[e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"基本信息"}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"时间："}),e.jsx("span",{className:"log-details-value",children:new Date(s.timestamp).toLocaleString()})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"环境："}),e.jsx("span",{className:"log-details-value",children:s.environment})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"组件："}),e.jsx("span",{className:"log-details-value",children:s.component_info})]})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"错误信息"}),e.jsx("div",{className:"log-details-error",children:s.error})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"URL"}),e.jsx("div",{className:"log-details-url",children:e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",children:s.url})})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"用户代理"}),e.jsx("div",{className:"log-details-user-agent",children:s.user_agent})]})]})})]})}function _({isOpen:s,onClose:t,onConfirm:l,deleteDate:a,onDateChange:o}){const n=e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-button",onClick:t,children:"取消"}),e.jsx("button",{className:"confirm-button danger",onClick:l,children:"确认删除"})]});return e.jsx(f,{isOpen:s,onClose:t,title:"删除历史错误日志",size:"sm",footer:n,children:e.jsxs("div",{className:"delete-modal-content",children:[e.jsx("p",{children:"确定要删除多久以前的错误日志？"}),e.jsx("div",{className:"delete-date-selector",children:e.jsxs("select",{value:a,onChange:r=>o(Number(r.target.value)),children:[e.jsx("option",{value:7,children:"7天前"}),e.jsx("option",{value:30,children:"30天前"}),e.jsx("option",{value:90,children:"90天前"}),e.jsx("option",{value:180,children:"180天前"}),e.jsx("option",{value:365,children:"一年前"})]})}),e.jsx("p",{className:"delete-warning",children:"注意：此操作不可恢复，将永久删除所选时间之前的所有错误日志记录。"})]})})}function T({logs:s}){const[t,l]=c.useState(null),[a,o]=c.useState(window.innerWidth<=768);c.useEffect(()=>{const i=()=>{o(window.innerWidth<=768)};return window.addEventListener("resize",i),()=>window.removeEventListener("resize",i)},[]);const n=i=>{l(i)},r=e.jsx("button",{onClick:()=>l(null),children:"关闭"});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"log-table-wrapper",children:e.jsxs("table",{className:"log-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"时间"}),e.jsx("th",{children:"环境"}),!a&&e.jsx("th",{children:"组件"}),e.jsx("th",{className:a?"mobile-error-header":"",children:"错误信息"}),!a&&e.jsx("th",{children:"URL"})]})}),e.jsx("tbody",{children:s.map(i=>e.jsxs("tr",{onClick:()=>n(i),children:[e.jsx("td",{children:e.jsx("span",{title:new Date(i.timestamp).toLocaleString(),children:D(new Date(i.timestamp),{addSuffix:!0,locale:y})})}),e.jsx("td",{children:e.jsx("span",{className:"env-badge",children:i.environment})}),!a&&e.jsx("td",{children:i.component_info}),e.jsx("td",{className:`error-cell ${a?"mobile-error-cell":""}`,children:i.error}),!a&&e.jsx("td",{className:"url-cell",children:e.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",onClick:x=>x.stopPropagation(),children:i.url})})]},i.id))})]})}),e.jsx(f,{isOpen:!!t,onClose:()=>l(null),title:"错误日志详情",size:"md",footer:r,children:t&&e.jsxs("div",{className:"log-details",children:[e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"基本信息"}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"时间："}),e.jsx("span",{className:"log-details-value",children:new Date(t.timestamp).toLocaleString()})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"环境："}),e.jsx("span",{className:"log-details-value",children:t.environment})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"组件："}),e.jsx("span",{className:"log-details-value",children:t.component_info})]})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"错误信息"}),e.jsx("div",{className:"log-details-error",children:t.error})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"URL"}),e.jsx("div",{className:"log-details-url",children:e.jsx("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",children:t.url})})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"用户代理"}),e.jsx("div",{className:"log-details-user-agent",children:t.user_agent})]})]})})]})}function z(){const{logs:s,isLoading:t,error:l,filters:a,environments:o,updateFilter:n,fetchLogs:r,setError:i}=C(),[x,m]=c.useState(!1),[u,h]=c.useState(30),v=async()=>{const d=await N.exportLogs(s),b=window.URL.createObjectURL(d),j=document.createElement("a");j.href=b,j.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(j),j.click(),window.URL.revokeObjectURL(b),document.body.removeChild(j)},g=async()=>{try{const d=new Date;d.setDate(d.getDate()-u),await N.deleteLogs(d.toISOString()),m(!1),r()}catch(d){console.error("Error deleting logs:",d),i(d.message||"删除日志失败"),m(!1)}},[p,w]=c.useState("card");return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"error-logs",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("div",{className:"section-header-main",children:[e.jsx("h2",{children:"错误日志"}),e.jsxs("div",{className:"view-toggle",children:[e.jsx("button",{className:`view-toggle-btn ${p==="card"?"active":""}`,onClick:()=>w("card"),title:"卡片视图",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"})]})}),e.jsx("button",{className:`view-toggle-btn ${p==="table"?"active":""}`,onClick:()=>w("table"),title:"表格视图",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})})]})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("span",{className:"log-count",children:t?"加载中...":`${s.length} 条记录`}),e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{onClick:v,children:"导出日志"}),e.jsx("button",{className:"danger-outline",onClick:()=>m(!0),children:"删除历史日志"})]})]})]}),e.jsx(S,{filters:a,environments:o,onFilterChange:n}),l&&e.jsx("div",{className:"error-message",children:l}),t?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载错误日志..."})]}):e.jsx(e.Fragment,{children:p==="card"?e.jsx("div",{className:"logs-list",children:s.length>0?s.map(d=>e.jsx(E,{log:d},d.id)):e.jsx("div",{className:"no-logs",children:e.jsx("p",{children:"没有找到符合条件的错误日志"})})}):e.jsx(T,{logs:s})}),e.jsx(_,{isOpen:x,onClose:()=>m(!1),onConfirm:g,deleteDate:u,onDateChange:h})]})})}export{z as default};
