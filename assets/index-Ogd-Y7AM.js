import{s as f,h as v,j as t}from"./index-DjlBvSh0.js";import{b as o}from"./vendor-C_ovgAfI.js";import{f as E}from"./utils-CWHH1IbV.js";import{z as D}from"./zh-CN-CCt-M6vz.js";const g={async fetchLogs({environment:a,startDate:n,endDate:i,searchTerm:r,limit:d=100}){try{let s=f.from("error_logs").select("*").order("timestamp",{ascending:!1});a&&(s=s.eq("environment",a)),n&&(s=s.gte("timestamp",n)),i&&(s=s.lte("timestamp",i)),r&&(s=s.or(`error.ilike.%${r}%,component_info.ilike.%${r}%`));const{data:c,error:m}=await s.limit(d);if(m)throw m;return c}catch(s){throw new Error(v(s))}},async deleteLogs(a){try{const{error:n}=await f.from("error_logs").delete().lt("timestamp",a);if(n)throw n}catch(n){throw new Error(v(n))}},async exportLogs(a){const n=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...a.map(r=>[new Date(r.timestamp).toLocaleString(),r.environment,r.component_info,`"${r.error.replace(/"/g,'""')}"`,r.url,`"${r.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([n],{type:"text/csv;charset=utf-8;"})}};function $(){const[a,n]=o.useState([]),[i,r]=o.useState(!0),[d,s]=o.useState(null),[c,m]=o.useState(""),[h,w]=o.useState(""),[p,N]=o.useState(""),[u,y]=o.useState(""),L=[...new Set(a.map(e=>e.environment))],x=async()=>{try{r(!0);const e=await g.fetchLogs({environment:c,startDate:h,endDate:p,searchTerm:u});n(e),s(null)}catch(e){s(e.message)}finally{r(!1)}};o.useEffect(()=>{x()},[c,h,p,u]);const S=async()=>{const e=await g.exportLogs(a),j=window.URL.createObjectURL(e),l=document.createElement("a");l.href=j,l.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(j),document.body.removeChild(l)},b=async()=>{if(window.confirm("确定要删除30天前的错误记录吗？"))try{const e=new Date;e.setDate(e.getDate()-30),await g.deleteLogs(e.toISOString()),x()}catch(e){s(e.message)}};return t.jsxs("div",{className:"error-logs",children:[t.jsxs("div",{className:"section-header",children:[t.jsx("h2",{children:"错误日志"}),t.jsxs("div",{className:"header-actions",children:[t.jsx("span",{className:"log-count",children:i?"加载中...":`${a.length} 条记录`}),t.jsx("button",{onClick:S,children:"导出日志"}),t.jsx("button",{onClick:b,children:"清理旧记录"})]})]}),t.jsxs("div",{className:"filters",children:[t.jsxs("select",{value:c,onChange:e=>m(e.target.value),children:[t.jsx("option",{value:"",children:"所有环境"}),L.map(e=>t.jsx("option",{value:e,children:e},e))]}),t.jsx("input",{type:"date",value:h,onChange:e=>w(e.target.value),placeholder:"开始日期"}),t.jsx("input",{type:"date",value:p,onChange:e=>N(e.target.value),placeholder:"结束日期"}),t.jsx("input",{type:"text",value:u,onChange:e=>y(e.target.value),placeholder:"搜索错误信息..."})]}),d&&t.jsx("div",{className:"error-message",children:d}),i?t.jsxs("div",{className:"loading-state",children:[t.jsx("div",{className:"loading-spinner"}),t.jsx("p",{children:"正在加载错误日志..."})]}):t.jsx("div",{className:"logs-list",children:a.map(e=>t.jsxs("div",{className:"log-item",children:[t.jsxs("div",{className:"log-header",children:[t.jsx("span",{className:"log-time",children:E(new Date(e.timestamp),{addSuffix:!0,locale:D})}),t.jsx("span",{className:"log-environment",children:e.environment})]}),t.jsxs("div",{className:"log-content",children:[t.jsx("div",{className:"log-component",children:e.component_info}),t.jsx("div",{className:"log-message",children:e.error}),t.jsx("div",{className:"log-url",children:e.url})]}),t.jsx("div",{className:"log-footer",children:t.jsx("span",{className:"log-user-agent",children:e.user_agent})})]},e.id))})]})}export{$ as default};
