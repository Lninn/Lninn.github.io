import{j as a,s as w}from"./index-BtK_pdOW.js";import{M as V}from"./index-Ck48Jn3l.js";import{b as y}from"./vendor-D6FSTBK7.js";import{u as ht,N as dt}from"./useNotification-Cvhw_tEf.js";import{S as yt}from"./index-BrCmvIcs.js";import{P as bt}from"./index-BrZQCppZ.js";import xt from"./MapContainer-BCqb-1d6.js";import"./utils-B-ph8sPT.js";function b(t,e){return Array.from(t.getElementsByTagName(e))}function R(t){return t[0]==="#"?t:`#${t}`}function Nt(t,e,n){return Array.from(t.getElementsByTagNameNS(n,e))}function g(t){return t==null||t.normalize(),(t==null?void 0:t.textContent)||""}function m(t,e,n){const r=t.getElementsByTagName(e);return r.length?r[0]:null}function x(t,e,n){const r={};if(!t)return r;const o=t.getElementsByTagName(e),i=o.length?o[0]:null;return i&&n?n(i,r):r}function A(t,e,n){const r=g(m(t,e));return r&&n?n(r)||{}:{}}function p(t,e,n){const r=Number.parseFloat(g(m(t,e)));if(!Number.isNaN(r))return n&&n(r),r}function G(t,e){const n={};for(const r of e)A(t,r,o=>{n[r]=o});return n}function Y(t){return(t==null?void 0:t.nodeType)===1}function Z(t,e){const n={},r=e==="stroke"||e==="fill"?e:`${e}-color`;return t[0]==="#"&&(t=t.substring(1)),t.length===6||t.length===3?n[r]=`#${t}`:t.length===8&&(n[`${e}-opacity`]=Number.parseInt(t.substring(0,2),16)/255,n[r]=`#${t.substring(6,8)}${t.substring(4,6)}${t.substring(2,4)}`),n}function F(t,e,n){const r={};return p(t,e,o=>{r[n]=o}),r}function z(t,e){return x(t,"color",n=>Z(g(n),e))}function Q(t){return x(t,"Icon",(e,n)=>(A(e,"href",r=>{n.icon=r}),n))}function Lt(t){return x(t,"IconStyle",e=>Object.assign(z(e,"icon"),F(e,"scale","icon-scale"),F(e,"heading","icon-heading"),x(e,"hotSpot",n=>{const r=Number.parseFloat(n.getAttribute("x")||""),o=Number.parseFloat(n.getAttribute("y")||""),i=n.getAttribute("xunits")||"",s=n.getAttribute("yunits")||"";return!Number.isNaN(r)&&!Number.isNaN(o)?{"icon-offset":[r,o],"icon-offset-units":[i,s]}:{}}),Q(e)))}function Ot(t){return x(t,"LabelStyle",e=>Object.assign(z(e,"label"),F(e,"scale","label-scale")))}function Tt(t){return x(t,"LineStyle",e=>Object.assign(z(e,"stroke"),F(e,"width","stroke-width")))}function vt(t){return x(t,"PolyStyle",(e,n)=>Object.assign(n,x(e,"color",r=>Z(g(r),"fill")),A(e,"fill",r=>{if(r==="0")return{"fill-opacity":0}}),A(e,"outline",r=>{if(r==="0")return{"stroke-opacity":0}})))}function D(t){return Object.assign({},vt(t),Tt(t),Ot(t),Lt(t))}const Pt=/\s*/g,jt=/^\s*|\s*$/g,At=/\s+/;function tt(t){return t.replace(Pt,"").split(",").map(Number.parseFloat).filter(e=>!Number.isNaN(e)).slice(0,3)}function U(t){return t.replace(jt,"").split(At).map(tt).filter(e=>e.length>=2)}function St(t){let e=b(t,"coord");e.length===0&&(e=Nt(t,"coord","*"));const n=e.map(r=>g(r).split(" ").map(Number.parseFloat));return n.length===0?null:{geometry:n.length>2?{type:"LineString",coordinates:n}:{type:"Point",coordinates:n[0]},times:b(t,"when").map(r=>g(r))}}function et(t){if(t.length===0)return t;const e=t[0],n=t[t.length-1];let r=!0;for(let o=0;o<Math.max(e.length,n.length);o++)if(e[o]!==n[o]){r=!1;break}return r?t:t.concat([t[0]])}function _(t){return g(m(t,"coordinates"))}function nt(t){let e=[],n=[];for(let r=0;r<t.childNodes.length;r++){const o=t.childNodes.item(r);if(Y(o))switch(o.tagName){case"MultiGeometry":case"MultiTrack":case"gx:MultiTrack":{const i=nt(o);e=e.concat(i.geometries),n=n.concat(i.coordTimes);break}case"Point":{const i=tt(_(o));i.length>=2&&e.push({type:"Point",coordinates:i});break}case"LinearRing":case"LineString":{const i=U(_(o));i.length>=2&&e.push({type:"LineString",coordinates:i});break}case"Polygon":{const i=[];for(const s of b(o,"LinearRing")){const c=et(U(_(s)));c.length>=4&&i.push(c)}i.length&&e.push({type:"Polygon",coordinates:i});break}case"Track":case"gx:Track":{const i=St(o);if(!i)break;const{times:s,geometry:c}=i;e.push(c),s.length&&n.push(s);break}}}return{geometries:e,coordTimes:n}}const j=t=>Number(t),$={string:t=>t,int:j,uint:j,short:j,ushort:j,float:j,double:j,bool:t=>!!t};function q(t,e){return x(t,"ExtendedData",(n,r)=>{for(const o of b(n,"Data"))r[o.getAttribute("name")||""]=g(m(o,"value"));for(const o of b(n,"SimpleData")){const i=o.getAttribute("name")||"",s=e[i]||$.string;r[i]=s(g(o))}return r})}function H(t){const e=m(t,"description");for(const n of Array.from((e==null?void 0:e.childNodes)||[]))if(n.nodeType===4)return{description:{"@type":"html",value:g(n)}};return{}}function W(t){return x(t,"TimeSpan",e=>({timespan:{begin:g(m(e,"begin")),end:g(m(e,"end"))}}))}function K(t){return x(t,"TimeStamp",e=>({timestamp:g(m(e,"when"))}))}function J(t,e){return A(t,"styleUrl",n=>(n=R(n),e[n]?Object.assign({styleUrl:n},e[n]):{styleUrl:n}))}var d;(function(t){t.ABSOLUTE="absolute",t.RELATIVE_TO_GROUND="relativeToGround",t.CLAMP_TO_GROUND="clampToGround",t.CLAMP_TO_SEAFLOOR="clampToSeaFloor",t.RELATIVE_TO_SEAFLOOR="relativeToSeaFloor"})(d||(d={}));function kt(t){switch(t==null?void 0:t.textContent){case d.ABSOLUTE:return d.ABSOLUTE;case d.CLAMP_TO_GROUND:return d.CLAMP_TO_GROUND;case d.CLAMP_TO_SEAFLOOR:return d.CLAMP_TO_SEAFLOOR;case d.RELATIVE_TO_GROUND:return d.RELATIVE_TO_GROUND;case d.RELATIVE_TO_SEAFLOOR:return d.RELATIVE_TO_SEAFLOOR}return null}function wt(t){return m(t,"gx:LatLonQuad")?{geometry:{type:"Polygon",coordinates:[et(U(_(t)))]}}:Mt(t)}const Et=Math.PI/180;function Ct(t,e,n){const r=[(t[0]+t[2])/2,(t[1]+t[3])/2];return[e[0].map(o=>{const i=o[1]-r[1],s=o[0]-r[0],c=Math.sqrt(i**2+s**2),l=Math.atan2(i,s)+n*Et;return[r[0]+Math.cos(l)*c,r[1]+Math.sin(l)*c]})]}function Mt(t){const e=m(t,"LatLonBox");if(e){const n=p(e,"north"),r=p(e,"west"),o=p(e,"east"),i=p(e,"south"),s=p(e,"rotation");if(typeof n=="number"&&typeof i=="number"&&typeof r=="number"&&typeof o=="number"){const c=[r,i,o,n];let l=[[[r,n],[o,n],[o,i],[r,i],[r,n]]];return typeof s=="number"&&(l=Ct(c,l,s)),{bbox:c,geometry:{type:"Polygon",coordinates:l}}}}return null}function _t(t,e,n,r){var l;const o=wt(t),i=(o==null?void 0:o.geometry)||null;if(!i&&r.skipNullGeometry)return null;const s={type:"Feature",geometry:i,properties:Object.assign({"@geometry-type":"groundoverlay"},G(t,["name","address","visibility","open","phoneNumber","description"]),H(t),J(t,e),D(t),Q(t),q(t,n),W(t),K(t))};o!=null&&o.bbox&&(s.bbox=o.bbox),((l=s.properties)==null?void 0:l.visibility)!==void 0&&(s.properties.visibility=s.properties.visibility!=="0");const c=t.getAttribute("id");return c!==null&&c!==""&&(s.id=c),s}function Rt(t){const e=m(t,"Region");return e?{coordinateBox:Gt(e),lod:Ft(t)}:null}function Ft(t){const e=m(t,"Lod");return e?[p(e,"minLodPixels")??-1,p(e,"maxLodPixels")??-1,p(e,"minFadeExtent")??null,p(e,"maxFadeExtent")??null]:null}function Gt(t){const e=m(t,"LatLonAltBox");if(e){const n=p(e,"north"),r=p(e,"west"),o=p(e,"east"),i=p(e,"south");if(kt(m(e,"altitudeMode")||m(e,"gx:altitudeMode"))&&console.debug("Encountered an unsupported feature of KML for togeojson: please contact developers for support of altitude mode."),typeof n=="number"&&typeof i=="number"&&typeof r=="number"&&typeof o=="number")return{bbox:[r,i,o,n],geometry:{type:"Polygon",coordinates:[[[r,n],[o,n],[o,i],[r,i],[r,n]]]}}}return null}function Dt(t){const e=m(t,"Link");return e?G(e,["href","refreshMode","refreshInterval","viewRefreshMode","viewRefreshTime","viewBoundScale","viewFormat","httpQuery"]):{}}function Bt(t,e,n,r){var l,N,T;const o=Rt(t),i=((l=o==null?void 0:o.coordinateBox)==null?void 0:l.geometry)||null;if(!i&&r.skipNullGeometry)return null;const s={type:"Feature",geometry:i,properties:Object.assign({"@geometry-type":"networklink"},G(t,["name","address","visibility","open","phoneNumber","styleUrl","refreshVisibility","flyToView","description"]),H(t),J(t,e),D(t),Q(t),q(t,n),W(t),K(t),Dt(t),o!=null&&o.lod?{lod:o.lod}:{})};(N=o==null?void 0:o.coordinateBox)!=null&&N.bbox&&(s.bbox=o.coordinateBox.bbox),((T=s.properties)==null?void 0:T.visibility)!==void 0&&(s.properties.visibility=s.properties.visibility!=="0");const c=t.getAttribute("id");return c!==null&&c!==""&&(s.id=c),s}function It(t){return t.length===0?null:t.length===1?t[0]:{type:"GeometryCollection",geometries:t}}function Ut(t,e,n,r){var N;const{coordTimes:o,geometries:i}=nt(t),s=It(i);if(!s&&r.skipNullGeometry)return null;const c={type:"Feature",geometry:s,properties:Object.assign(G(t,["name","address","visibility","open","phoneNumber","description"]),H(t),J(t,e),D(t),q(t,n),W(t),K(t),o.length?{coordinateProperties:{times:o.length===1?o[0]:o}}:{})};((N=c.properties)==null?void 0:N.visibility)!==void 0&&(c.properties.visibility=c.properties.visibility!=="0");const l=t.getAttribute("id");return l!==null&&l!==""&&(c.id=l),c}function $t(t){let e=t.getAttribute("id");const n=t.parentNode;return!e&&Y(n)&&n.localName==="CascadingStyle"&&(e=n.getAttribute("kml:id")||n.getAttribute("id")),R(e||"")}function Vt(t){const e={};for(const n of b(t,"Style"))e[$t(n)]=D(n);for(const n of b(t,"StyleMap")){const r=R(n.getAttribute("id")||"");A(n,"styleUrl",o=>{o=R(o),e[o]&&(e[r]=e[o])})}return e}function zt(t){const e={};for(const n of b(t,"SimpleField"))e[n.getAttribute("name")||""]=$[n.getAttribute("type")||""]||$.string;return e}function*Qt(t,e={skipNullGeometry:!1}){const n=t,r=Vt(n),o=zt(n);for(const i of b(n,"Placemark")){const s=Ut(i,r,o,e);s&&(yield s)}for(const i of b(n,"GroundOverlay")){const s=_t(i,r,o,e);s&&(yield s)}for(const i of b(n,"NetworkLink")){const s=Bt(i,r,o,e);s&&(yield s)}}function qt(t,e={skipNullGeometry:!1}){return{type:"FeatureCollection",features:Array.from(Qt(t,e))}}function ae(){const[t,e]=y.useState(!1),[n,r]=y.useState(!1),[o,i]=y.useState(!1),s=y.useRef(null),{notification:c,notify:l,clearNotification:N}=ht(),{userPathList:T,refresh:E}=Kt(),[C,M]=y.useState(0);function B(){e(!0)}function f(){r(!0)}function rt(){i(!0)}function ot(){l("success","添加成功"),s.current=null,M(0),e(!1),E()}function it(u){l("success","删除 "+u.name+" 成功"),E()}async function st(u){const L=u.name,v=await ut(u),h=lt(v),P=ct(h),X=(await at(P)).map(k=>k.toArray()).join("|"),I=P.map(k=>k.join(",")).join("|"),S={name:L,originalPath:I,gpsPath:X};try{await Wt(S),ot()}catch{l("error","添加路径接口失败")}}async function at(u,L="gps",v=400){let h=0;const P=[];for(let O=0;O<u.length;O+=v){const I=u.slice(O,O+v).map(S=>S.join(",")).join("|");await new Promise(S=>{window.AMap.convertFrom(I,L,(k,pt)=>{if(k==="complete"){P.push(...pt.locations),S();const gt=(Math.min(O+v,u.length)/u.length*100).toFixed(2);M(gt)}})}),h%2===0?(await Ht(1),h=0):h++}return P}function ct(u){return u.features[2].geometry.coordinates.map(O=>[O[0],O[1]])}function lt(u){return qt(new DOMParser().parseFromString(u,"text/xml"))}function ut(u){return new Promise((L,v)=>{const h=new FileReader;h.readAsText(u),h.onerror=()=>{v(h.error)},h.onload=()=>{const P=h.result;L(P)}})}function ft(u){const L=u.target.files;L.length<=0||(s.current=L[0])}function mt(){const u=s.current;u?st(u):l("error","没有选择文件")}return a.jsxs("div",{children:[a.jsx("button",{className:"btn btn-primary",onClick:B,children:"导入轨迹"}),a.jsx("button",{className:"btn btn-primary",onClick:f,children:"路径管理"}),a.jsx("button",{className:"btn btn-primary",onClick:rt,children:"行程管理"}),a.jsx(xt,{userPathList:T}),a.jsx(Xt,{open:o,onClose:()=>{i(!1)},onAdd:()=>{console.log("添加行程成功")},userPathList:T}),a.jsx(Jt,{open:n,onClose:()=>r(!1),userPathList:T,onDelete:u=>{it(u)}}),a.jsx(V,{isOpen:t,onClose:()=>e(!1),title:"导入轨迹",size:"md",position:"center",children:a.jsxs("form",{children:[a.jsxs("div",{className:"form-item",children:[a.jsx("label",{children:"坐标解析进度"}),a.jsx(bt,{percent:C})]}),a.jsx("div",{className:"form-item",children:a.jsx("input",{type:"file",onChange:ft})}),a.jsx("div",{className:"form-item",children:a.jsx("button",{className:"btn btn-primary",onClick:mt,children:"同步"})})]})}),c&&a.jsx(dt,{type:c.type,message:c.message,onClose:N})]})}function Ht(t){return new Promise(e=>setTimeout(e,t*1e3))}async function Wt({name:t,originalPath:e,gpsPath:n}){const{error:r}=await w.from("user_paths").insert([{name:t,original_path:e,gps_path:n}]).select();if(r)throw r}function Kt(){const[t,e]=y.useState([]);async function n(){let{data:r}=await w.from("user_paths").select("*");e(r)}return y.useEffect(()=>{async function r(){await n()}r()},[]),{userPathList:t,refresh:n}}function Jt({open:t,onClose:e,userPathList:n,onDelete:r}){async function o(i){const{error:s}=await w.from("user_paths").delete().eq("name",i.name);s||r(i)}return a.jsx(V,{isOpen:t,onClose:e,title:"导入轨迹",size:"md",position:"center",children:n.map(i=>a.jsx("div",{children:a.jsxs("div",{children:[i.name," ",a.jsx("button",{onClick:()=>o(i),children:"删除"})]})},i.name))})}function Xt({open:t,onClose:e,onAdd:n,userPathList:r}){const[o,i]=y.useState(""),[s,c]=y.useState([]),[l,N]=y.useState(null),T=r.map(f=>({label:f.name,value:f.id}));async function E(){let{data:f}=await w.from("traveling_paths").select("*");return f}async function C(){const f=await E();c(f)}y.useEffect(()=>{C()},[]);async function M(){if(!o){alert("请输入标题");return}const{error:f}=await w.from("traveling_paths").insert([{title:o,legs:[]}]).select();f||(await C(),i(""),n())}async function B(f){console.log(f)}return a.jsx(V,{isOpen:t,onClose:e,title:"行程管理",size:"md",position:"center",children:a.jsxs("div",{style:{height:600},children:[a.jsxs("div",{className:"create-traveling-form",children:[a.jsxs("div",{className:"form-item",children:[a.jsx("label",{children:"行程名称"}),a.jsx("input",{style:{width:200},type:"text",value:o,onChange:f=>i(f.target.value)})]}),a.jsx("div",{className:"form-item",children:a.jsx("button",{className:"btn btn-primary",onClick:M,children:"添加行程"})})]}),a.jsx("ul",{children:s.map(f=>a.jsxs("li",{className:"traveling-path-item",children:[a.jsx("div",{children:f.title}),a.jsx("div",{onClick:()=>B(f),children:"增加"}),a.jsx(yt,{value:l,onChange:N,options:T,placeholder:"选择对应的里程",style:{width:"200px"}})]},f.title))})]})})}export{ae as default};
