(function(){"use strict";self.onmessage=function(s){const{xmlContent:a}=s.data;try{const e=(n,r)=>{self.postMessage({type:"progress",data:{progress:n,message:r}})};e(10,"正在解析 XML 数据...");const i=f(a,e);e(60,"正在按天合并数据...");const t=d(i);e(90,"正在生成可视化数据...");const o=g(t);self.postMessage({type:"result",data:o})}catch(e){self.postMessage({type:"error",data:{message:e.message}})}};function f(s,a){const e=[];let i=0,t=0,o=s.split("<Record ").length-1;for(;;){const n=s.indexOf("<Record ",i);if(n===-1)break;const r=s.indexOf("/>",n);if(r===-1)break;const l=s.substring(n,r+2),v=c(l,"type"),p=c(l,"startDate"),u=c(l,"value"),y=c(l,"unit");if(p&&u&&e.push({type:v,date:new Date(p),value:parseFloat(u),unit:y}),i=r+2,t++,t%5e3===0){const h=Math.min(30+Math.floor(t/o*30),60);a(h,`正在处理记录 ${t} / ${o}...`)}}return e}function c(s,a){const e=new RegExp(`${a}="([^"]*)"`,"i"),i=s.match(e);return i?i[1]:null}function d(s){const a={};return s.forEach((e,i)=>{i%1e4===0&&self.postMessage({type:"progress",data:{progress:60+Math.floor(i/s.length*20),message:`正在合并数据 ${i} / ${s.length}...`}});const t=e.date.toISOString().split("T")[0];a[t]||(a[t]={date:t,activities:{},totalActivities:0}),a[t].activities[e.type]||(a[t].activities[e.type]=0),a[t].activities[e.type]++,a[t].totalActivities++}),a}function g(s){const a=Object.keys(s).sort(),e=new Set;return a.forEach(t=>{Object.keys(s[t].activities).forEach(o=>{e.add(o)})}),{data:a.map(t=>({date:t,count:s[t].totalActivities,details:s[t].activities})),activityTypes:Array.from(e)}}})();
