import{s as b,j as e}from"./index-DL1DATF7.js";import{b as d}from"./vendor-C_ovgAfI.js";import{c as R,f as q}from"./utils-CWHH1IbV.js";import{M as A}from"./index-C3MoeUeF.js";import{z}from"./zh-CN-CCt-M6vz.js";const U=R(s=>({list:[],fetchBookmarks:async()=>{const{data:t,error:r}=await b.from("bookmark").select("*").order("create_at",{ascending:!1});if(r){console.error("Failed to fetch bookmark data:",r);return}s({list:t})}})),M=async s=>{var t,r,a,i;try{const u="https://api.allorigins.win/get?url="+encodeURIComponent(s),p=await(await fetch(u)).json();if(!p.contents)throw new Error("无法获取网站内容");const h=new DOMParser().parseFromString(p.contents,"text/html");let o=((t=h.querySelector("title"))==null?void 0:t.textContent)||"";o||(o=((r=h.querySelector('meta[property="og:title"]'))==null?void 0:r.getAttribute("content"))||"");let c="";const x=h.querySelector('link[rel="icon"]')||h.querySelector('link[rel="shortcut icon"]');x&&(c=new URL(x.getAttribute("href"),s).href),c||(c=`https://www.google.com/s2/favicons?domain=${s}`);let j=((a=h.querySelector('meta[name="keywords"]'))==null?void 0:a.getAttribute("content"))||"",f=((i=h.querySelector('meta[name="description"]'))==null?void 0:i.getAttribute("content"))||"",w=B(j+" "+f)||$(new URL(s).hostname);return{title:o||_(s),icon:c,suggestedCategory:w}}catch(u){return console.error("获取网站信息失败:",u),D(s)}},B=(s="")=>{const t=s.toLowerCase(),r={技术:["programming","developer","coding","编程","开发","技术"],新闻:["news","daily","report","新闻","资讯"],购物:["shop","store","buy","price","商城","购物"],教育:["learn","course","education","study","教育","学习"],娱乐:["game","entertainment","movie","music","游戏","电影","音乐"],社交:["social","community","forum","社区","论坛"]};for(const[a,i]of Object.entries(r))if(i.some(u=>t.includes(u)))return a;return null},_=s=>{try{const t=new URL(s).hostname;return t.split(".")[0].charAt(0).toUpperCase()+t.split(".")[0].slice(1)}catch{return s}},D=s=>{try{const t=new URL(s).hostname;return{title:_(s),icon:`https://www.google.com/s2/favicons?domain=${s}`,suggestedCategory:$(t)}}catch{throw new Error("无效的URL格式")}},$=s=>{const t={github:"开发工具",stackoverflow:"开发工具",youtube:"视频",bilibili:"视频",google:"搜索",baidu:"搜索",zhihu:"社交",weibo:"社交",twitter:"社交",facebook:"社交",instagram:"社交",amazon:"购物",taobao:"购物",jd:"购物"};for(const[r,a]of Object.entries(t))if(s.includes(r))return a;return"其他"},E=(s,t)=>{const r=s.toLowerCase().replace(/\/$/,"");return t.some(a=>a.url.toLowerCase().replace(/\/$/,"")===r)};function O({formData:s,setFormData:t,categories:r,onSubmit:a,onCancel:i}){const[u,g]=d.useState(!1);d.useEffect(()=>{const m=h=>{u&&!h.target.closest(".category-select-container")&&g(!1)};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[u]);const p=m=>{m.preventDefault(),a(s)};return e.jsxs("form",{onSubmit:p,className:"bookmark-form",children:[e.jsx("h3",{children:"书签信息"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:s.name,onChange:m=>t(h=>({...h,name:m.target.value})),placeholder:"书签名称",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:s.category,onChange:m=>t(h=>({...h,category:m.target.value})),onFocus:()=>g(!0),placeholder:"选择或输入新分类",required:!0}),u&&r.length>0&&e.jsx("div",{className:"category-dropdown",children:r.map((m,h)=>e.jsx("div",{className:`category-option ${s.category===m?"selected":""}`,onClick:()=>{t(o=>({...o,category:m})),g(!1)},children:m},h))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-preview",children:[s.icon&&e.jsx("img",{src:s.icon,alt:"网站图标"}),e.jsx("input",{type:"text",value:s.icon,onChange:m=>t(h=>({...h,icon:m.target.value})),placeholder:"图标URL"})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:i,children:"取消"}),e.jsx("button",{type:"submit",className:"submit-button",children:"添加书签"})]})]})}function F({analyzing:s,analysisStep:t,analysisError:r,urlExists:a}){const i=["开始分析","验证URL格式","获取网站元数据","处理分析结果","分析完成"];return e.jsxs(e.Fragment,{children:[s&&e.jsxs("div",{className:"analysis-status",children:[e.jsx("h3",{children:"正在分析网站..."}),e.jsx("div",{className:"analysis-steps",children:i.map((u,g)=>e.jsxs("div",{className:`analysis-step ${t===u?"active":""} ${i.indexOf(u)<i.indexOf(t)?"complete":""}`,children:[e.jsx("div",{className:"step-indicator",children:g+1}),e.jsx("div",{className:"step-label",children:u})]},g))})]}),a&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:"该URL已存在于您的书签中"}),e.jsx("p",{className:"error-tip",children:"提示：您可以在书签列表中查找此网站。"})]}),r&&!a&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:r}),e.jsx("p",{className:"error-tip",children:"提示：请检查网址是否正确，或稍后再试。"})]})]})}function H({onClose:s,onSubmit:t}){const{list:r}=U(),[a,i]=d.useState(""),[u,g]=d.useState({url:"",name:"",category:"",icon:""}),[p,m]=d.useState(!1),[h,o]=d.useState(null),[c,x]=d.useState(null),[j,f]=d.useState(!1),[w,C]=d.useState([]),[N,v]=d.useState(!1);d.useEffect(()=>{if(r&&r.length>0){const n=[...new Set(r.map(y=>y.category).filter(Boolean))];C(n)}},[r]);const k=async()=>{if(!(!a||!a.trim())){m(!0),o("开始分析"),x(null),f(!1),v(!1);try{o("验证URL格式");let n=a;!a.startsWith("http://")&&!a.startsWith("https://")&&(n="https://"+a);const y=n.toLowerCase().replace(/\/$/,"");if(E(y,r)){v(!0),x("该URL已存在于您的书签中"),m(!1);return}o("获取网站元数据");const L=await M(n);o("处理分析结果"),g({url:n,name:L.title||"",icon:L.icon||"",category:L.suggestedCategory||""}),o("分析完成"),f(!0)}catch(n){x(`在"${h}"步骤失败: ${n.message}`)}finally{m(!1)}}},l=n=>{const y=n.url.toLowerCase().replace(/\/$/,"");if(E(y,r)){v(!0),x("该URL已存在于您的书签中");return}t(n),s()};return e.jsx(A,{isOpen:!0,onClose:s,title:"添加新书签",size:"md",position:"center",children:e.jsxs("div",{className:"bookmark-modal-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"网址"}),e.jsxs("div",{className:"url-input-container",children:[e.jsx("input",{type:"url",value:a,onChange:n=>i(n.target.value),placeholder:"输入网站地址",required:!0}),e.jsx("button",{type:"button",className:"analyze-button",onClick:k,disabled:p||!a,children:"分析"})]})]}),e.jsx(F,{analyzing:p,analysisStep:h,analysisError:c,urlExists:N}),j&&e.jsx(O,{formData:u,setFormData:g,categories:w,onSubmit:l,onCancel:s})]})})}function I({bookmark:s,onClose:t,onSubmit:r}){const{list:a}=U(),[i,u]=d.useState({name:s.name,category:s.category,icon:s.icon}),[g,p]=d.useState([]),[m,h]=d.useState(!1);d.useEffect(()=>{if(a&&a.length>0){const c=[...new Set(a.map(x=>x.category).filter(Boolean))];p(c)}},[a]);const o=c=>{c.preventDefault(),r({...s,...i})};return e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"add-bookmark-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"编辑书签"}),e.jsx("button",{className:"close-button",onClick:t,children:"×"})]}),e.jsx("div",{className:"modal-content",children:e.jsxs("form",{onSubmit:o,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:i.name,onChange:c=>u({...i,name:c.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标 URL"}),e.jsxs("div",{className:"icon-input-container",children:[e.jsx("input",{type:"text",value:i.icon,onChange:c=>u({...i,icon:c.target.value}),placeholder:"输入图标 URL"}),i.icon&&e.jsx("div",{className:"icon-preview",children:e.jsx("img",{src:i.icon,alt:"图标预览",onError:c=>c.target.src="/fallback-icon.svg"})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:i.category,onChange:c=>u({...i,category:c.target.value}),onFocus:()=>h(!0),placeholder:"选择或输入新分类"}),m&&g.length>0&&e.jsx("div",{className:"category-dropdown",children:g.map(c=>e.jsx("div",{className:`category-option ${c===i.category?"selected":""}`,onClick:()=>{u({...i,category:c}),h(!1)},children:c},c))})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:t,children:"取消"}),e.jsx("button",{type:"submit",className:"submit-button",children:"保存修改"})]})]})})]})})}function T({message:s,type:t="success",onClose:r,duration:a=3e3}){return d.useEffect(()=>{const i=setTimeout(()=>{r()},a);return()=>clearTimeout(i)},[a,r]),e.jsxs("div",{className:`notification notification-${t}`,children:[e.jsx("span",{className:"notification-icon",children:t==="success"?"✓":"✕"}),e.jsx("span",{className:"notification-message",children:s})]})}function W({onRestore:s,onNotify:t}){const[r,a]=d.useState([]),[i,u]=d.useState(!1),[g,p]=d.useState(new Set),m=async()=>{u(!0);try{const{data:o}=await b.from("bookmark_history").select("restored_from_id").not("restored_from_id","is",null),c=new Set((o==null?void 0:o.map(f=>f.restored_from_id))||[]);p(c);const{data:x,error:j}=await b.from("bookmark_history").select("*").order("created_at",{ascending:!1});if(j)throw j;a(x)}catch(o){console.error("获取历史记录失败:",o),t==null||t({type:"error",message:"获取历史记录失败"})}finally{u(!1)}};d.useEffect(()=>{m()},[]);const h=async o=>{try{const{bookmark_data:c}=o,{error:x}=await b.from("bookmark").insert([c]);if(x)throw x;const{error:j}=await b.from("bookmark_history").insert([{action:"restore",bookmark_id:c.id,bookmark_data:c,restored_from_id:o.id}]);if(j)throw j;t==null||t({type:"success",message:"书签恢复成功"}),s==null||s(),m()}catch(c){console.error("恢复书签失败:",c),t==null||t({type:"error",message:"恢复书签失败"})}};return e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"操作历史"}),e.jsx("span",{className:"history-count",children:i?"加载中...":`${r.length} 条记录`})]}),i?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载历史记录..."})]}):e.jsx("div",{className:"history-list",children:r.map(o=>e.jsxs("div",{className:"history-item",children:[e.jsxs("div",{className:"history-content",children:[e.jsxs("span",{className:"history-action",children:[o.action==="add"&&"添加了",o.action==="delete"&&"删除了",o.action==="update"&&"修改了",o.action==="restore"&&"恢复了"]}),e.jsx("span",{className:"history-name",children:o.bookmark_data.name}),e.jsx("span",{className:"history-time",children:q(new Date(o.created_at),{addSuffix:!0,locale:z})})]}),o.action==="delete"&&!g.has(o.id)&&e.jsx("button",{className:"restore-button",onClick:()=>h(o),children:"恢复"})]},o.id))})]})}function V(){const[s,t]=d.useState(!0),{list:r,fetchBookmarks:a}=U();d.useEffect(()=>{(async()=>{t(!0),await a(),t(!1)})()},[]);const[i,u]=d.useState(!1),[g,p]=d.useState(null),m=l=>{navigator.clipboard.writeText(l).then(()=>{p({type:"success",message:"URL已复制到剪贴板"})}).catch(()=>{p({type:"error",message:"复制失败，请手动复制"})})},h=async l=>{try{const n=Date.now()+Math.floor(Math.random()*1e3),y={...l,id:n,create_at:new Date().toISOString()},{error:S}=await b.from("bookmark").insert([y]).select();if(S)throw S;await k("add",y),p({type:"success",message:"成功添加书签"}),a()}catch(n){console.log(n),p({type:"error",message:"添加书签失败，请稍后重试"})}},o=async l=>{try{const{error:n}=await b.from("bookmark").delete().eq("url",l.url);if(n)throw n;await k("delete",l),p({type:"success",message:"成功删除书签"}),a()}catch(n){console.error(n),p({type:"error",message:"删除书签失败"})}},[c,x]=d.useState(!1),[j,f]=d.useState(null),w=l=>{f(l),x(!0)},C=async l=>{try{const{error:n}=await b.from("bookmark").update({name:l.name,category:l.category,icon:l.icon}).eq("url",l.url);if(n)throw n;await k("update",l),p({type:"success",message:"成功更新书签"}),a()}catch(n){console.error(n),p({type:"error",message:"更新书签失败"})}x(!1),f(null)},[N,v]=d.useState(!1),k=async(l,n)=>{try{await b.from("bookmark_history").insert([{action:l,bookmark_id:n.id,bookmark_data:n}])}catch(y){console.error("记录历史失败:",y)}};return e.jsxs("div",{className:"dashboard",children:[e.jsxs("div",{className:"dashboard-tabs",children:[e.jsx("button",{className:`tab-button ${N?"":"active"}`,onClick:()=>v(!1),children:"书签列表"}),e.jsx("button",{className:`tab-button ${N?"active":""}`,onClick:()=>v(!0),children:"操作历史"})]}),e.jsx("div",{className:"dashboard-content",children:N?e.jsx(W,{onRestore:a,onNotify:p}):e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"书签列表"}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{className:"add-button",onClick:()=>u(!0),children:[e.jsx("span",{className:"button-icon",children:"+"}),"添加书签"]}),e.jsx("span",{className:"bookmark-count",children:s?"加载中...":`${r.length} 个书签`})]})]}),s?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载书签..."})]}):e.jsx("div",{className:"bookmark-list",children:r.map(l=>e.jsxs("div",{className:"bookmark-item",children:[e.jsx("div",{className:"bookmark-icon-wrapper",children:e.jsx("img",{"data-name":l.name,"data-category":l.category,src:l.icon,alt:"",className:"bookmark-icon",loading:"lazy",onError:n=>{n.target.src="/fallback-icon.svg"}})}),e.jsxs("div",{className:"bookmark-info",children:[e.jsx("h3",{children:l.name}),e.jsx("p",{className:"category-tag",children:l.category}),e.jsxs("div",{className:"url-container",children:[e.jsx("a",{href:l.url,target:"_blank",rel:"noopener noreferrer",children:l.url}),e.jsx("button",{className:"copy-button",onClick:n=>{n.preventDefault(),m(l.url)},title:"复制URL",children:"📋"})]})]}),e.jsxs("div",{className:"bookmark-actions",children:[e.jsx("button",{className:"edit-button",onClick:()=>w(l),title:"编辑书签",children:"✏️"}),e.jsx("button",{className:"delete-button",onClick:()=>o(l),title:"删除书签",children:e.jsx("span",{className:"delete-icon",children:"×"})})]})]},l.url))})]})}),i&&e.jsx(H,{onClose:()=>u(!1),onSubmit:h}),c&&j&&e.jsx(I,{bookmark:j,onClose:()=>{x(!1),f(null)},onSubmit:C}),g&&e.jsx(T,{type:g.type,message:g.message,onClose:()=>p(null)})]})}export{V as default};
