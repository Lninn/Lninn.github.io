import{s as k,h as L,j as e}from"./index-rG1AYvuC.js";import{b as c}from"./vendor-NnAsmyE9.js";import{M as f}from"./index-B18jI-a2.js";import{f as D}from"./utils-Byjf9Pgh.js";import{z as y}from"./zh-CN-dz9aCOR3.js";const N={async fetchLogs({environment:s,startDate:t,endDate:a,searchTerm:n,limit:i=100}){try{let l=k.from("error_logs").select("*").order("timestamp",{ascending:!1});s&&(l=l.eq("environment",s)),t&&(l=l.gte("timestamp",t)),a&&(l=l.lte("timestamp",a)),n&&(l=l.or(`error.ilike.%${n}%,component_info.ilike.%${n}%`));const{data:r,error:d}=await l.limit(i);if(d)throw d;return r}catch(l){throw new Error(L(l))}},async deleteLogs(s){try{const{error:t}=await k.from("error_logs").delete().lt("timestamp",s);if(t)throw t}catch(t){throw new Error(L(t))}},async exportLogs(s){const t=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...s.map(n=>[new Date(n.timestamp).toLocaleString(),n.environment,n.component_info,`"${n.error.replace(/"/g,'""')}"`,n.url,`"${n.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([t],{type:"text/csv;charset=utf-8;"})}};function C(){const[s,t]=c.useState([]),[a,n]=c.useState(!0),[i,l]=c.useState(null),[r,d]=c.useState({environment:"",startDate:"",endDate:"",searchTerm:""}),u=[...new Set(s.map(h=>h.environment))],m=c.useCallback(async()=>{try{n(!0);const h=await N.fetchLogs(r);t(h),l(null)}catch(h){l(h.message)}finally{n(!1)}},[r]);c.useEffect(()=>{m()},[m]);const j=c.useCallback((h,g)=>{d(v=>({...v,[h]:g}))},[]);return{logs:s,isLoading:a,error:i,setError:l,filters:r,environments:u,updateFilter:j,fetchLogs:m}}function S({filters:s,environments:t,onFilterChange:a}){const[n,i]=c.useState(!1),l=[{value:"",label:"所有环境"},...t.map(r=>({value:r,label:r}))];return e.jsxs("div",{className:"filters-container",children:[e.jsxs("div",{className:"filters-header",children:[e.jsx("h3",{className:"filters-title",children:"筛选条件"}),e.jsxs("button",{className:"filters-toggle",onClick:()=>i(!n),"aria-expanded":n,children:[n?"收起":"展开",e.jsx("span",{className:`toggle-icon ${n?"expanded":""}`,children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})})})]})]}),e.jsxs("div",{className:`filters-wrapper ${n?"expanded":""}`,children:[e.jsxs("div",{className:"filter-item filter-item-search",children:[e.jsx("label",{className:"filter-label",children:"全局搜索"}),e.jsxs("div",{className:"search-input-wrapper",children:[e.jsx("input",{type:"text",value:s.searchTerm,onChange:r=>a("searchTerm",r.target.value),placeholder:"搜索错误信息、组件或URL...",className:"filter-input search-input"}),s.searchTerm&&e.jsx("button",{className:"search-clear-btn",onClick:()=>a("searchTerm",""),"aria-label":"清除搜索",children:"×"})]})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"运行环境"}),e.jsx("select",{value:s.environment,onChange:r=>a("environment",r.target.value),className:"filter-input",children:l.map(r=>e.jsx("option",{value:r.value,children:r.label},r.value))})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"起始日期"}),e.jsx("input",{type:"date",value:s.startDate,onChange:r=>a("startDate",r.target.value),className:"filter-input"})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"截止日期"}),e.jsx("input",{type:"date",value:s.endDate,onChange:r=>a("endDate",r.target.value),className:"filter-input"})]})]}),(s.environment||s.startDate||s.endDate||s.searchTerm)&&e.jsxs("div",{className:"active-filters",children:[e.jsx("span",{className:"active-filters-label",children:"已应用筛选:"}),e.jsxs("div",{className:"filter-tags",children:[s.environment&&e.jsxs("span",{className:"filter-tag",children:["环境: ",s.environment,e.jsx("button",{className:"tag-remove",onClick:()=>a("environment",""),"aria-label":"移除环境筛选",children:"×"})]}),s.startDate&&e.jsxs("span",{className:"filter-tag",children:["开始: ",s.startDate,e.jsx("button",{className:"tag-remove",onClick:()=>a("startDate",""),"aria-label":"移除开始日期筛选",children:"×"})]}),s.endDate&&e.jsxs("span",{className:"filter-tag",children:["结束: ",s.endDate,e.jsx("button",{className:"tag-remove",onClick:()=>a("endDate",""),"aria-label":"移除结束日期筛选",children:"×"})]}),s.searchTerm&&e.jsxs("span",{className:"filter-tag",children:["搜索: ",s.searchTerm,e.jsx("button",{className:"tag-remove",onClick:()=>a("searchTerm",""),"aria-label":"移除搜索筛选",children:"×"})]}),e.jsx("button",{className:"clear-all-btn",onClick:()=>{a("environment",""),a("startDate",""),a("endDate",""),a("searchTerm","")},children:"清除全部"})]})]})]})}function _({log:s}){const[t,a]=c.useState(!1),n=(r,d=120)=>r?r.length>d?`${r.substring(0,d)}...`:r:"",i=D(new Date(s.timestamp),{addSuffix:!0,locale:y}),l=e.jsx("button",{onClick:()=>a(!1),children:"关闭"});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"log-item",children:[e.jsxs("div",{className:"log-item-header",children:[e.jsx("div",{className:"log-item-time",children:i}),e.jsx("div",{className:"log-item-env",children:s.environment})]}),e.jsxs("div",{className:"log-item-content",children:[e.jsx("div",{className:"log-item-component",children:s.component_info}),e.jsx("div",{className:"log-item-message",children:s.error}),e.jsx("div",{className:"log-item-url",children:e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",title:s.url,children:n(s.url,50)})})]}),e.jsx("div",{className:"log-item-actions",children:e.jsxs("button",{className:"log-item-details-btn",onClick:()=>a(!0),children:[e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("circle",{cx:"11",cy:"11",r:"8"}),e.jsx("line",{x1:"21",y1:"21",x2:"16.65",y2:"16.65"})]}),"查看详情"]})})]}),e.jsx(f,{isOpen:t,onClose:()=>a(!1),title:"错误日志详情",size:"md",footer:l,children:e.jsxs("div",{className:"log-details",children:[e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"基本信息"}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"时间："}),e.jsx("span",{className:"log-details-value",children:new Date(s.timestamp).toLocaleString()})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"环境："}),e.jsx("span",{className:"log-details-value",children:s.environment})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"组件："}),e.jsx("span",{className:"log-details-value",children:s.component_info})]})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"错误信息"}),e.jsx("div",{className:"log-details-error",children:s.error})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"URL"}),e.jsx("div",{className:"log-details-url",children:e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",children:s.url})})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"用户代理"}),e.jsx("div",{className:"log-details-user-agent",children:s.user_agent})]})]})})]})}function E({isOpen:s,onClose:t,onConfirm:a,deleteDate:n,onDateChange:i}){const l=e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-button",onClick:t,children:"取消"}),e.jsx("button",{className:"confirm-button danger",onClick:a,children:"确认删除"})]});return e.jsx(f,{isOpen:s,onClose:t,title:"删除历史错误日志",size:"sm",footer:l,children:e.jsxs("div",{className:"delete-modal-content",children:[e.jsx("p",{children:"确定要删除多久以前的错误日志？"}),e.jsx("div",{className:"delete-date-selector",children:e.jsxs("select",{value:n,onChange:r=>i(Number(r.target.value)),children:[e.jsx("option",{value:7,children:"7天前"}),e.jsx("option",{value:30,children:"30天前"}),e.jsx("option",{value:90,children:"90天前"}),e.jsx("option",{value:180,children:"180天前"}),e.jsx("option",{value:365,children:"一年前"})]})}),e.jsx("p",{className:"delete-warning",children:"注意：此操作不可恢复，将永久删除所选时间之前的所有错误日志记录。"})]})})}function T({logs:s}){const[t,a]=c.useState(null),n=l=>{a(l)},i=e.jsx("button",{onClick:()=>a(null),children:"关闭"});return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"log-table-wrapper",children:e.jsxs("table",{className:"log-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"时间"}),e.jsx("th",{children:"环境"}),e.jsx("th",{children:"组件"}),e.jsx("th",{children:"错误信息"}),e.jsx("th",{children:"URL"})]})}),e.jsx("tbody",{children:s.map(l=>e.jsxs("tr",{onClick:()=>n(l),children:[e.jsx("td",{children:e.jsx("span",{title:new Date(l.timestamp).toLocaleString(),children:D(new Date(l.timestamp),{addSuffix:!0,locale:y})})}),e.jsx("td",{children:e.jsx("span",{className:"env-badge",children:l.environment})}),e.jsx("td",{children:l.component_info}),e.jsx("td",{className:"error-cell",children:l.error}),e.jsx("td",{className:"url-cell",children:e.jsx("a",{href:l.url,target:"_blank",rel:"noopener noreferrer",onClick:r=>r.stopPropagation(),children:l.url})})]},l.id))})]})}),e.jsx(f,{isOpen:!!t,onClose:()=>a(null),title:"错误日志详情",size:"md",footer:i,children:t&&e.jsxs("div",{className:"log-details",children:[e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"基本信息"}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"时间："}),e.jsx("span",{className:"log-details-value",children:new Date(t.timestamp).toLocaleString()})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"环境："}),e.jsx("span",{className:"log-details-value",children:t.environment})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"组件："}),e.jsx("span",{className:"log-details-value",children:t.component_info})]})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"错误信息"}),e.jsx("div",{className:"log-details-error",children:t.error})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"URL"}),e.jsx("div",{className:"log-details-url",children:e.jsx("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",children:t.url})})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"用户代理"}),e.jsx("div",{className:"log-details-user-agent",children:t.user_agent})]})]})})]})}function z(){const{logs:s,isLoading:t,error:a,filters:n,environments:i,updateFilter:l,fetchLogs:r,setError:d}=C(),[u,m]=c.useState(!1),[j,h]=c.useState(30),g=async()=>{const o=await N.exportLogs(s),w=window.URL.createObjectURL(o),x=document.createElement("a");x.href=w,x.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(x),x.click(),window.URL.revokeObjectURL(w),document.body.removeChild(x)},v=async()=>{try{const o=new Date;o.setDate(o.getDate()-j),await N.deleteLogs(o.toISOString()),m(!1),r()}catch(o){console.error("Error deleting logs:",o),d(o.message||"删除日志失败"),m(!1)}},[p,b]=c.useState("card");return e.jsxs("div",{className:"error-logs",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"错误日志"}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("div",{className:"view-toggle",children:[e.jsx("button",{className:`view-toggle-btn ${p==="card"?"active":""}`,onClick:()=>b("card"),title:"卡片视图",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"})]})}),e.jsx("button",{className:`view-toggle-btn ${p==="table"?"active":""}`,onClick:()=>b("table"),title:"表格视图",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})})]}),e.jsx("span",{className:"log-count",children:t?"加载中...":`${s.length} 条记录`}),e.jsx("button",{onClick:g,children:"导出日志"}),e.jsx("button",{className:"danger-outline",onClick:()=>m(!0),children:"删除历史日志"})]})]}),e.jsx(S,{filters:n,environments:i,onFilterChange:l}),a&&e.jsx("div",{className:"error-message",children:a}),t?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载错误日志..."})]}):e.jsx(e.Fragment,{children:p==="card"?e.jsx("div",{className:"logs-list",children:s.length>0?s.map(o=>e.jsx(_,{log:o},o.id)):e.jsx("div",{className:"no-logs",children:e.jsx("p",{children:"没有找到符合条件的错误日志"})})}):e.jsx(T,{logs:s})}),e.jsx(E,{isOpen:u,onClose:()=>m(!1),onConfirm:v,deleteDate:j,onDateChange:h})]})}export{z as default};
