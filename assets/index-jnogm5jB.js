import{s as S,j as e}from"./index-BU-30AHs.js";import{b as c}from"./vendor-C_ovgAfI.js";import{c as z,f as q}from"./utils-CWHH1IbV.js";import{M as $}from"./index-B8NPo5ma.js";import{z as B}from"./zh-CN-CCt-M6vz.js";import{b as L}from"./bookmark-BeUkOQBb.js";const E=z(t=>({list:[],fetchBookmarks:async()=>{const{data:a,error:n}=await S.from("bookmark").select("*").order("create_at",{ascending:!1});if(n){console.error("Failed to fetch bookmark data:",n);return}t({list:a})}})),M=async t=>{var a,n,r,o;try{const d="https://api.allorigins.win/get?url="+encodeURIComponent(t),l=await(await fetch(d)).json();if(!l.contents)throw new Error("无法获取网站内容");const p=new DOMParser().parseFromString(l.contents,"text/html");let s=((a=p.querySelector("title"))==null?void 0:a.textContent)||"";s||(s=((n=p.querySelector('meta[property="og:title"]'))==null?void 0:n.getAttribute("content"))||"");let i="";const h=p.querySelector('link[rel="icon"]')||p.querySelector('link[rel="shortcut icon"]');h&&(i=new URL(h.getAttribute("href"),t).href),i||(i=`https://www.google.com/s2/favicons?domain=${t}`);let y=((r=p.querySelector('meta[name="keywords"]'))==null?void 0:r.getAttribute("content"))||"",f=((o=p.querySelector('meta[name="description"]'))==null?void 0:o.getAttribute("content"))||"",w=O(y+" "+f)||R(new URL(t).hostname);return{title:s||_(t),icon:i,suggestedCategory:w}}catch(d){return console.error("获取网站信息失败:",d),F(t)}},O=(t="")=>{const a=t.toLowerCase(),n={技术:["programming","developer","coding","编程","开发","技术"],新闻:["news","daily","report","新闻","资讯"],购物:["shop","store","buy","price","商城","购物"],教育:["learn","course","education","study","教育","学习"],娱乐:["game","entertainment","movie","music","游戏","电影","音乐"],社交:["social","community","forum","社区","论坛"]};for(const[r,o]of Object.entries(n))if(o.some(d=>a.includes(d)))return r;return null},_=t=>{try{const a=new URL(t).hostname;return a.split(".")[0].charAt(0).toUpperCase()+a.split(".")[0].slice(1)}catch{return t}},F=t=>{try{const a=new URL(t).hostname;return{title:_(t),icon:`https://www.google.com/s2/favicons?domain=${t}`,suggestedCategory:R(a)}}catch{throw new Error("无效的URL格式")}},R=t=>{const a={github:"开发工具",stackoverflow:"开发工具",youtube:"视频",bilibili:"视频",google:"搜索",baidu:"搜索",zhihu:"社交",weibo:"社交",twitter:"社交",facebook:"社交",instagram:"社交",amazon:"购物",taobao:"购物",jd:"购物"};for(const[n,r]of Object.entries(a))if(t.includes(n))return r;return"其他"},U=(t,a)=>{const n=t.toLowerCase().replace(/\/$/,"");return a.some(r=>r.url.toLowerCase().replace(/\/$/,"")===n)};function D({formData:t,setFormData:a,categories:n,onSubmit:r,onCancel:o}){const[d,g]=c.useState(!1),[l,x]=c.useState(!1);c.useEffect(()=>{const s=i=>{d&&!i.target.closest(".category-select-container")&&g(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[d]);const p=async s=>{if(s.preventDefault(),!l){x(!0);try{await r(t)}catch{throw new Error("添加书签失败")}finally{x(!1)}}};return e.jsxs("form",{onSubmit:p,className:"bookmark-form",children:[e.jsx("h3",{children:"书签信息"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:t.name,onChange:s=>a(i=>({...i,name:s.target.value})),placeholder:"书签名称",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:t.category,onChange:s=>a(i=>({...i,category:s.target.value})),onFocus:()=>g(!0),placeholder:"选择或输入新分类",required:!0}),d&&n.length>0&&e.jsx("div",{className:"category-dropdown",children:n.map((s,i)=>e.jsx("div",{className:`category-option ${t.category===s?"selected":""}`,onClick:()=>{a(h=>({...h,category:s})),g(!1)},children:s},i))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-input-container",children:[e.jsx("input",{type:"text",value:t.icon,onChange:s=>a(i=>({...i,icon:s.target.value})),placeholder:"图标URL"}),t.icon&&e.jsx("div",{className:"icon-preview",children:e.jsx("img",{src:t.icon,alt:"网站图标",onError:s=>s.target.src="/fallback-icon.svg"})})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:o,disabled:l,children:"取消"}),e.jsx("button",{type:"submit",className:`submit-button ${l?"loading":""}`,disabled:l,children:l?"添加中...":"添加书签"})]})]})}function H({analyzing:t,analysisStep:a,analysisError:n,urlExists:r}){const o=["开始分析","验证URL格式","获取网站元数据","处理分析结果","分析完成"];return e.jsxs(e.Fragment,{children:[t&&e.jsxs("div",{className:"analysis-status",children:[e.jsx("h3",{children:"正在分析网站..."}),e.jsx("div",{className:"analysis-steps",children:o.map((d,g)=>e.jsxs("div",{className:`analysis-step ${a===d?"active":""} ${o.indexOf(d)<o.indexOf(a)?"complete":""}`,children:[e.jsx("div",{className:"step-indicator",children:g+1}),e.jsx("div",{className:"step-label",children:d})]},g))})]}),r&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:"该URL已存在于您的书签中"}),e.jsx("p",{className:"error-tip",children:"提示：您可以在书签列表中查找此网站。"})]}),n&&!r&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:n}),e.jsx("p",{className:"error-tip",children:"提示：请检查网址是否正确，或稍后再试。"})]})]})}function I({onClose:t,onSubmit:a}){const{list:n}=E(),[r,o]=c.useState(""),[d,g]=c.useState({url:"",name:"",category:"",icon:""}),[l,x]=c.useState(!1),[p,s]=c.useState(null),[i,h]=c.useState(null),[y,f]=c.useState(!1),[w,u]=c.useState([]),[b,k]=c.useState(!1);c.useEffect(()=>{if(n&&n.length>0){const j=[...new Set(n.map(N=>N.category).filter(Boolean))];u(j)}},[n]);const m=async()=>{if(!(!r||!r.trim())){x(!0),s("开始分析"),h(null),f(!1),k(!1);try{s("验证URL格式");let j=r;!r.startsWith("http://")&&!r.startsWith("https://")&&(j="https://"+r);const N=j.toLowerCase().replace(/\/$/,"");if(U(N,n)){k(!0),h("该URL已存在于您的书签中"),x(!1);return}s("获取网站元数据");const C=await M(j);s("处理分析结果"),g({url:j,name:C.title||"",icon:C.icon||"",category:C.suggestedCategory||""}),s("分析完成"),f(!0)}catch(j){h(`在"${p}"步骤失败: ${j.message}`)}finally{x(!1)}}},v=async j=>{try{const N=j.url.toLowerCase().replace(/\/$/,"");if(U(N,n)){k(!0),h("该URL已存在于您的书签中");return}await a(j),t()}catch(N){console.error("添加书签失败:",N),h("添加书签失败，请重试")}};return e.jsx($,{isOpen:!0,onClose:t,title:"添加新书签",size:"md",position:"center",children:e.jsxs("div",{className:"bookmark-modal-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"网址"}),e.jsxs("div",{className:"url-input-container",children:[e.jsx("input",{type:"url",value:r,onChange:j=>o(j.target.value),placeholder:"输入网站地址",required:!0}),e.jsx("button",{type:"button",className:`analyze-button ${l?"loading":""}`,onClick:m,disabled:l||!r,children:l?"分析中...":"分析"})]})]}),e.jsx(H,{analyzing:l,analysisStep:p,analysisError:i,urlExists:b}),y&&e.jsx(D,{formData:d,setFormData:g,categories:w,onSubmit:v,onCancel:t})]})})}function T({bookmark:t,onClose:a,onSubmit:n}){const{list:r}=E(),[o,d]=c.useState({name:t.name,category:t.category,icon:t.icon}),[g,l]=c.useState([]),[x,p]=c.useState(!1),[s,i]=c.useState(!1),[h,y]=c.useState(!1),f=c.useRef({name:t.name,category:t.category,icon:t.icon}).current;c.useEffect(()=>{const u=o.name!==f.name||o.category!==f.category||o.icon!==f.icon;y(u)},[o,f]),c.useEffect(()=>{if(r&&r.length>0){const u=[...new Set(r.map(b=>b.category).filter(Boolean))];l(u)}},[r]),c.useEffect(()=>{const u=b=>{x&&!b.target.closest(".category-select-container")&&p(!1)};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[x]);const w=async u=>{if(u.preventDefault(),!(!h||s)){i(!0);try{await n({...t,...o}),a()}catch(b){console.error("保存书签失败:",b)}finally{i(!1)}}};return e.jsx($,{isOpen:!0,onClose:a,title:"编辑书签",size:"md",position:"center",children:e.jsx("div",{className:"bookmark-modal-content",children:e.jsxs("form",{onSubmit:w,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:o.name,onChange:u=>d({...o,name:u.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-input-container",children:[e.jsx("input",{type:"text",value:o.icon,onChange:u=>d({...o,icon:u.target.value}),placeholder:"输入图标 URL"}),o.icon&&e.jsx("div",{className:"icon-preview",children:e.jsx("img",{src:o.icon,alt:"图标预览",onError:u=>u.target.src="/fallback-icon.svg"})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:o.category,onChange:u=>d({...o,category:u.target.value}),onFocus:()=>p(!0),placeholder:"选择或输入新分类"}),x&&g.length>0&&e.jsx("div",{className:"category-dropdown",children:g.map(u=>e.jsx("div",{className:`category-option ${u===o.category?"selected":""}`,onClick:()=>{d({...o,category:u}),p(!1)},children:u},u))})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:a,disabled:s,children:"取消"}),e.jsx("button",{type:"submit",className:`submit-button ${s?"loading":""}`,disabled:!h||s,children:s?"保存中...":"保存修改"})]})]})})})}function W({message:t,type:a="success",onClose:n,duration:r=3e3}){return c.useEffect(()=>{const o=setTimeout(()=>{n()},r);return()=>clearTimeout(o)},[r,n]),e.jsxs("div",{className:`notification notification-${a}`,children:[e.jsx("span",{className:"notification-icon",children:a==="success"?"✓":"✕"}),e.jsx("span",{className:"notification-message",children:t})]})}function P({onRestore:t,onNotify:a}){const[n,r]=c.useState([]),[o,d]=c.useState(!1),[g,l]=c.useState(new Set),x=async()=>{d(!0);try{const{data:s}=await S.from("bookmark_history").select("restored_from_id").not("restored_from_id","is",null),i=new Set((s==null?void 0:s.map(f=>f.restored_from_id))||[]);l(i);const{data:h,error:y}=await S.from("bookmark_history").select("*").order("created_at",{ascending:!1});if(y)throw y;r(h)}catch(s){console.error("获取历史记录失败:",s),a==null||a({type:"error",message:"获取历史记录失败"})}finally{d(!1)}};c.useEffect(()=>{x()},[]);const p=async s=>{try{const{bookmark_data:i}=s,{error:h}=await S.from("bookmark").insert([i]);if(h)throw h;const{error:y}=await S.from("bookmark_history").insert([{action:"restore",bookmark_id:i.id,bookmark_data:i,restored_from_id:s.id}]);if(y)throw y;a==null||a({type:"success",message:"书签恢复成功"}),t==null||t(),x()}catch(i){console.error("恢复书签失败:",i),a==null||a({type:"error",message:"恢复书签失败"})}};return e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"操作历史"}),e.jsx("span",{className:"history-count",children:o?"加载中...":`${n.length} 条记录`})]}),o?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载历史记录..."})]}):e.jsx("div",{className:"history-list",children:n.map(s=>e.jsxs("div",{className:"history-item",children:[e.jsxs("div",{className:"history-content",children:[e.jsxs("span",{className:"history-action",children:[s.action==="add"&&"添加了",s.action==="delete"&&"删除了",s.action==="update"&&"修改了",s.action==="restore"&&"恢复了"]}),e.jsx("span",{className:"history-name",children:s.bookmark_data.name}),e.jsx("span",{className:"history-time",children:q(new Date(s.created_at),{addSuffix:!0,locale:B})})]}),s.action==="delete"&&!g.has(s.id)&&e.jsx("button",{className:"restore-button",onClick:()=>p(s),children:"恢复"})]},s.id))})]})}function Y(){const[t,a]=c.useState(!0),{list:n,fetchBookmarks:r}=E();c.useEffect(()=>{(async()=>{a(!0),await r(),a(!1)})()},[]);const[o,d]=c.useState(!1),[g,l]=c.useState(null),x=m=>{navigator.clipboard.writeText(m).then(()=>{l({type:"success",message:"URL已复制到剪贴板"})}).catch(()=>{l({type:"error",message:"复制失败，请手动复制"})})},p=async m=>{try{await L.create(m),l({type:"success",message:"成功添加书签"}),r()}catch(v){console.log(v),l({type:"error",message:"添加书签失败，请稍后重试"})}},s=async m=>{try{await L.delete(m),l({type:"success",message:"成功删除书签"}),r()}catch(v){console.error(v),l({type:"error",message:"删除书签失败"})}},[i,h]=c.useState(!1),[y,f]=c.useState(null),w=m=>{f(m),h(!0)},u=async m=>{try{await L.update(m),l({type:"success",message:"成功更新书签"}),r()}catch(v){console.error(v),l({type:"error",message:"更新书签失败"})}h(!1),f(null)},[b,k]=c.useState(!1);return e.jsxs("div",{className:"dashboard",children:[e.jsxs("div",{className:"dashboard-tabs",children:[e.jsx("button",{className:`tab-button ${b?"":"active"}`,onClick:()=>k(!1),children:"书签列表"}),e.jsx("button",{className:`tab-button ${b?"active":""}`,onClick:()=>k(!0),children:"操作历史"})]}),e.jsx("div",{className:"dashboard-content",children:b?e.jsx(P,{onRestore:r,onNotify:l}):e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"书签列表"}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{className:"add-button",onClick:()=>d(!0),children:[e.jsx("span",{className:"button-icon",children:"+"}),"添加书签"]}),e.jsx("span",{className:"bookmark-count",children:t?"加载中...":`${n.length} 个书签`})]})]}),t?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载书签..."})]}):e.jsx("div",{className:"bookmark-list",children:n.map(m=>e.jsxs("div",{className:"bookmark-item",children:[e.jsx("div",{className:"bookmark-icon-wrapper",children:e.jsx("img",{"data-name":m.name,"data-category":m.category,src:m.icon,alt:"",className:"bookmark-icon",loading:"lazy",onError:v=>{v.target.src="/fallback-icon.svg"}})}),e.jsxs("div",{className:"bookmark-info",children:[e.jsx("h3",{children:m.name}),e.jsx("p",{className:"category-tag",children:m.category}),e.jsxs("div",{className:"url-container",children:[e.jsx("a",{href:m.url,target:"_blank",rel:"noopener noreferrer",children:m.url}),e.jsx("button",{className:"copy-button",onClick:v=>{v.preventDefault(),x(m.url)},title:"复制URL",children:"📋"})]})]}),e.jsxs("div",{className:"bookmark-actions",children:[e.jsx("button",{className:"edit-button",onClick:()=>w(m),title:"编辑书签",children:"✏️"}),e.jsx("button",{className:"delete-button",onClick:()=>s(m),title:"删除书签",children:e.jsx("span",{className:"delete-icon",children:"×"})})]})]},m.url))})]})}),o&&e.jsx(I,{onClose:()=>d(!1),onSubmit:p}),i&&y&&e.jsx(T,{bookmark:y,onClose:()=>{h(!1),f(null)},onSubmit:u}),g&&e.jsx(W,{type:g.type,message:g.message,onClose:()=>l(null)})]})}export{Y as default};
