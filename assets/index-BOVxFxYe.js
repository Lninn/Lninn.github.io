import{j as e,r as d,E as f}from"./index-DQQPEClv.js";import{s as u}from"./supabaseClient-CxYjs-Au.js";function x({list:t,searchTerm:c,category:s}){const o=async a=>{try{await u.from("bookmark_views").insert([{category:s,url:a}])}catch(i){console.error("Failed to record view:",i)}},n=(a,i)=>i?a.split(new RegExp(`(${i})`,"gi")).map((r,m)=>r.toLowerCase()===i.toLowerCase()?e.jsx("span",{className:"highlight",children:r},m):r):a;return e.jsx("ul",{className:"bookmark-list",children:t.map(a=>e.jsx("li",{className:"bookmark-item",children:e.jsxs("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"bookmark-link",onClick:()=>o(a.url),children:[e.jsx("div",{className:"bookmark-icon-wrapper",children:e.jsx("img",{src:a.icon,alt:"",className:"bookmark-icon",loading:"lazy",onError:i=>{i.target.src="/fallback-icon.svg"}})}),e.jsx("div",{className:"bookmark-content",children:e.jsx("div",{className:"bookmark-name",children:n(a.name,c)})})]})},a.name))})}function v(t){var c=t,s={};for(const a of c)if("category"in a){var o=a.category;o in s?s[o].push(a):s[o]=[a]}var n=Object.entries(s);return j(n,!1)}function j(t,c=!0){return t.sort((s,o)=>c?s[0][0].localeCompare(o[0][0]):o[0][0].localeCompare(s[0][0]))}const w=g();async function g(){const{data:t,error:c}=await u.from("bookmark").select("*");if(c)return console.error("Failed to fetch bookmark data:",c),{list:[],viewsMap:new Map};const{data:s,error:o}=await u.from("category_views").select("*");o&&console.error("Failed to fetch views data:",o);const n=new Map((s==null?void 0:s.map(l=>[l.category,l.view_count]))||[]);return{list:v(t).sort((l,r)=>{const m=n.get(l[0])||0;return(n.get(r[0])||0)-m}),viewsMap:n}}function y(){const{list:t,viewsMap:c}=d.use(w),[s,o]=d.useState(""),[n,a]=d.useState("全部"),i=d.useMemo(()=>["全部",...new Set(t.map(([r])=>r))],[t]),l=d.useMemo(()=>!s&&n==="全部"?t:t.map(([r,m])=>{if(n!=="全部"&&r!==n)return[r,[]];const h=m.filter(k=>{const p=s.toLowerCase();return k.name.toLowerCase().includes(p)||k.url.toLowerCase().includes(p)});return[r,h]}).filter(([,r])=>r.length>0),[t,s,n]);return e.jsxs("div",{className:"bookmark-container",children:[e.jsxs("div",{className:"bookmark-header",children:[e.jsxs("div",{className:"header-top",children:[e.jsx("h1",{children:"我的书签"}),e.jsxs("div",{className:"search-input-wrapper",children:[e.jsx("span",{className:"search-icon",children:"🔍"}),e.jsx("input",{type:"text",className:"search-input",placeholder:"搜索书签...",value:s,onChange:r=>o(r.target.value)}),s&&e.jsx("button",{className:"clear-search",onClick:()=>o(""),title:"清除搜索",children:"×"})]})]}),e.jsxs("div",{className:"category-filter-container",children:[e.jsx("span",{className:"filter-label",children:"分类筛选:"}),e.jsx("div",{className:"category-filter",children:i.map(r=>e.jsx("button",{className:`category-filter-btn ${n===r?"active":""}`,onClick:()=>{a(n===r?"全部":r)},children:r},r))})]})]}),e.jsx("section",{className:"bookmark-grid",children:l.length>0?l.map(([r,m])=>e.jsx(f,{showDetails:!1,children:e.jsx(N,{name:r,data:m,searchTerm:s,viewCount:c.get(r)||0})},r)):e.jsxs("div",{className:"no-results",children:[e.jsx("p",{children:"没有找到匹配的书签"}),e.jsx("button",{className:"reset-search",onClick:()=>{o(""),a("全部")},children:"重置搜索"})]})})]})}function N({name:t,data:c,searchTerm:s}){return e.jsxs("div",{className:"bookmark-category",children:[e.jsx("h2",{className:"category-title",children:t}),e.jsx(x,{list:c,searchTerm:s,category:t})]})}export{y as default};
