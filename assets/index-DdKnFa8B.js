import{j as i}from"./index-BFytwfpB.js";import{r as c}from"./vendor-DaomY4Gh.js";import{u as E}from"./bookmark-BlRs6NkT.js";import R from"./BookmarkForm-C_isX_d5.js";import $ from"./AnalysisStatus-DPcNOJyP.js";import{M as q}from"./index-Bh65Ap2h.js";import"./utils-DVSSZgyS.js";const M=async t=>{var o,r,e,g;try{const u="https://api.allorigins.win/get?url="+encodeURIComponent(t),m=await(await fetch(u)).json();if(!m.contents)throw new Error("无法获取网站内容");const n=new DOMParser().parseFromString(m.contents,"text/html");let a=((o=n.querySelector("title"))==null?void 0:o.textContent)||"";a||(a=((r=n.querySelector('meta[property="og:title"]'))==null?void 0:r.getAttribute("content"))||"");let d="";const l=n.querySelector('link[rel="icon"]')||n.querySelector('link[rel="shortcut icon"]');l&&(d=new URL(l.getAttribute("href"),t).href),d||(d=`https://www.google.com/s2/favicons?domain=${t}`);let w=((e=n.querySelector('meta[name="keywords"]'))==null?void 0:e.getAttribute("content"))||"",f=((g=n.querySelector('meta[name="description"]'))==null?void 0:g.getAttribute("content"))||"",b=F(w+" "+f)||U(new URL(t).hostname);return{title:a||C(t),icon:d,suggestedCategory:b}}catch(u){return console.error("获取网站信息失败:",u),B(t)}},F=(t="")=>{const o=t.toLowerCase(),r={技术:["programming","developer","coding","编程","开发","技术"],新闻:["news","daily","report","新闻","资讯"],购物:["shop","store","buy","price","商城","购物"],教育:["learn","course","education","study","教育","学习"],娱乐:["game","entertainment","movie","music","游戏","电影","音乐"],社交:["social","community","forum","社区","论坛"]};for(const[e,g]of Object.entries(r))if(g.some(u=>o.includes(u)))return e;return null},C=t=>{try{const o=new URL(t).hostname;return o.split(".")[0].charAt(0).toUpperCase()+o.split(".")[0].slice(1)}catch{return t}},B=t=>{try{const o=new URL(t).hostname;return{title:C(t),icon:`https://www.google.com/s2/favicons?domain=${t}`,suggestedCategory:U(o)}}catch{throw new Error("无效的URL格式")}},U=t=>{const o={github:"开发工具",stackoverflow:"开发工具",youtube:"视频",bilibili:"视频",google:"搜索",baidu:"搜索",zhihu:"社交",weibo:"社交",twitter:"社交",facebook:"社交",instagram:"社交",amazon:"购物",taobao:"购物",jd:"购物"};for(const[r,e]of Object.entries(o))if(t.includes(r))return e;return"其他"},k=(t,o)=>{const r=t.toLowerCase().replace(/\/$/,"");return o.some(e=>e.url.toLowerCase().replace(/\/$/,"")===r)};function G({onClose:t,onSubmit:o}){const{list:r}=E(),[e,g]=c.useState(""),[u,h]=c.useState({url:"",name:"",category:"",icon:""}),[m,y]=c.useState(!1),[n,a]=c.useState(null),[d,l]=c.useState(null),[w,f]=c.useState(!1),[b,j]=c.useState([]),[L,x]=c.useState(!1);c.useEffect(()=>{if(r&&r.length>0){const s=[...new Set(r.map(p=>p.category).filter(Boolean))];j(s)}},[r]);const v=async()=>{if(!(!e||!e.trim())){y(!0),a("开始分析"),l(null),f(!1),x(!1);try{a("验证URL格式");let s=e;!e.startsWith("http://")&&!e.startsWith("https://")&&(s="https://"+e);const p=s.toLowerCase().replace(/\/$/,"");if(k(p,r)){x(!0),l("该URL已存在于您的书签中"),y(!1);return}a("获取网站元数据");const S=await M(s);a("处理分析结果"),h({url:s,name:S.title||"",icon:S.icon||"",category:S.suggestedCategory||""}),a("分析完成"),f(!0)}catch(s){l(`在"${n}"步骤失败: ${s.message}`)}finally{y(!1)}}},A=async s=>{try{const p=s.url.toLowerCase().replace(/\/$/,"");if(k(p,r)){x(!0),l("该URL已存在于您的书签中");return}await o(s),t()}catch(p){console.error("添加书签失败:",p),l("添加书签失败，请重试")}};return i.jsx(q,{isOpen:!0,onClose:t,title:"添加新书签",size:"md",position:"center",children:i.jsxs("div",{className:"bookmark-modal-content",children:[i.jsxs("div",{className:"form-group",children:[i.jsx("label",{children:"网址"}),i.jsxs("div",{className:"url-input-container",children:[i.jsx("input",{type:"url",value:e,onChange:s=>g(s.target.value),placeholder:"输入网站地址",required:!0}),i.jsx("button",{type:"button",className:`analyze-button ${m?"loading":""}`,onClick:v,disabled:m||!e,children:m?"分析中...":"分析"})]})]}),i.jsx($,{analyzing:m,analysisStep:n,analysisError:d,urlExists:L}),w&&i.jsx(R,{formData:u,setFormData:h,categories:b,onSubmit:A,onCancel:t})]})})}export{G as default};
