import{s as w,j as e}from"./index-Ct-Fg0Nq.js";import{b as n}from"./vendor-C_ovgAfI.js";import{c as G,f as J}from"./utils-CWHH1IbV.js";import{z as K}from"./zh-CN-CCt-M6vz.js";const z=G(u=>({list:[],fetchBookmarks:async()=>{const{data:i,error:d}=await w.from("bookmark").select("*").order("create_at",{ascending:!1});if(d){console.error("Failed to fetch bookmark data:",d);return}u({list:i})}}));function Q({onClose:u,onSubmit:i}){const{list:d}=z(),[c,m]=n.useState(""),[h,g]=n.useState({url:"",name:"",category:"",icon:""}),[p,j]=n.useState(!1),[y,r]=n.useState(null),[o,x]=n.useState(null),[b,N]=n.useState(!1),[D,q]=n.useState([]),[k,S]=n.useState(!1),[C,t]=n.useState(!1);n.useEffect(()=>{if(d&&d.length>0){const s=[...new Set(d.map(a=>a.category).filter(Boolean))];q(s)}},[d]),n.useEffect(()=>{const s=a=>{k&&!a.target.closest(".category-select-container")&&S(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[k]);const l=async()=>{if(!(!c||!c.trim())){j(!0),r("开始分析"),x(null),N(!1),t(!1);try{r("验证URL格式");let s=c;!c.startsWith("http://")&&!c.startsWith("https://")&&(s="https://"+c);const a=s.toLowerCase().replace(/\/$/,"");if(d.some(U=>U.url.toLowerCase().replace(/\/$/,"")===a)){t(!0),x("该URL已存在于您的书签中"),j(!1);return}r("获取网站元数据");const f=await L(s);r("处理分析结果"),g({url:s,name:f.title||"",icon:f.icon||"",category:f.suggestedCategory||""}),r("分析完成"),N(!0)}catch(s){x(`在"${y}"步骤失败: ${s.message}`)}finally{j(!1)}}},L=async s=>{var a,v,f,U;try{const _="https://api.allorigins.win/get?url="+encodeURIComponent(s),B=await(await fetch(_)).json();if(!B.contents)throw new Error("无法获取网站内容");const E=new DOMParser().parseFromString(B.contents,"text/html");let A=((a=E.querySelector("title"))==null?void 0:a.textContent)||"";A||(A=((v=E.querySelector('meta[property="og:title"]'))==null?void 0:v.getAttribute("content"))||"");let $="";const O=E.querySelector('link[rel="icon"]')||E.querySelector('link[rel="shortcut icon"]');O&&($=new URL(O.getAttribute("href"),s).href),$||($=`https://www.google.com/s2/favicons?domain=${s}`);let T=((f=E.querySelector('meta[name="keywords"]'))==null?void 0:f.getAttribute("content"))||"",W=((U=E.querySelector('meta[name="description"]'))==null?void 0:U.getAttribute("content"))||"",P=R(T+" "+W)||F(new URL(s).hostname);return{title:A||M(s),icon:$,suggestedCategory:P}}catch(_){return console.error("获取网站信息失败:",_),H(s)}},R=(s="")=>{const a=s.toLowerCase(),v={技术:["programming","developer","coding","编程","开发","技术"],新闻:["news","daily","report","新闻","资讯"],购物:["shop","store","buy","price","商城","购物"],教育:["learn","course","education","study","教育","学习"],娱乐:["game","entertainment","movie","music","游戏","电影","音乐"],社交:["social","community","forum","社区","论坛"]};for(const[f,U]of Object.entries(v))if(U.some(_=>a.includes(_)))return f;return null},M=s=>{try{const a=new URL(s).hostname;return a.split(".")[0].charAt(0).toUpperCase()+a.split(".")[0].slice(1)}catch{return s}},H=s=>{try{const a=new URL(s).hostname;return{title:M(s),icon:`https://www.google.com/s2/favicons?domain=${s}`,suggestedCategory:F(a)}}catch{throw new Error("无效的URL格式")}},F=s=>{const a={github:"开发工具",stackoverflow:"开发工具",youtube:"视频",bilibili:"视频",google:"搜索",baidu:"搜索",zhihu:"社交",weibo:"社交",twitter:"社交",facebook:"社交",instagram:"社交",amazon:"购物",taobao:"购物",jd:"购物"};for(const[v,f]of Object.entries(a))if(s.includes(v))return f;return"其他"},I=s=>{s.preventDefault();const a=h.url.toLowerCase().replace(/\/$/,"");if(d.some(f=>f.url.toLowerCase().replace(/\/$/,"")===a)){t(!0),x("该URL已存在于您的书签中");return}i(h),u()};return e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"add-bookmark-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"添加新书签"}),e.jsx("button",{className:"close-button",onClick:u,children:"×"})]}),e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"网址"}),e.jsxs("div",{className:"url-input-container",children:[e.jsx("input",{type:"url",value:c,onChange:s=>m(s.target.value),placeholder:"输入网站地址",required:!0}),e.jsx("button",{type:"button",className:"analyze-button",onClick:l,disabled:p||!c,children:"分析"})]})]}),p&&e.jsxs("div",{className:"analysis-status",children:[e.jsx("h3",{children:"正在分析网站..."}),e.jsx("div",{className:"analysis-steps",children:["开始分析","验证URL格式","获取网站元数据","处理分析结果","分析完成"].map((s,a)=>e.jsxs("div",{className:`analysis-step ${y===s?"active":""} ${["开始分析","验证URL格式","获取网站元数据","处理分析结果"].indexOf(s)<["开始分析","验证URL格式","获取网站元数据","处理分析结果"].indexOf(y)?"complete":""}`,children:[e.jsx("div",{className:"step-indicator",children:a+1}),e.jsx("div",{className:"step-label",children:s})]},a))})]}),C&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:"该URL已存在于您的书签中"}),e.jsx("p",{className:"error-tip",children:"提示：您可以在书签列表中查找此网站。"})]}),o&&!C&&e.jsxs("div",{className:"analysis-error",children:[e.jsx("p",{children:o}),e.jsx("p",{className:"error-tip",children:"提示：请检查网址是否正确，或稍后再试。"})]}),b&&e.jsxs("form",{onSubmit:I,className:"bookmark-form",children:[e.jsx("h3",{children:"书签信息"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:h.name,onChange:s=>g(a=>({...a,name:s.target.value})),placeholder:"书签名称",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:h.category,onChange:s=>g(a=>({...a,category:s.target.value})),onFocus:()=>S(!0),placeholder:"选择或输入新分类",required:!0}),k&&D.length>0&&e.jsx("div",{className:"category-dropdown",children:D.map((s,a)=>e.jsx("div",{className:`category-option ${h.category===s?"selected":""}`,onClick:()=>{g(v=>({...v,category:s})),S(!1)},children:s},a))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标"}),e.jsxs("div",{className:"icon-preview",children:[h.icon&&e.jsx("img",{src:h.icon,alt:"网站图标"}),e.jsx("input",{type:"text",value:h.icon,onChange:s=>g(a=>({...a,icon:s.target.value})),placeholder:"图标URL"})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:u,children:"取消"}),e.jsx("button",{type:"submit",className:"submit-button",children:"添加书签"})]})]})]})]})})}function V({bookmark:u,onClose:i,onSubmit:d}){const{list:c}=z(),[m,h]=n.useState({name:u.name,category:u.category,icon:u.icon}),[g,p]=n.useState([]),[j,y]=n.useState(!1);n.useEffect(()=>{if(c&&c.length>0){const o=[...new Set(c.map(x=>x.category).filter(Boolean))];p(o)}},[c]);const r=o=>{o.preventDefault(),d({...u,...m})};return e.jsx("div",{className:"modal-overlay",children:e.jsxs("div",{className:"add-bookmark-modal",children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"编辑书签"}),e.jsx("button",{className:"close-button",onClick:i,children:"×"})]}),e.jsx("div",{className:"modal-content",children:e.jsxs("form",{onSubmit:r,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"名称"}),e.jsx("input",{type:"text",value:m.name,onChange:o=>h({...m,name:o.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"图标 URL"}),e.jsxs("div",{className:"icon-input-container",children:[e.jsx("input",{type:"text",value:m.icon,onChange:o=>h({...m,icon:o.target.value}),placeholder:"输入图标 URL"}),m.icon&&e.jsx("div",{className:"icon-preview",children:e.jsx("img",{src:m.icon,alt:"图标预览",onError:o=>o.target.src="/fallback-icon.svg"})})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"分类"}),e.jsxs("div",{className:"category-select-container",children:[e.jsx("input",{type:"text",value:m.category,onChange:o=>h({...m,category:o.target.value}),onFocus:()=>y(!0),placeholder:"选择或输入新分类"}),j&&g.length>0&&e.jsx("div",{className:"category-dropdown",children:g.map(o=>e.jsx("div",{className:`category-option ${o===m.category?"selected":""}`,onClick:()=>{h({...m,category:o}),y(!1)},children:o},o))})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-button",onClick:i,children:"取消"}),e.jsx("button",{type:"submit",className:"submit-button",children:"保存修改"})]})]})})]})})}function X({message:u,type:i="success",onClose:d,duration:c=3e3}){return n.useEffect(()=>{const m=setTimeout(()=>{d()},c);return()=>clearTimeout(m)},[c,d]),e.jsxs("div",{className:`notification notification-${i}`,children:[e.jsx("span",{className:"notification-icon",children:i==="success"?"✓":"✕"}),e.jsx("span",{className:"notification-message",children:u})]})}function Y({onRestore:u,onNotify:i}){const[d,c]=n.useState([]),[m,h]=n.useState(!1),[g,p]=n.useState(new Set),j=async()=>{h(!0);try{const{data:r}=await w.from("bookmark_history").select("restored_from_id").not("restored_from_id","is",null),o=new Set((r==null?void 0:r.map(N=>N.restored_from_id))||[]);p(o);const{data:x,error:b}=await w.from("bookmark_history").select("*").order("created_at",{ascending:!1});if(b)throw b;c(x)}catch(r){console.error("获取历史记录失败:",r),i==null||i({type:"error",message:"获取历史记录失败"})}finally{h(!1)}};n.useEffect(()=>{j()},[]);const y=async r=>{try{const{bookmark_data:o}=r,{error:x}=await w.from("bookmark").insert([o]);if(x)throw x;const{error:b}=await w.from("bookmark_history").insert([{action:"restore",bookmark_id:o.id,bookmark_data:o,restored_from_id:r.id}]);if(b)throw b;i==null||i({type:"success",message:"书签恢复成功"}),u==null||u(),j()}catch(o){console.error("恢复书签失败:",o),i==null||i({type:"error",message:"恢复书签失败"})}};return e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"操作历史"}),e.jsx("span",{className:"history-count",children:m?"加载中...":`${d.length} 条记录`})]}),m?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载历史记录..."})]}):e.jsx("div",{className:"history-list",children:d.map(r=>e.jsxs("div",{className:"history-item",children:[e.jsxs("div",{className:"history-content",children:[e.jsxs("span",{className:"history-action",children:[r.action==="add"&&"添加了",r.action==="delete"&&"删除了",r.action==="update"&&"修改了",r.action==="restore"&&"恢复了"]}),e.jsx("span",{className:"history-name",children:r.bookmark_data.name}),e.jsx("span",{className:"history-time",children:J(new Date(r.created_at),{addSuffix:!0,locale:K})})]}),r.action==="delete"&&!g.has(r.id)&&e.jsx("button",{className:"restore-button",onClick:()=>y(r),children:"恢复"})]},r.id))})]})}function oe(){const[u,i]=n.useState(!0),{list:d,fetchBookmarks:c}=z();n.useEffect(()=>{(async()=>{i(!0),await c(),i(!1)})()},[]);const[m,h]=n.useState(!1),[g,p]=n.useState(null),j=t=>{navigator.clipboard.writeText(t).then(()=>{p({type:"success",message:"URL已复制到剪贴板"})}).catch(()=>{p({type:"error",message:"复制失败，请手动复制"})})},y=async t=>{try{const l=Date.now()+Math.floor(Math.random()*1e3),L={...t,id:l,create_at:new Date().toISOString()},{error:R}=await w.from("bookmark").insert([L]).select();if(R)throw R;await C("add",L),p({type:"success",message:"成功添加书签"}),c()}catch(l){console.log(l),p({type:"error",message:"添加书签失败，请稍后重试"})}},r=async t=>{try{const{error:l}=await w.from("bookmark").delete().eq("url",t.url);if(l)throw l;await C("delete",t),p({type:"success",message:"成功删除书签"}),c()}catch(l){console.error(l),p({type:"error",message:"删除书签失败"})}},[o,x]=n.useState(!1),[b,N]=n.useState(null),D=t=>{N(t),x(!0)},q=async t=>{try{const{error:l}=await w.from("bookmark").update({name:t.name,category:t.category,icon:t.icon}).eq("url",t.url);if(l)throw l;await C("update",t),p({type:"success",message:"成功更新书签"}),c()}catch(l){console.error(l),p({type:"error",message:"更新书签失败"})}x(!1),N(null)},[k,S]=n.useState(!1),C=async(t,l)=>{try{await w.from("bookmark_history").insert([{action:t,bookmark_id:l.id,bookmark_data:l}])}catch(L){console.error("记录历史失败:",L)}};return e.jsxs("div",{className:"dashboard",children:[e.jsxs("div",{className:"dashboard-tabs",children:[e.jsx("button",{className:`tab-button ${k?"":"active"}`,onClick:()=>S(!1),children:"书签列表"}),e.jsx("button",{className:`tab-button ${k?"active":""}`,onClick:()=>S(!0),children:"操作历史"})]}),e.jsx("div",{className:"dashboard-content",children:k?e.jsx(Y,{onRestore:c,onNotify:p}):e.jsxs("div",{className:"list-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"书签列表"}),e.jsxs("div",{className:"header-actions",children:[e.jsxs("button",{className:"add-button",onClick:()=>h(!0),children:[e.jsx("span",{className:"button-icon",children:"+"}),"添加书签"]}),e.jsx("span",{className:"bookmark-count",children:u?"加载中...":`${d.length} 个书签`})]})]}),u?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载书签..."})]}):e.jsx("div",{className:"bookmark-list",children:d.map(t=>e.jsxs("div",{className:"bookmark-item",children:[e.jsx("div",{className:"bookmark-icon-wrapper",children:e.jsx("img",{"data-name":t.name,"data-category":t.category,src:t.icon,alt:"",className:"bookmark-icon",loading:"lazy",onError:l=>{l.target.src="/fallback-icon.svg"}})}),e.jsxs("div",{className:"bookmark-info",children:[e.jsx("h3",{children:t.name}),e.jsx("p",{className:"category-tag",children:t.category}),e.jsxs("div",{className:"url-container",children:[e.jsx("a",{href:t.url,target:"_blank",rel:"noopener noreferrer",children:t.url}),e.jsx("button",{className:"copy-button",onClick:l=>{l.preventDefault(),j(t.url)},title:"复制URL",children:"📋"})]})]}),e.jsxs("div",{className:"bookmark-actions",children:[e.jsx("button",{className:"edit-button",onClick:()=>D(t),title:"编辑书签",children:"✏️"}),e.jsx("button",{className:"delete-button",onClick:()=>r(t),title:"删除书签",children:e.jsx("span",{className:"delete-icon",children:"×"})})]})]},t.url))})]})}),m&&e.jsx(Q,{onClose:()=>h(!1),onSubmit:y}),o&&b&&e.jsx(V,{bookmark:b,onClose:()=>{x(!1),N(null)},onSubmit:q}),g&&e.jsx(X,{type:g.type,message:g.message,onClose:()=>p(null)})]})}export{oe as default};
