import{j as m}from"./index-DAyOjNCA.js";import{b as l}from"./vendor-D6FSTBK7.js";import F from"./TimerHeader-Dye-Qyhq.js";import O from"./ModeIndicator-Crqq01s_.js";import M from"./TimerDisplay-CjDCTwyj.js";import C from"./TimerControls-B4cYbdy0.js";import B from"./SettingsPanel-ByqCis9K.js";import L from"./TimerTips-kGQ854W5.js";import P from"./RecordsPanel-DHCFGnPU.js";import J from"./GoalProgress-BHQWlrrh.js";import{M as x}from"./index-BfZ8soR8.js";import"./utils-B-ph8sPT.js";import"./SettingsIcon-CTVTnelp.js";import"./RecordButton-CP5E4sS7.js";function q(o,d){const[u,p]=l.useState(!1),[i,w]=l.useState("focus"),[n,a]=l.useState(o.focusTime*60),[t,c]=l.useState({...o,soundOption:o.soundOption||"bell"}),[g,R]=l.useState(0),[r,f]=l.useState(null),[T,S]=l.useState(0),v=l.useRef(null),[h,k]=l.useState(!1);l.useEffect(()=>{const e={bell:"/sounds/bell.mp3",complete:"/sounds/complete.mp3",meditation:"/sounds/meditation-bell.mp3"};return v.current=new Audio(e[t.soundOption]),()=>{v.current&&(v.current.pause(),v.current=null)}},[t.soundOption]),l.useEffect(()=>{u&&i==="focus"&&!r&&f(new Date)},[u,i,r]),l.useEffect(()=>{"Notification"in window&&(Notification.permission==="granted"?k(!0):Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{k(e==="granted")}))},[]),l.useEffect(()=>{let e=null;if(u&&n>0)e=setInterval(()=>{if(a(n-1),i==="focus"&&S(s=>s+1/60),n===30){const s=new Audio("/sounds/reminder.mp3");s.volume=t.volume||.5,s.play()}},1e3);else if(u&&n===0){if(v.current&&(v.current.volume=t.volume||1,v.current.play()),h){const s=i==="focus"?"专注时间结束！":i==="break"?"休息时间结束！":"长休息时间结束！",y=i==="focus"?"休息一下吧！":"准备开始新的专注时间";new Notification(s,{body:y,icon:"/favicon.ico"})}if(i==="focus"){const s=g+1;R(s),s%t.longBreakInterval===0?(w("longBreak"),a(t.longBreakTime*60)):(w("break"),a(t.breakTime*60))}else{if(d&&r){const s={focusTime:Math.round(T),cycles:g,mode:i,duration:Math.round((new Date-r)/1e3/60)};d(s),f(null),S(0)}w("focus"),a(t.focusTime*60)}}return()=>clearInterval(e)},[u,n,i,g,t,h,d,r,T]);const b=e=>{const s=Math.floor(e/60),y=e%60;return`${s.toString().padStart(2,"0")}:${y.toString().padStart(2,"0")}`},N=()=>{const e=i==="focus"?t.focusTime*60:i==="break"?t.breakTime*60:t.longBreakTime*60;return(e-n)/e*100},j=()=>{p(!u)},D=()=>{p(!1),w("focus"),a(t.focusTime*60),f(null),S(0),i==="focus"&&r&&T>0&&d&&d({focusTime:Math.round(T),cycles:g,mode:i,completed:!1,startTime:r,endTime:new Date})},E=e=>{c(e),u||(i==="focus"?a(e.focusTime*60):i==="break"?a(e.breakTime*60):i==="longBreak"&&a(e.longBreakTime*60))},I=()=>{"Notification"in window&&Notification.permission!=="denied"&&Notification.requestPermission().then(e=>{k(e==="granted")})};return l.useEffect(()=>{const e=()=>{const y={mode:i,timeLeft:n,cycles:g,totalFocusTime:T,isRunning:!1,timestamp:new Date().toISOString()};localStorage.setItem("reading-timer-state",JSON.stringify(y))},s=setInterval(e,5e3);return window.addEventListener("beforeunload",e),()=>{clearInterval(s),window.removeEventListener("beforeunload",e)}},[i,n,g,T]),l.useEffect(()=>{const e=localStorage.getItem("reading-timer-state");if(console.log(e),e)try{const s=JSON.parse(e),y=new Date(s.timestamp);new Date-y<30*60*1e3?(w(s.mode),a(s.timeLeft),R(s.cycles),S(s.totalFocusTime)):localStorage.removeItem("reading-timer-state")}catch(s){console.error("恢复计时器状态失败",s),localStorage.removeItem("reading-timer-state")}},[]),{isRunning:u,mode:i,timeLeft:n,settings:t,cycles:g,totalFocusTime:T,formatTime:b,calculateProgress:N,toggleTimer:j,resetTimer:D,updateSettings:E,notificationsEnabled:h,requestNotificationPermission:I}}function A(){const[o,d]=l.useState(()=>{const n=localStorage.getItem("reading-timer-records");return n?JSON.parse(n):[]});return l.useEffect(()=>{localStorage.setItem("reading-timer-records",JSON.stringify(o))},[o]),{records:o,addRecord:n=>{const a={...n,id:Date.now(),timestamp:new Date().toISOString()};d(t=>[a,...t])},clearRecords:()=>{window.confirm("确定要清除所有阅读记录吗？此操作不可恢复。")&&d([])},deleteRecord:n=>{d(a=>a.filter(t=>t.id!==n))},getStats:()=>{if(o.length===0)return{totalFocusTime:0,totalSessions:0,totalCycles:0,averageFocusTime:0,lastWeekFocusTime:0,todayFocusTime:0};const n=o.reduce((r,f)=>r+(f.focusTime||0),0),a=new Date,t=new Date(a.getFullYear(),a.getMonth(),a.getDate()).getTime(),c=new Date(t-a.getDay()*864e5).getTime(),g=o.filter(r=>new Date(r.timestamp).getTime()>=t).reduce((r,f)=>r+(f.focusTime||0),0),R=o.filter(r=>new Date(r.timestamp).getTime()>=c).reduce((r,f)=>r+(f.focusTime||0),0);return{totalFocusTime:n,totalSessions:o.length,totalCycles:o.reduce((r,f)=>r+(f.cycles||0),0),averageFocusTime:Math.round(n/o.length),todayFocusTime:g,lastWeekFocusTime:R}}}}function se(){const[o,d]=l.useState(!1),[u,p]=l.useState(!1),{records:i,addRecord:w,clearRecords:n,deleteRecord:a,getStats:t}=A(),c=q({focusTime:25,breakTime:5,longBreakTime:15,longBreakInterval:4,soundOption:"bell",volume:1,dailyGoal:120},w),g=t(),R=()=>{d(!o),c.isRunning&&!o&&c.toggleTimer(),p(!1)},r=()=>{p(!u),d(!1)},f=T=>{c.updateSettings(T),d(!1)};return l.useEffect(()=>{const T=S=>{S.code==="Space"&&!o&&!u&&(S.preventDefault(),c.toggleTimer()),S.code==="KeyR"&&!o&&!u&&c.resetTimer(),S.code==="Escape"&&(o&&d(!1),u&&p(!1))};return window.addEventListener("keydown",T),()=>window.removeEventListener("keydown",T)},[c,o,u]),m.jsxs("div",{className:"reading-timer-container",children:[m.jsxs("div",{className:"timer-layout",children:[m.jsx("div",{className:"timer-main",children:m.jsxs("div",{className:"timer-card",children:[m.jsx(F,{onSettingsClick:R,onRecordsClick:r}),m.jsx(O,{mode:c.mode,cycles:c.cycles}),m.jsx(M,{timeText:c.formatTime(c.timeLeft),progress:c.calculateProgress()}),m.jsx(C,{isRunning:c.isRunning,onToggle:c.toggleTimer,onReset:c.resetTimer})]})}),m.jsxs("div",{className:"timer-sidebar",children:[m.jsx(J,{current:g.todayFocusTime||0,goal:c.settings.dailyGoal}),m.jsx(L,{})]})]}),m.jsx(x,{isOpen:o,onClose:()=>d(!1),title:"计时器设置",size:"md",children:m.jsx(B,{settings:c.settings,onCancel:()=>d(!1),onApply:f})}),m.jsx(x,{isOpen:u,onClose:()=>p(!1),title:"阅读记录",size:"lg",children:m.jsx(P,{records:i,stats:g,onClear:n,onDelete:a,onClose:()=>p(!1)})}),m.jsx("div",{className:"keyboard-shortcuts",children:m.jsx("p",{children:"快捷键: 空格键 = 开始/暂停, R = 重置, ESC = 关闭面板"})})]})}export{se as default};
