import{j as a,E as R}from"./index-BmLeWc0L.js";import{r as m,a as _}from"./vendor-DS5US8IS.js";import{J as T}from"./jszip.min-BqXeSWwb.js";/* empty css                     */import{M as x}from"./index-DRmIebEN.js";import{C as X}from"./styles-C6Qr21A4.js";import q from"./CacheManager-Bv_DuHkr.js";import"./utils-BxBsLso0.js";/* empty css              */const O=({children:t,beforeUpload:n,disabled:o,accept:l})=>{const s=m.useRef(null),[h,c]=m.useState(!1),p=i=>{i.preventDefault(),o||c(!0)},C=()=>{c(!1)},f=i=>{if(i.preventDefault(),o)return;c(!1);const j=i.dataTransfer.files;j.length>0&&S(j[0])},N=()=>{!o&&s.current&&s.current.click()},E=i=>{const j=i.target.files;j.length>0&&S(j[0])},S=i=>{n&&n(i),s.current&&(s.current.value="")};return a.jsxs("div",{className:`upload-dragger ${h?"dragging":""} ${o?"disabled":""}`,onDragOver:p,onDragLeave:C,onDrop:f,onClick:N,children:[a.jsx("input",{type:"file",ref:s,style:{display:"none"},onChange:E,disabled:o,accept:l}),t]})},Z={Dragger:O},K=({percent:t,status:n="normal",showInfo:o=!0,strokeColor:l})=>{const s=Math.min(Math.max(0,t||0),100),c=n!=="normal"?n:s>=100?"success":"normal";return a.jsxs("div",{className:"progress-component",children:[a.jsx("div",{className:"progress-outer",children:a.jsx("div",{className:`progress-inner ${c}`,style:{width:`${s}%`,backgroundColor:l}})}),o&&a.jsxs("span",{className:"progress-text",children:[s,"%"]})]})},U=({color:t="#1890ff",size:n=24})=>a.jsx("svg",{viewBox:"0 0 24 24",width:n,height:n,fill:"currentColor",style:{color:t},children:a.jsx("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-7-2h2v-2h-2v2zm-4 0h2v-2H8v2zm8 0h2v-2h-2v2zm-8-4h8v-6H8v6z"})}),V="AppleHealthDB",u="healthData",J=1,k=()=>new Promise((t,n)=>{const o=indexedDB.open(V,J);o.onerror=()=>{n(new Error("无法打开数据库"))},o.onsuccess=l=>{t(l.target.result)},o.onupgradeneeded=l=>{const s=l.target.result;s.objectStoreNames.contains(u)||s.createObjectStore(u,{keyPath:"id"}).createIndex("timestamp","timestamp",{unique:!1})}}),M=async t=>`${t.name}-${t.size}-${t.lastModified}`,Y=async(t,n)=>{try{const o=await k(),l=await M(t);return await o.transaction([u],"readwrite").objectStore(u).put({id:l,data:n,fileName:t.name,fileSize:t.size,timestamp:new Date().getTime()}),l}catch(o){throw console.error("保存缓存数据失败:",o),o}},G=async t=>{try{const n=await k(),o=await M(t),s=n.transaction([u],"readonly").objectStore(u);return new Promise((h,c)=>{const p=s.get(o);p.onsuccess=C=>{const f=C.target.result;h(f||null)},p.onerror=()=>{c(new Error("读取缓存数据失败"))}})}catch(n){return console.error("加载缓存数据失败:",n),null}},Q=async()=>{try{const l=(await k()).transaction([u],"readonly").objectStore(u).index("timestamp");return new Promise((s,h)=>{const c=l.getAll();c.onsuccess=p=>{s(p.target.result)},c.onerror=()=>{h(new Error("获取缓存列表失败"))}})}catch(t){return console.error("获取缓存列表失败:",t),[]}},ee=async t=>{try{const l=(await k()).transaction([u],"readwrite").objectStore(u);return new Promise((s,h)=>{const c=l.delete(t);c.onsuccess=()=>{s(!0)},c.onerror=()=>{h(new Error("删除缓存数据失败"))}})}catch(n){throw console.error("删除缓存数据失败:",n),n}},re=async()=>{try{const o=(await k()).transaction([u],"readwrite").objectStore(u);return new Promise((l,s)=>{const h=o.clear();h.onsuccess=()=>{l(!0)},h.onerror=()=>{s(new Error("清除所有缓存数据失败"))}})}catch(t){throw console.error("清除所有缓存数据失败:",t),t}};function ue(){const t=_(),[n,o]=m.useState(!1),[l,s]=m.useState(0),[h,c]=m.useState(""),[p,C]=m.useState([]),[f,N]=m.useState(!1),[E,S]=m.useState([]),i=m.useRef(null),j=m.useRef(null);m.useEffect(()=>{$()},[]);const v=e=>{S(r=>[...r,{time:new Date().toLocaleTimeString(),message:e}])},$=async()=>{try{const e=await Q();C(e)}catch(e){console.error("加载缓存列表失败:",e)}},L=async e=>{if(e.type!=="application/zip"&&!e.name.endsWith(".zip"))return x.error("请上传 Apple Health 导出的 zip 文件"),!1;j.current=e;try{o(!0),s(0),c("检查缓存数据...");const r=await G(e);if(r)return await b(r),!1;await W(e)}catch(r){console.error("处理健康数据文件失败:",r),x.error(`处理文件失败: ${r.message}`)}finally{o(!1)}return!1},W=async e=>{s(0),c("正在解压文件..."),S([]),console.log(`开始处理文件: ${e.name}, 大小: ${Math.round(e.size/1024)} KB`),v(`开始处理文件: ${e.name}, 大小: ${Math.round(e.size/1024)} KB`);const r=new T;try{const d=await r.loadAsync(e);console.log("ZIP 文件加载成功，查找 XML 文件");const D=Object.keys(d.files);console.log("ZIP 内文件列表:",D);const w=z(d);if(!w)throw console.error("未找到 export.xml 文件"),new Error("未找到健康数据导出文件（export.xml 或 导出.xml）");console.log("找到 XML 文件，开始读取内容"),c("正在读取 XML 数据...");const y=await w.async("string");console.log(`XML 内容读取完成，大小约 ${Math.round(y.length/1024)} KB`),d.forEach((te,B)=>{B._data=null});const g=await I(y);return await P(e,g),g}catch(d){throw console.error("处理健康数据文件时发生错误:",d),d}},z=e=>{let r=null;return e.forEach((d,D)=>{(d.endsWith("export.xml")||d.endsWith("导出.xml")||d==="apple_health_export/导出.xml"||d==="apple_health_export/export.xml")&&(r=D)}),r},I=async e=>{i.current&&i.current.terminate(),console.log("创建新的 Worker 实例"),v("创建新的 Worker 实例"),i.current=new Worker(new URL("/assets/xmlWorker-D_v9IhBB.js",import.meta.url),{type:"module"});try{return await new Promise((d,D)=>{i.current.onmessage=w=>{const{type:y,data:g}=w.data;console.log(`收到 Worker 消息: ${y}`),v(`收到 Worker 消息: ${y}`),y==="result"?(console.log("处理完成，收到结果数据"),v("处理完成，收到结果数据"),d(g)):y==="progress"?(s(g.progress),c(g.message)):y==="error"&&(console.error("Worker 处理错误:",g.message),v(`错误: ${g.message}`),D(new Error(g.message)))},i.current.onerror=w=>{console.error("Worker 错误:",w),v(`Worker 错误: ${w.message}`),D(w)},console.log("发送数据到 Worker 处理"),v("发送数据到 Worker 处理"),i.current.postMessage({xmlContent:e})})}finally{i.current&&(i.current.terminate(),i.current=null)}},P=async(e,r)=>{try{c("正在保存数据..."),await Y(e,r),c("数据处理完成"),s(100),await $(),x.success("健康数据处理完成"),t("/data-visual",{state:{data:r}})}catch(d){throw console.error("保存结果失败:",d),d}},b=async e=>{try{c("从缓存加载数据..."),s(50),setTimeout(()=>{s(100),c("数据加载完成"),x.success("从缓存加载数据成功"),t("/data-visual",{state:{data:e.data}})},500)}catch(r){throw console.error("从缓存加载数据失败:",r),r}},F=async e=>{try{o(!0),s(0),c("正在加载缓存数据...");const r=p.find(d=>d.id===e);if(!r)throw new Error("未找到缓存数据");N(!1),await b(r)}catch(r){console.error("加载缓存数据失败:",r),x.error(`加载缓存数据失败: ${r.message}`)}finally{o(!1)}},H=async e=>{try{await ee(e),await $(),x.success("缓存数据已删除")}catch(r){console.error("删除缓存数据失败:",r),x.error(`删除缓存数据失败: ${r.message}`)}},A=async()=>{try{await re(),await $(),x.success("所有缓存数据已清除")}catch(e){console.error("清除所有缓存数据失败:",e),x.error(`清除所有缓存数据失败: ${e.message}`)}};return a.jsx(R,{children:a.jsxs("div",{className:"apple-health-container",children:[a.jsx("div",{className:"header-actions",children:a.jsx("button",{className:"cache-manager-button",onClick:()=>N(!f),children:f?"关闭缓存管理":"缓存管理"})}),f&&a.jsx(q,{cachedFiles:p,onLoadCache:F,onDeleteCache:H,onClearAll:A,onClose:()=>N(!1)}),a.jsxs(X,{title:"上传 Apple Health 数据",className:"upload-card",children:[a.jsx(Z.Dragger,{beforeUpload:L,disabled:n,children:a.jsxs("div",{style:{padding:"20px 0"},children:[a.jsx("p",{className:"upload-icon",children:a.jsx(U,{})}),a.jsx("p",{className:"upload-text",children:"点击或拖拽文件到此区域上传"}),a.jsx("p",{className:"upload-hint",children:"支持从 Apple Health 应用导出的 ZIP 文件"})]})}),n&&a.jsxs("div",{className:"progress-container",children:[a.jsx(K,{percent:l}),a.jsx("span",{className:"progress-status",children:h})]}),E.length>0&&a.jsxs("div",{className:"logs-container",style:{marginTop:"20px",maxHeight:"200px",overflowY:"auto"},children:[a.jsx("h4",{children:"处理日志"}),E.map((e,r)=>a.jsxs("div",{className:"log-item",children:[a.jsxs("span",{className:"log-time",children:["[",e.time,"]"]}),a.jsx("span",{className:"log-message",children:e.message})]},r))]})]})]})})}export{ue as default};
