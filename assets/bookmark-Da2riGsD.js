import{s,h as n}from"./index-Bw44camO.js";function h(t){var e=t,r={};for(const c of e)if("category"in c){var o=c.category;o in r?r[o].push(c):r[o]=[c]}var a=Object.entries(r);return l(a,!1)}function l(t,e=!0){return t.sort((r,o)=>e?r[0][0].localeCompare(o[0][0]):o[0][0].localeCompare(r[0][0]))}const m={async fetchAll(){try{const{data:t,error:e}=await s.from("bookmark").select("*").order("create_at",{ascending:!1});if(e)throw e;return t}catch(t){throw new Error(n(t))}},async create(t){try{const e=Date.now()+Math.floor(Math.random()*1e3),r={...t,id:e,create_at:new Date().toISOString()},{data:o,error:a}=await s.from("bookmark").insert([r]).select();if(a)throw a;return await this.recordHistory("add",r),o[0]}catch(e){throw new Error(n(e))}},async update(t){try{const{data:e,error:r}=await s.from("bookmark").update({name:t.name,category:t.category,icon:t.icon}).eq("url",t.url).select();if(r)throw r;return await this.recordHistory("update",t),e[0]}catch(e){throw new Error(n(e))}},async delete(t){try{const{data:e,error:r}=await s.from("bookmark").delete().eq("url",t.url).select();if(r)throw r;return await this.recordHistory("delete",t),e}catch(e){throw new Error(n(e))}},async recordHistory(t,e){try{const{error:r}=await s.from("bookmark_history").insert([{action:t,bookmark_id:e.id,bookmark_data:e}]);if(r)throw r}catch(r){console.error("记录历史失败:",r)}},async fetchBookmarksWithViews(){try{const{data:t,error:e}=await s.from("bookmark").select("*");if(e)throw e;const{data:r,error:o}=await s.from("category_views").select("*");if(o)throw o;const a=new Map((r==null?void 0:r.map(i=>[i.category,i.view_count]))||[]);return{list:h(t).sort((i,w)=>{const d=a.get(i[0])||0;return(a.get(w[0])||0)-d}),viewsMap:a}}catch(t){throw new Error(n(t))}}};export{m as b};
