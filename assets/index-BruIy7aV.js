import{s as L,h as b,j as e,L as C}from"./index-CGDsmW8e.js";import{b as i}from"./vendor-D6FSTBK7.js";import{LogFilters as S}from"./LogFilters-DcGSfhj4.js";import{LogItem as k}from"./LogItem-BoglMBCA.js";import{DeleteConfirmModal as D}from"./DeleteConfirmModal-C8T6hE5Z.js";import{LogTable as E}from"./LogTable-hUC3vpy8.js";import"./utils-B-ph8sPT.js";import"./index-CNVjL9gr.js";import"./index-CqQlImbu.js";import"./zh-CN-BsVeUFFo.js";const j={async fetchLogs({environment:s,startDate:o,endDate:l,searchTerm:r,limit:m=100}){try{let t=L.from("error_logs").select("*").order("timestamp",{ascending:!1});s&&(t=t.eq("environment",s)),o&&(t=t.gte("timestamp",o)),l&&(t=t.lte("timestamp",l)),r&&(t=t.or(`error.ilike.%${r}%,component_info.ilike.%${r}%`));const{data:d,error:h}=await t.limit(m);if(h)throw h;return d}catch(t){throw new Error(b(t))}},async deleteLogs(s){try{const{error:o}=await L.from("error_logs").delete().lt("timestamp",s);if(o)throw o}catch(o){throw new Error(b(o))}},async exportLogs(s){const o=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...s.map(r=>[new Date(r.timestamp).toLocaleString(),r.environment,r.component_info,`"${r.error.replace(/"/g,'""')}"`,r.url,`"${r.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([o],{type:"text/csv;charset=utf-8;"})}};function N(){const[s,o]=i.useState([]),[l,r]=i.useState(!0),[m,t]=i.useState(null),[d,h]=i.useState({environment:"",startDate:"",endDate:"",searchTerm:""}),u=[...new Set(s.map(a=>a.environment))],c=i.useCallback(async()=>{try{r(!0);const a=await j.fetchLogs(d);o(a),t(null)}catch(a){t(a.message)}finally{r(!1)}},[d]);i.useEffect(()=>{c()},[c]);const x=i.useCallback((a,w)=>{h(p=>({...p,[a]:w}))},[]);return{logs:s,isLoading:l,error:m,setError:t,filters:d,environments:u,updateFilter:x,fetchLogs:c}}function q(){const{logs:s,isLoading:o,error:l,filters:r,environments:m,updateFilter:t,fetchLogs:d,setError:h}=N(),[u,c]=i.useState(!1),[x,a]=i.useState(30),w=async()=>{const n=await j.exportLogs(s),y=window.URL.createObjectURL(n),g=document.createElement("a");g.href=y,g.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(g),g.click(),window.URL.revokeObjectURL(y),document.body.removeChild(g)},p=async()=>{try{const n=new Date;n.setDate(n.getDate()-x),await j.deleteLogs(n.toISOString()),c(!1),d()}catch(n){console.error("Error deleting logs:",n),h(n.message||"删除日志失败"),c(!1)}},[f,v]=i.useState("card");return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"error-logs",children:[e.jsxs("div",{className:"section-header",children:[e.jsxs("div",{className:"section-header-main",children:[e.jsx("h2",{children:"错误日志"}),e.jsxs("div",{className:"view-toggle",children:[e.jsx("button",{className:`view-toggle-btn ${f==="card"?"active":""}`,onClick:()=>v("card"),title:"卡片视图",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"3",width:"7",height:"7"}),e.jsx("rect",{x:"3",y:"14",width:"7",height:"7"}),e.jsx("rect",{x:"14",y:"14",width:"7",height:"7"})]})}),e.jsx("button",{className:`view-toggle-btn ${f==="table"?"active":""}`,onClick:()=>v("table"),title:"表格视图",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("line",{x1:"3",y1:"6",x2:"21",y2:"6"}),e.jsx("line",{x1:"3",y1:"12",x2:"21",y2:"12"}),e.jsx("line",{x1:"3",y1:"18",x2:"21",y2:"18"})]})})]})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("span",{className:"log-count",children:o?"加载中...":`${s.length} 条记录`}),e.jsxs("div",{className:"action-buttons",children:[e.jsx("button",{onClick:w,children:"导出日志"}),e.jsx("button",{className:"danger-outline",onClick:()=>c(!0),children:"删除历史日志"})]})]})]}),e.jsx(S,{filters:r,environments:m,onFilterChange:t}),l&&e.jsx("div",{className:"error-message",children:l}),o?e.jsx(C,{text:"正在加载错误日志..."}):e.jsx(e.Fragment,{children:f==="card"?e.jsx("div",{className:"logs-list",children:s.length>0?s.map(n=>e.jsx(k,{log:n},n.id)):e.jsx("div",{className:"no-logs",children:e.jsx("p",{children:"没有找到符合条件的错误日志"})})}):e.jsx(E,{logs:s})}),e.jsx(D,{isOpen:u,onClose:()=>c(!1),onConfirm:p,deleteDate:x,onDateChange:a})]})})}export{q as default};
