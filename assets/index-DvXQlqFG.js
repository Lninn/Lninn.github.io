import{s as f,h as N,j as e}from"./index-OhoAZCMB.js";import{b as d}from"./vendor-C_ovgAfI.js";import{f as w}from"./utils-CWHH1IbV.js";import{z as L}from"./zh-CN-CCt-M6vz.js";import{M as b}from"./index-2B52fpWP.js";const x={async fetchLogs({environment:s,startDate:n,endDate:a,searchTerm:t,limit:c=100}){try{let r=f.from("error_logs").select("*").order("timestamp",{ascending:!1});s&&(r=r.eq("environment",s)),n&&(r=r.gte("timestamp",n)),a&&(r=r.lte("timestamp",a)),t&&(r=r.or(`error.ilike.%${t}%,component_info.ilike.%${t}%`));const{data:l,error:m}=await r.limit(c);if(m)throw m;return l}catch(r){throw new Error(N(r))}},async deleteLogs(s){try{const{error:n}=await f.from("error_logs").delete().lt("timestamp",s);if(n)throw n}catch(n){throw new Error(N(n))}},async exportLogs(s){const n=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...s.map(t=>[new Date(t.timestamp).toLocaleString(),t.environment,t.component_info,`"${t.error.replace(/"/g,'""')}"`,t.url,`"${t.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([n],{type:"text/csv;charset=utf-8;"})}};function y(){const[s,n]=d.useState([]),[a,t]=d.useState(!0),[c,r]=d.useState(null),[l,m]=d.useState({environment:"",startDate:"",endDate:"",searchTerm:""}),h=[...new Set(s.map(i=>i.environment))],u=async()=>{try{t(!0);const i=await x.fetchLogs(l);n(i),r(null)}catch(i){r(i.message)}finally{t(!1)}};return d.useEffect(()=>{u()},[l]),{logs:s,isLoading:a,error:c,filters:l,environments:h,updateFilter:(i,g)=>{m(o=>({...o,[i]:g}))},fetchLogs:u}}function D({filters:s,environments:n,onFilterChange:a}){return e.jsxs("div",{className:"filters",children:[e.jsxs("select",{value:s.environment,onChange:t=>a("environment",t.target.value),children:[e.jsx("option",{value:"",children:"所有环境"}),n.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{type:"date",value:s.startDate,onChange:t=>a("startDate",t.target.value),placeholder:"开始日期"}),e.jsx("input",{type:"date",value:s.endDate,onChange:t=>a("endDate",t.target.value),placeholder:"结束日期"}),e.jsx("input",{type:"text",value:s.searchTerm,onChange:t=>a("searchTerm",t.target.value),placeholder:"搜索错误信息..."})]})}function S({log:s}){return e.jsxs("div",{className:"log-item",children:[e.jsxs("div",{className:"log-header",children:[e.jsx("span",{className:"log-time",children:w(new Date(s.timestamp),{addSuffix:!0,locale:L})}),e.jsx("span",{className:"log-environment",children:s.environment})]}),e.jsxs("div",{className:"log-content",children:[e.jsx("div",{className:"log-component",children:s.component_info}),e.jsx("div",{className:"log-message",children:s.error}),e.jsx("div",{className:"log-url",children:s.url})]}),e.jsx("div",{className:"log-footer",children:e.jsx("span",{className:"log-user-agent",children:s.user_agent})})]})}function C({isOpen:s,onClose:n,onConfirm:a,deleteDate:t,onDateChange:c}){const r=e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-button",onClick:n,children:"取消"}),e.jsx("button",{className:"confirm-button danger",onClick:a,children:"确认删除"})]});return e.jsx(b,{isOpen:s,onClose:n,title:"删除历史错误日志",size:"sm",footer:r,children:e.jsxs("div",{className:"delete-modal-content",children:[e.jsx("p",{children:"确定要删除多久以前的错误日志？"}),e.jsx("div",{className:"delete-date-selector",children:e.jsxs("select",{value:t,onChange:l=>c(Number(l.target.value)),children:[e.jsx("option",{value:7,children:"7天前"}),e.jsx("option",{value:30,children:"30天前"}),e.jsx("option",{value:90,children:"90天前"}),e.jsx("option",{value:180,children:"180天前"}),e.jsx("option",{value:365,children:"一年前"})]})}),e.jsx("p",{className:"delete-warning",children:"注意：此操作不可恢复，将永久删除所选时间之前的所有错误日志记录。"})]})})}function $(){const{logs:s,isLoading:n,error:a,filters:t,environments:c,updateFilter:r,fetchLogs:l}=y(),[m,h]=d.useState(!1),[u,j]=d.useState(30),i=async()=>{const o=await x.exportLogs(s),v=window.URL.createObjectURL(o),p=document.createElement("a");p.href=v,p.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(p),p.click(),window.URL.revokeObjectURL(v),document.body.removeChild(p)},g=async()=>{try{const o=new Date;o.setDate(o.getDate()-u),await x.deleteLogs(o.toISOString()),h(!1),l()}catch(o){console.error("Error deleting logs:",o)}};return e.jsxs("div",{className:"error-logs",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"错误日志"}),e.jsxs("div",{className:"header-actions",children:[e.jsx("span",{className:"log-count",children:n?"加载中...":`${s.length} 条记录`}),e.jsx("button",{onClick:i,children:"导出日志"}),e.jsx("button",{className:"danger-outline",onClick:()=>h(!0),children:"删除历史日志"})]})]}),e.jsx(D,{filters:t,environments:c,onFilterChange:r}),a&&e.jsx("div",{className:"error-message",children:a}),n?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载错误日志..."})]}):e.jsx("div",{className:"logs-list",children:s.length>0?s.map(o=>e.jsx(S,{log:o},o.id)):e.jsx("div",{className:"no-logs",children:e.jsx("p",{children:"没有找到符合条件的错误日志"})})}),e.jsx(C,{isOpen:m,onClose:()=>h(!1),onConfirm:g,deleteDate:u,onDateChange:j})]})}export{$ as default};
