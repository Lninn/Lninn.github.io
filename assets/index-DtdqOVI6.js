import{j as a,s as C}from"./index-CGDsmW8e.js";import{M as V}from"./index-CNVjL9gr.js";import{b as y}from"./vendor-D6FSTBK7.js";import{u as yt,N as bt}from"./useNotification-D_OS6ATU.js";import{S as xt}from"./index-CJJXqCDL.js";import{P as Nt}from"./index-HJiE_Ljx.js";import Lt from"./MapContainer-D9SbPnmo.js";import"./utils-B-ph8sPT.js";function L(t,e){return Array.from(t.getElementsByTagName(e))}function _(t){return t[0]==="#"?t:`#${t}`}function vt(t,e,n){return Array.from(t.getElementsByTagNameNS(n,e))}function g(t){return t==null||t.normalize(),(t==null?void 0:t.textContent)||""}function m(t,e,n){const r=t.getElementsByTagName(e);return r.length?r[0]:null}function v(t,e,n){const r={};if(!t)return r;const o=t.getElementsByTagName(e),i=o.length?o[0]:null;return i&&n?n(i,r):r}function S(t,e,n){const r=g(m(t,e));return r&&n?n(r)||{}:{}}function p(t,e,n){const r=Number.parseFloat(g(m(t,e)));if(!Number.isNaN(r))return n&&n(r),r}function F(t,e){const n={};for(const r of e)S(t,r,o=>{n[r]=o});return n}function Y(t){return(t==null?void 0:t.nodeType)===1}function Z(t,e){const n={},r=e==="stroke"||e==="fill"?e:`${e}-color`;return t[0]==="#"&&(t=t.substring(1)),t.length===6||t.length===3?n[r]=`#${t}`:t.length===8&&(n[`${e}-opacity`]=Number.parseInt(t.substring(0,2),16)/255,n[r]=`#${t.substring(6,8)}${t.substring(4,6)}${t.substring(2,4)}`),n}function R(t,e,n){const r={};return p(t,e,o=>{r[n]=o}),r}function z(t,e){return v(t,"color",n=>Z(g(n),e))}function Q(t){return v(t,"Icon",(e,n)=>(S(e,"href",r=>{n.icon=r}),n))}function Ot(t){return v(t,"IconStyle",e=>Object.assign(z(e,"icon"),R(e,"scale","icon-scale"),R(e,"heading","icon-heading"),v(e,"hotSpot",n=>{const r=Number.parseFloat(n.getAttribute("x")||""),o=Number.parseFloat(n.getAttribute("y")||""),i=n.getAttribute("xunits")||"",s=n.getAttribute("yunits")||"";return!Number.isNaN(r)&&!Number.isNaN(o)?{"icon-offset":[r,o],"icon-offset-units":[i,s]}:{}}),Q(e)))}function Tt(t){return v(t,"LabelStyle",e=>Object.assign(z(e,"label"),R(e,"scale","label-scale")))}function jt(t){return v(t,"LineStyle",e=>Object.assign(z(e,"stroke"),R(e,"width","stroke-width")))}function At(t){return v(t,"PolyStyle",(e,n)=>Object.assign(n,v(e,"color",r=>Z(g(r),"fill")),S(e,"fill",r=>{if(r==="0")return{"fill-opacity":0}}),S(e,"outline",r=>{if(r==="0")return{"stroke-opacity":0}})))}function G(t){return Object.assign({},At(t),jt(t),Tt(t),Ot(t))}const Pt=/\s*/g,St=/^\s*|\s*$/g,kt=/\s+/;function tt(t){return t.replace(Pt,"").split(",").map(Number.parseFloat).filter(e=>!Number.isNaN(e)).slice(0,3)}function U(t){return t.replace(St,"").split(kt).map(tt).filter(e=>e.length>=2)}function wt(t){let e=L(t,"coord");e.length===0&&(e=vt(t,"coord","*"));const n=e.map(r=>g(r).split(" ").map(Number.parseFloat));return n.length===0?null:{geometry:n.length>2?{type:"LineString",coordinates:n}:{type:"Point",coordinates:n[0]},times:L(t,"when").map(r=>g(r))}}function et(t){if(t.length===0)return t;const e=t[0],n=t[t.length-1];let r=!0;for(let o=0;o<Math.max(e.length,n.length);o++)if(e[o]!==n[o]){r=!1;break}return r?t:t.concat([t[0]])}function M(t){return g(m(t,"coordinates"))}function nt(t){let e=[],n=[];for(let r=0;r<t.childNodes.length;r++){const o=t.childNodes.item(r);if(Y(o))switch(o.tagName){case"MultiGeometry":case"MultiTrack":case"gx:MultiTrack":{const i=nt(o);e=e.concat(i.geometries),n=n.concat(i.coordTimes);break}case"Point":{const i=tt(M(o));i.length>=2&&e.push({type:"Point",coordinates:i});break}case"LinearRing":case"LineString":{const i=U(M(o));i.length>=2&&e.push({type:"LineString",coordinates:i});break}case"Polygon":{const i=[];for(const s of L(o,"LinearRing")){const c=et(U(M(s)));c.length>=4&&i.push(c)}i.length&&e.push({type:"Polygon",coordinates:i});break}case"Track":case"gx:Track":{const i=wt(o);if(!i)break;const{times:s,geometry:c}=i;e.push(c),s.length&&n.push(s);break}}}return{geometries:e,coordTimes:n}}const P=t=>Number(t),$={string:t=>t,int:P,uint:P,short:P,ushort:P,float:P,double:P,bool:t=>!!t};function q(t,e){return v(t,"ExtendedData",(n,r)=>{for(const o of L(n,"Data"))r[o.getAttribute("name")||""]=g(m(o,"value"));for(const o of L(n,"SimpleData")){const i=o.getAttribute("name")||"",s=e[i]||$.string;r[i]=s(g(o))}return r})}function H(t){const e=m(t,"description");for(const n of Array.from((e==null?void 0:e.childNodes)||[]))if(n.nodeType===4)return{description:{"@type":"html",value:g(n)}};return{}}function W(t){return v(t,"TimeSpan",e=>({timespan:{begin:g(m(e,"begin")),end:g(m(e,"end"))}}))}function K(t){return v(t,"TimeStamp",e=>({timestamp:g(m(e,"when"))}))}function J(t,e){return S(t,"styleUrl",n=>(n=_(n),e[n]?Object.assign({styleUrl:n},e[n]):{styleUrl:n}))}var d;(function(t){t.ABSOLUTE="absolute",t.RELATIVE_TO_GROUND="relativeToGround",t.CLAMP_TO_GROUND="clampToGround",t.CLAMP_TO_SEAFLOOR="clampToSeaFloor",t.RELATIVE_TO_SEAFLOOR="relativeToSeaFloor"})(d||(d={}));function Ct(t){switch(t==null?void 0:t.textContent){case d.ABSOLUTE:return d.ABSOLUTE;case d.CLAMP_TO_GROUND:return d.CLAMP_TO_GROUND;case d.CLAMP_TO_SEAFLOOR:return d.CLAMP_TO_SEAFLOOR;case d.RELATIVE_TO_GROUND:return d.RELATIVE_TO_GROUND;case d.RELATIVE_TO_SEAFLOOR:return d.RELATIVE_TO_SEAFLOOR}return null}function Et(t){return m(t,"gx:LatLonQuad")?{geometry:{type:"Polygon",coordinates:[et(U(M(t)))]}}:Rt(t)}const Mt=Math.PI/180;function _t(t,e,n){const r=[(t[0]+t[2])/2,(t[1]+t[3])/2];return[e[0].map(o=>{const i=o[1]-r[1],s=o[0]-r[0],c=Math.sqrt(i**2+s**2),u=Math.atan2(i,s)+n*Mt;return[r[0]+Math.cos(u)*c,r[1]+Math.sin(u)*c]})]}function Rt(t){const e=m(t,"LatLonBox");if(e){const n=p(e,"north"),r=p(e,"west"),o=p(e,"east"),i=p(e,"south"),s=p(e,"rotation");if(typeof n=="number"&&typeof i=="number"&&typeof r=="number"&&typeof o=="number"){const c=[r,i,o,n];let u=[[[r,n],[o,n],[o,i],[r,i],[r,n]]];return typeof s=="number"&&(u=_t(c,u,s)),{bbox:c,geometry:{type:"Polygon",coordinates:u}}}}return null}function Ft(t,e,n,r){var u;const o=Et(t),i=(o==null?void 0:o.geometry)||null;if(!i&&r.skipNullGeometry)return null;const s={type:"Feature",geometry:i,properties:Object.assign({"@geometry-type":"groundoverlay"},F(t,["name","address","visibility","open","phoneNumber","description"]),H(t),J(t,e),G(t),Q(t),q(t,n),W(t),K(t))};o!=null&&o.bbox&&(s.bbox=o.bbox),((u=s.properties)==null?void 0:u.visibility)!==void 0&&(s.properties.visibility=s.properties.visibility!=="0");const c=t.getAttribute("id");return c!==null&&c!==""&&(s.id=c),s}function Gt(t){const e=m(t,"Region");return e?{coordinateBox:Bt(e),lod:Dt(t)}:null}function Dt(t){const e=m(t,"Lod");return e?[p(e,"minLodPixels")??-1,p(e,"maxLodPixels")??-1,p(e,"minFadeExtent")??null,p(e,"maxFadeExtent")??null]:null}function Bt(t){const e=m(t,"LatLonAltBox");if(e){const n=p(e,"north"),r=p(e,"west"),o=p(e,"east"),i=p(e,"south");if(Ct(m(e,"altitudeMode")||m(e,"gx:altitudeMode"))&&console.debug("Encountered an unsupported feature of KML for togeojson: please contact developers for support of altitude mode."),typeof n=="number"&&typeof i=="number"&&typeof r=="number"&&typeof o=="number")return{bbox:[r,i,o,n],geometry:{type:"Polygon",coordinates:[[[r,n],[o,n],[o,i],[r,i],[r,n]]]}}}return null}function It(t){const e=m(t,"Link");return e?F(e,["href","refreshMode","refreshInterval","viewRefreshMode","viewRefreshTime","viewBoundScale","viewFormat","httpQuery"]):{}}function Ut(t,e,n,r){var u,b,O;const o=Gt(t),i=((u=o==null?void 0:o.coordinateBox)==null?void 0:u.geometry)||null;if(!i&&r.skipNullGeometry)return null;const s={type:"Feature",geometry:i,properties:Object.assign({"@geometry-type":"networklink"},F(t,["name","address","visibility","open","phoneNumber","styleUrl","refreshVisibility","flyToView","description"]),H(t),J(t,e),G(t),Q(t),q(t,n),W(t),K(t),It(t),o!=null&&o.lod?{lod:o.lod}:{})};(b=o==null?void 0:o.coordinateBox)!=null&&b.bbox&&(s.bbox=o.coordinateBox.bbox),((O=s.properties)==null?void 0:O.visibility)!==void 0&&(s.properties.visibility=s.properties.visibility!=="0");const c=t.getAttribute("id");return c!==null&&c!==""&&(s.id=c),s}function $t(t){return t.length===0?null:t.length===1?t[0]:{type:"GeometryCollection",geometries:t}}function Vt(t,e,n,r){var b;const{coordTimes:o,geometries:i}=nt(t),s=$t(i);if(!s&&r.skipNullGeometry)return null;const c={type:"Feature",geometry:s,properties:Object.assign(F(t,["name","address","visibility","open","phoneNumber","description"]),H(t),J(t,e),G(t),q(t,n),W(t),K(t),o.length?{coordinateProperties:{times:o.length===1?o[0]:o}}:{})};((b=c.properties)==null?void 0:b.visibility)!==void 0&&(c.properties.visibility=c.properties.visibility!=="0");const u=t.getAttribute("id");return u!==null&&u!==""&&(c.id=u),c}function zt(t){let e=t.getAttribute("id");const n=t.parentNode;return!e&&Y(n)&&n.localName==="CascadingStyle"&&(e=n.getAttribute("kml:id")||n.getAttribute("id")),_(e||"")}function Qt(t){const e={};for(const n of L(t,"Style"))e[zt(n)]=G(n);for(const n of L(t,"StyleMap")){const r=_(n.getAttribute("id")||"");S(n,"styleUrl",o=>{o=_(o),e[o]&&(e[r]=e[o])})}return e}function qt(t){const e={};for(const n of L(t,"SimpleField"))e[n.getAttribute("name")||""]=$[n.getAttribute("type")||""]||$.string;return e}function*Ht(t,e={skipNullGeometry:!1}){const n=t,r=Qt(n),o=qt(n);for(const i of L(n,"Placemark")){const s=Vt(i,r,o,e);s&&(yield s)}for(const i of L(n,"GroundOverlay")){const s=Ft(i,r,o,e);s&&(yield s)}for(const i of L(n,"NetworkLink")){const s=Ut(i,r,o,e);s&&(yield s)}}function Wt(t,e={skipNullGeometry:!1}){return{type:"FeatureCollection",features:Array.from(Ht(t,e))}}function le(){const[t,e]=y.useState(!1),[n,r]=y.useState(!1),[o,i]=y.useState(!1),[s,c]=y.useState(null),u=y.useRef(null),{notification:b,notify:O,clearNotification:D}=yt(),{userPathList:A,refresh:E}=Xt(),[B,f]=y.useState(0);function rt(){e(!0)}function ot(){r(!0)}function it(){i(!0)}function st(){O("success","添加成功"),u.current=null,f(0),e(!1),E()}function at(l){O("success","删除 "+l.name+" 成功"),E()}async function ct(l){const x=l.name,N=await mt(l),h=ft(N),j=ut(h),X=(await lt(j)).map(w=>w.toArray()).join("|"),I=j.map(w=>w.join(",")).join("|"),k={name:x,originalPath:I,gpsPath:X};try{await Jt(k),st()}catch{O("error","添加路径接口失败")}}async function lt(l,x="gps",N=400){let h=0;const j=[];for(let T=0;T<l.length;T+=N){const I=l.slice(T,T+N).map(k=>k.join(",")).join("|");await new Promise(k=>{window.AMap.convertFrom(I,x,(w,ht)=>{if(w==="complete"){j.push(...ht.locations),k();const dt=(Math.min(T+N,l.length)/l.length*100).toFixed(2);f(dt)}})}),h%2===0?(await Kt(1),h=0):h++}return j}function ut(l){return l.features[2].geometry.coordinates.map(T=>[T[0],T[1]])}function ft(l){return Wt(new DOMParser().parseFromString(l,"text/xml"))}function mt(l){return new Promise((x,N)=>{const h=new FileReader;h.readAsText(l),h.onerror=()=>{N(h.error)},h.onload=()=>{const j=h.result;x(j)}})}function pt(l){const x=l.target.files;x.length<=0||(u.current=x[0])}function gt(){const l=u.current;l?ct(l):O("error","没有选择文件")}return a.jsxs("div",{children:[a.jsx("button",{className:"btn btn-primary",onClick:rt,children:"导入轨迹"}),a.jsx("button",{className:"btn btn-primary",onClick:ot,children:"路径管理"}),a.jsx("button",{className:"btn btn-primary",onClick:it,children:"行程管理"}),a.jsx("div",{className:"user-path-panel",children:A.map(l=>{const x=(s==null?void 0:s.name)===l.name;let N="user-path-item";return x&&(N+=" active"),a.jsx("div",{className:N,onClick:()=>c(l),children:l.name},l.name)})}),a.jsx(Lt,{activeUserPath:s,userPathList:A}),a.jsx(Zt,{open:o,onClose:()=>{i(!1)},onAdd:()=>{console.log("添加行程成功")},userPathList:A}),a.jsx(Yt,{open:n,onClose:()=>r(!1),userPathList:A,onDelete:l=>{at(l)}}),a.jsx(V,{isOpen:t,onClose:()=>e(!1),title:"导入轨迹",size:"md",position:"center",children:a.jsxs("form",{children:[a.jsxs("div",{className:"form-item",children:[a.jsx("label",{children:"坐标解析进度"}),a.jsx(Nt,{percent:B})]}),a.jsx("div",{className:"form-item",children:a.jsx("input",{type:"file",onChange:pt})}),a.jsx("div",{className:"form-item",children:a.jsx("button",{className:"btn btn-primary",onClick:gt,children:"同步"})})]})}),b&&a.jsx(bt,{type:b.type,message:b.message,onClose:D})]})}function Kt(t){return new Promise(e=>setTimeout(e,t*1e3))}async function Jt({name:t,originalPath:e,gpsPath:n}){const{error:r}=await C.from("user_paths").insert([{name:t,original_path:e,gps_path:n}]).select();if(r)throw r}function Xt(){const[t,e]=y.useState([]);async function n(){let{data:r}=await C.from("user_paths").select("*");e(r)}return y.useEffect(()=>{async function r(){await n()}r()},[]),{userPathList:t,refresh:n}}function Yt({open:t,onClose:e,userPathList:n,onDelete:r}){async function o(i){const{error:s}=await C.from("user_paths").delete().eq("name",i.name);s||r(i)}return a.jsx(V,{isOpen:t,onClose:e,title:"导入轨迹",size:"md",position:"center",children:n.map(i=>a.jsx("div",{children:a.jsxs("div",{children:[i.name," ",a.jsx("button",{onClick:()=>o(i),children:"删除"})]})},i.name))})}function Zt({open:t,onClose:e,onAdd:n,userPathList:r}){const[o,i]=y.useState(""),[s,c]=y.useState([]),[u,b]=y.useState(null),O=r.map(f=>({label:f.name,value:f.id}));async function D(){let{data:f}=await C.from("traveling_paths").select("*");return f}async function A(){const f=await D();c(f)}y.useEffect(()=>{A()},[]);async function E(){if(!o){alert("请输入标题");return}const{error:f}=await C.from("traveling_paths").insert([{title:o,legs:[]}]).select();f||(await A(),i(""),n())}async function B(f){console.log(f)}return a.jsx(V,{isOpen:t,onClose:e,title:"行程管理",size:"md",position:"center",children:a.jsxs("div",{style:{height:600},children:[a.jsxs("div",{className:"create-traveling-form",children:[a.jsxs("div",{className:"form-item",children:[a.jsx("label",{children:"行程名称"}),a.jsx("input",{style:{width:200},type:"text",value:o,onChange:f=>i(f.target.value)})]}),a.jsx("div",{className:"form-item",children:a.jsx("button",{className:"btn btn-primary",onClick:E,children:"添加行程"})})]}),a.jsx("ul",{children:s.map(f=>a.jsxs("li",{className:"traveling-path-item",children:[a.jsx("div",{children:f.title}),a.jsx("div",{onClick:()=>B(f),children:"增加"}),a.jsx(xt,{value:u,onChange:b,options:O,placeholder:"选择对应的里程",style:{width:"200px"}})]},f.title))})]})})}export{le as default};
