import{s as N,h as w,j as e}from"./index-DAKo2Xqa.js";import{b as i}from"./vendor-C_ovgAfI.js";import{M as b}from"./index-CIjolgdJ.js";import{f as L}from"./utils-CWHH1IbV.js";import{z as D}from"./zh-CN-CCt-M6vz.js";const v={async fetchLogs({environment:s,startDate:a,endDate:l,searchTerm:t,limit:c=100}){try{let n=N.from("error_logs").select("*").order("timestamp",{ascending:!1});s&&(n=n.eq("environment",s)),a&&(n=n.gte("timestamp",a)),l&&(n=n.lte("timestamp",l)),t&&(n=n.or(`error.ilike.%${t}%,component_info.ilike.%${t}%`));const{data:r,error:d}=await n.limit(c);if(d)throw d;return r}catch(n){throw new Error(w(n))}},async deleteLogs(s){try{const{error:a}=await N.from("error_logs").delete().lt("timestamp",s);if(a)throw a}catch(a){throw new Error(w(a))}},async exportLogs(s){const a=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...s.map(t=>[new Date(t.timestamp).toLocaleString(),t.environment,t.component_info,`"${t.error.replace(/"/g,'""')}"`,t.url,`"${t.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([a],{type:"text/csv;charset=utf-8;"})}};function y(){const[s,a]=i.useState([]),[l,t]=i.useState(!0),[c,n]=i.useState(null),[r,d]=i.useState({environment:"",startDate:"",endDate:"",searchTerm:""}),x=[...new Set(s.map(m=>m.environment))],h=i.useCallback(async()=>{try{t(!0);const m=await v.fetchLogs(r);a(m),n(null)}catch(m){n(m.message)}finally{t(!1)}},[r]);i.useEffect(()=>{h()},[h]);const j=i.useCallback((m,g)=>{d(p=>({...p,[m]:g}))},[]);return{logs:s,isLoading:l,error:c,setError:n,filters:r,environments:x,updateFilter:j,fetchLogs:h}}function C({filters:s,environments:a,onFilterChange:l}){return e.jsxs("div",{className:"filters",children:[e.jsxs("select",{value:s.environment,onChange:t=>l("environment",t.target.value),children:[e.jsx("option",{value:"",children:"所有环境"}),a.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{type:"date",value:s.startDate,onChange:t=>l("startDate",t.target.value),placeholder:"开始日期"}),e.jsx("input",{type:"date",value:s.endDate,onChange:t=>l("endDate",t.target.value),placeholder:"结束日期"}),e.jsx("input",{type:"text",value:s.searchTerm,onChange:t=>l("searchTerm",t.target.value),placeholder:"搜索错误信息..."})]})}function S({log:s}){const[a,l]=i.useState(!1),t=(r,d=80)=>r?r.length>d?`${r.substring(0,d)}...`:r:"",c=L(new Date(s.timestamp),{addSuffix:!0,locale:D}),n=e.jsx("button",{onClick:()=>l(!1),children:"关闭"});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"log-item",children:[e.jsxs("div",{className:"log-item-main",children:[e.jsxs("div",{className:"log-item-header",children:[e.jsx("div",{className:"log-item-time",children:c}),e.jsx("div",{className:"log-item-env",children:s.environment})]}),e.jsxs("div",{className:"log-item-error",children:[e.jsx("div",{className:"log-item-component",children:s.component_info}),e.jsx("div",{className:"log-item-message",children:t(s.error)})]})]}),e.jsx("div",{className:"log-item-actions",children:e.jsx("button",{className:"log-item-details-btn",onClick:()=>l(!0),children:"查看详情"})})]}),e.jsx(b,{isOpen:a,onClose:()=>l(!1),title:"错误日志详情",size:"md",footer:n,children:e.jsxs("div",{className:"log-details",children:[e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"基本信息"}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"时间："}),e.jsx("span",{className:"log-details-value",children:new Date(s.timestamp).toLocaleString()})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"环境："}),e.jsx("span",{className:"log-details-value",children:s.environment})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"组件："}),e.jsx("span",{className:"log-details-value",children:s.component_info})]})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"错误信息"}),e.jsx("div",{className:"log-details-error",children:s.error})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"URL"}),e.jsx("div",{className:"log-details-url",children:e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",children:s.url})})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"用户代理"}),e.jsx("div",{className:"log-details-user-agent",children:s.user_agent})]})]})})]})}function k({isOpen:s,onClose:a,onConfirm:l,deleteDate:t,onDateChange:c}){const n=e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-button",onClick:a,children:"取消"}),e.jsx("button",{className:"confirm-button danger",onClick:l,children:"确认删除"})]});return e.jsx(b,{isOpen:s,onClose:a,title:"删除历史错误日志",size:"sm",footer:n,children:e.jsxs("div",{className:"delete-modal-content",children:[e.jsx("p",{children:"确定要删除多久以前的错误日志？"}),e.jsx("div",{className:"delete-date-selector",children:e.jsxs("select",{value:t,onChange:r=>c(Number(r.target.value)),children:[e.jsx("option",{value:7,children:"7天前"}),e.jsx("option",{value:30,children:"30天前"}),e.jsx("option",{value:90,children:"90天前"}),e.jsx("option",{value:180,children:"180天前"}),e.jsx("option",{value:365,children:"一年前"})]})}),e.jsx("p",{className:"delete-warning",children:"注意：此操作不可恢复，将永久删除所选时间之前的所有错误日志记录。"})]})})}function U(){const{logs:s,isLoading:a,error:l,filters:t,environments:c,updateFilter:n,fetchLogs:r,setError:d}=y(),[x,h]=i.useState(!1),[j,m]=i.useState(30),g=async()=>{const o=await v.exportLogs(s),f=window.URL.createObjectURL(o),u=document.createElement("a");u.href=f,u.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(f),document.body.removeChild(u)},p=async()=>{try{const o=new Date;o.setDate(o.getDate()-j),await v.deleteLogs(o.toISOString()),h(!1),r()}catch(o){console.error("Error deleting logs:",o),d(o.message||"删除日志失败"),h(!1)}};return e.jsxs("div",{className:"error-logs",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"错误日志"}),e.jsxs("div",{className:"header-actions",children:[e.jsx("span",{className:"log-count",children:a?"加载中...":`${s.length} 条记录`}),e.jsx("button",{onClick:g,children:"导出日志"}),e.jsx("button",{className:"danger-outline",onClick:()=>h(!0),children:"删除历史日志"})]})]}),e.jsx(C,{filters:t,environments:c,onFilterChange:n}),l&&e.jsx("div",{className:"error-message",children:l}),a?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载错误日志..."})]}):e.jsx("div",{className:"logs-list",children:s.length>0?s.map(o=>e.jsx(S,{log:o},o.id)):e.jsx("div",{className:"no-logs",children:e.jsx("p",{children:"没有找到符合条件的错误日志"})})}),e.jsx(k,{isOpen:x,onClose:()=>h(!1),onConfirm:p,deleteDate:j,onDateChange:m})]})}export{U as default};
