import{s as N,h as w,j as e}from"./index-BU-30AHs.js";import{b as c}from"./vendor-C_ovgAfI.js";import{f as L}from"./utils-CWHH1IbV.js";import{z as b}from"./zh-CN-CCt-M6vz.js";import{M as y}from"./index-B8NPo5ma.js";const v={async fetchLogs({environment:s,startDate:n,endDate:a,searchTerm:t,limit:m=100}){try{let r=N.from("error_logs").select("*").order("timestamp",{ascending:!1});s&&(r=r.eq("environment",s)),n&&(r=r.gte("timestamp",n)),a&&(r=r.lte("timestamp",a)),t&&(r=r.or(`error.ilike.%${t}%,component_info.ilike.%${t}%`));const{data:l,error:h}=await r.limit(m);if(h)throw h;return l}catch(r){throw new Error(w(r))}},async deleteLogs(s){try{const{error:n}=await N.from("error_logs").delete().lt("timestamp",s);if(n)throw n}catch(n){throw new Error(w(n))}},async exportLogs(s){const n=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...s.map(t=>[new Date(t.timestamp).toLocaleString(),t.environment,t.component_info,`"${t.error.replace(/"/g,'""')}"`,t.url,`"${t.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([n],{type:"text/csv;charset=utf-8;"})}};function D(){const[s,n]=c.useState([]),[a,t]=c.useState(!0),[m,r]=c.useState(null),[l,h]=c.useState({environment:"",startDate:"",endDate:"",searchTerm:""}),g=[...new Set(s.map(i=>i.environment))],d=c.useCallback(async()=>{try{t(!0);const i=await v.fetchLogs(l);n(i),r(null)}catch(i){r(i.message)}finally{t(!1)}},[l]);c.useEffect(()=>{d()},[d]);const p=c.useCallback((i,x)=>{h(j=>({...j,[i]:x}))},[]);return{logs:s,isLoading:a,error:m,setError:r,filters:l,environments:g,updateFilter:p,fetchLogs:d}}function C({filters:s,environments:n,onFilterChange:a}){return e.jsxs("div",{className:"filters",children:[e.jsxs("select",{value:s.environment,onChange:t=>a("environment",t.target.value),children:[e.jsx("option",{value:"",children:"所有环境"}),n.map(t=>e.jsx("option",{value:t,children:t},t))]}),e.jsx("input",{type:"date",value:s.startDate,onChange:t=>a("startDate",t.target.value),placeholder:"开始日期"}),e.jsx("input",{type:"date",value:s.endDate,onChange:t=>a("endDate",t.target.value),placeholder:"结束日期"}),e.jsx("input",{type:"text",value:s.searchTerm,onChange:t=>a("searchTerm",t.target.value),placeholder:"搜索错误信息..."})]})}function S({log:s}){return e.jsxs("div",{className:"log-item",children:[e.jsxs("div",{className:"log-header",children:[e.jsx("span",{className:"log-time",children:L(new Date(s.timestamp),{addSuffix:!0,locale:b})}),e.jsx("span",{className:"log-environment",children:s.environment})]}),e.jsxs("div",{className:"log-content",children:[e.jsx("div",{className:"log-component",children:s.component_info}),e.jsx("div",{className:"log-message",children:s.error}),e.jsx("div",{className:"log-url",children:s.url})]}),e.jsx("div",{className:"log-footer",children:e.jsx("span",{className:"log-user-agent",children:s.user_agent})})]})}function E({isOpen:s,onClose:n,onConfirm:a,deleteDate:t,onDateChange:m}){const r=e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-button",onClick:n,children:"取消"}),e.jsx("button",{className:"confirm-button danger",onClick:a,children:"确认删除"})]});return e.jsx(y,{isOpen:s,onClose:n,title:"删除历史错误日志",size:"sm",footer:r,children:e.jsxs("div",{className:"delete-modal-content",children:[e.jsx("p",{children:"确定要删除多久以前的错误日志？"}),e.jsx("div",{className:"delete-date-selector",children:e.jsxs("select",{value:t,onChange:l=>m(Number(l.target.value)),children:[e.jsx("option",{value:7,children:"7天前"}),e.jsx("option",{value:30,children:"30天前"}),e.jsx("option",{value:90,children:"90天前"}),e.jsx("option",{value:180,children:"180天前"}),e.jsx("option",{value:365,children:"一年前"})]})}),e.jsx("p",{className:"delete-warning",children:"注意：此操作不可恢复，将永久删除所选时间之前的所有错误日志记录。"})]})})}function M(){const{logs:s,isLoading:n,error:a,filters:t,environments:m,updateFilter:r,fetchLogs:l,setError:h}=D(),[g,d]=c.useState(!1),[p,i]=c.useState(30),x=async()=>{const o=await v.exportLogs(s),f=window.URL.createObjectURL(o),u=document.createElement("a");u.href=f,u.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(f),document.body.removeChild(u)},j=async()=>{try{const o=new Date;o.setDate(o.getDate()-p),await v.deleteLogs(o.toISOString()),d(!1),l()}catch(o){console.error("Error deleting logs:",o),h(o.message||"删除日志失败"),d(!1)}};return e.jsxs("div",{className:"error-logs",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"错误日志"}),e.jsxs("div",{className:"header-actions",children:[e.jsx("span",{className:"log-count",children:n?"加载中...":`${s.length} 条记录`}),e.jsx("button",{onClick:x,children:"导出日志"}),e.jsx("button",{className:"danger-outline",onClick:()=>d(!0),children:"删除历史日志"})]})]}),e.jsx(C,{filters:t,environments:m,onFilterChange:r}),a&&e.jsx("div",{className:"error-message",children:a}),n?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载错误日志..."})]}):e.jsx("div",{className:"logs-list",children:s.length>0?s.map(o=>e.jsx(S,{log:o},o.id)):e.jsx("div",{className:"no-logs",children:e.jsx("p",{children:"没有找到符合条件的错误日志"})})}),e.jsx(E,{isOpen:g,onClose:()=>d(!1),onConfirm:j,deleteDate:p,onDateChange:i})]})}export{M as default};
