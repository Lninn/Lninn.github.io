import{s as N,h as b,j as e}from"./index-B6TE9ouq.js";import{b as c}from"./vendor-C_ovgAfI.js";import{S as L}from"./index-CNqgswg4.js";import{M as w}from"./index-uaSGgH4S.js";import{f as D}from"./utils-CWHH1IbV.js";import{z as y}from"./zh-CN-CCt-M6vz.js";const v={async fetchLogs({environment:s,startDate:t,endDate:n,searchTerm:a,limit:r=100}){try{let l=N.from("error_logs").select("*").order("timestamp",{ascending:!1});s&&(l=l.eq("environment",s)),t&&(l=l.gte("timestamp",t)),n&&(l=l.lte("timestamp",n)),a&&(l=l.or(`error.ilike.%${a}%,component_info.ilike.%${a}%`));const{data:i,error:d}=await l.limit(r);if(d)throw d;return i}catch(l){throw new Error(b(l))}},async deleteLogs(s){try{const{error:t}=await N.from("error_logs").delete().lt("timestamp",s);if(t)throw t}catch(t){throw new Error(b(t))}},async exportLogs(s){const t=[["时间","环境","组件","错误信息","URL","用户代理"].join(","),...s.map(a=>[new Date(a.timestamp).toLocaleString(),a.environment,a.component_info,`"${a.error.replace(/"/g,'""')}"`,a.url,`"${a.user_agent.replace(/"/g,'""')}"`].join(","))].join(`
`);return new Blob([t],{type:"text/csv;charset=utf-8;"})}};function S(){const[s,t]=c.useState([]),[n,a]=c.useState(!0),[r,l]=c.useState(null),[i,d]=c.useState({environment:"",startDate:"",endDate:"",searchTerm:""}),x=[...new Set(s.map(m=>m.environment))],h=c.useCallback(async()=>{try{a(!0);const m=await v.fetchLogs(i);t(m),l(null)}catch(m){l(m.message)}finally{a(!1)}},[i]);c.useEffect(()=>{h()},[h]);const j=c.useCallback((m,p)=>{d(g=>({...g,[m]:p}))},[]);return{logs:s,isLoading:n,error:r,setError:l,filters:i,environments:x,updateFilter:j,fetchLogs:h}}function C({filters:s,environments:t,onFilterChange:n}){const a=[{value:"",label:"所有环境"},...t.map(r=>({value:r,label:r}))];return e.jsx("div",{className:"filters-container",children:e.jsxs("div",{className:"filters-wrapper",children:[e.jsxs("div",{className:"filters-group",children:[e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"环境"}),e.jsx(L,{options:a,value:s.environment,onChange:r=>n("environment",r),placeholder:"选择环境",className:"filter-select"})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"开始日期"}),e.jsx("input",{type:"date",value:s.startDate,onChange:r=>n("startDate",r.target.value),className:"filter-input"})]}),e.jsxs("div",{className:"filter-item",children:[e.jsx("label",{className:"filter-label",children:"结束日期"}),e.jsx("input",{type:"date",value:s.endDate,onChange:r=>n("endDate",r.target.value),className:"filter-input"})]})]}),e.jsx("div",{className:"filter-item filter-item-search",children:e.jsx("input",{type:"text",value:s.searchTerm,onChange:r=>n("searchTerm",r.target.value),placeholder:"搜索错误信息...",className:"filter-input search-input"})})]})})}function k({log:s}){const[t,n]=c.useState(!1),a=(i,d=80)=>i?i.length>d?`${i.substring(0,d)}...`:i:"",r=D(new Date(s.timestamp),{addSuffix:!0,locale:y}),l=e.jsx("button",{onClick:()=>n(!1),children:"关闭"});return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"log-item",children:[e.jsxs("div",{className:"log-item-main",children:[e.jsxs("div",{className:"log-item-header",children:[e.jsx("div",{className:"log-item-time",children:r}),e.jsx("div",{className:"log-item-env",children:s.environment})]}),e.jsxs("div",{className:"log-item-error",children:[e.jsx("div",{className:"log-item-component",children:s.component_info}),e.jsx("div",{className:"log-item-message",children:a(s.error)})]})]}),e.jsx("div",{className:"log-item-actions",children:e.jsx("button",{className:"log-item-details-btn",onClick:()=>n(!0),children:"查看详情"})})]}),e.jsx(w,{isOpen:t,onClose:()=>n(!1),title:"错误日志详情",size:"md",footer:l,children:e.jsxs("div",{className:"log-details",children:[e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"基本信息"}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"时间："}),e.jsx("span",{className:"log-details-value",children:new Date(s.timestamp).toLocaleString()})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"环境："}),e.jsx("span",{className:"log-details-value",children:s.environment})]}),e.jsxs("div",{className:"log-details-row",children:[e.jsx("span",{className:"log-details-label",children:"组件："}),e.jsx("span",{className:"log-details-value",children:s.component_info})]})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"错误信息"}),e.jsx("div",{className:"log-details-error",children:s.error})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"URL"}),e.jsx("div",{className:"log-details-url",children:e.jsx("a",{href:s.url,target:"_blank",rel:"noopener noreferrer",children:s.url})})]}),e.jsxs("div",{className:"log-details-section",children:[e.jsx("h4",{children:"用户代理"}),e.jsx("div",{className:"log-details-user-agent",children:s.user_agent})]})]})})]})}function E({isOpen:s,onClose:t,onConfirm:n,deleteDate:a,onDateChange:r}){const l=e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"cancel-button",onClick:t,children:"取消"}),e.jsx("button",{className:"confirm-button danger",onClick:n,children:"确认删除"})]});return e.jsx(w,{isOpen:s,onClose:t,title:"删除历史错误日志",size:"sm",footer:l,children:e.jsxs("div",{className:"delete-modal-content",children:[e.jsx("p",{children:"确定要删除多久以前的错误日志？"}),e.jsx("div",{className:"delete-date-selector",children:e.jsxs("select",{value:a,onChange:i=>r(Number(i.target.value)),children:[e.jsx("option",{value:7,children:"7天前"}),e.jsx("option",{value:30,children:"30天前"}),e.jsx("option",{value:90,children:"90天前"}),e.jsx("option",{value:180,children:"180天前"}),e.jsx("option",{value:365,children:"一年前"})]})}),e.jsx("p",{className:"delete-warning",children:"注意：此操作不可恢复，将永久删除所选时间之前的所有错误日志记录。"})]})})}function M(){const{logs:s,isLoading:t,error:n,filters:a,environments:r,updateFilter:l,fetchLogs:i,setError:d}=S(),[x,h]=c.useState(!1),[j,m]=c.useState(30),p=async()=>{const o=await v.exportLogs(s),f=window.URL.createObjectURL(o),u=document.createElement("a");u.href=f,u.download=`错误日志_${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(f),document.body.removeChild(u)},g=async()=>{try{const o=new Date;o.setDate(o.getDate()-j),await v.deleteLogs(o.toISOString()),h(!1),i()}catch(o){console.error("Error deleting logs:",o),d(o.message||"删除日志失败"),h(!1)}};return e.jsxs("div",{className:"error-logs",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h2",{children:"错误日志"}),e.jsxs("div",{className:"header-actions",children:[e.jsx("span",{className:"log-count",children:t?"加载中...":`${s.length} 条记录`}),e.jsx("button",{onClick:p,children:"导出日志"}),e.jsx("button",{className:"danger-outline",onClick:()=>h(!0),children:"删除历史日志"})]})]}),e.jsx(C,{filters:a,environments:r,onFilterChange:l}),n&&e.jsx("div",{className:"error-message",children:n}),t?e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"正在加载错误日志..."})]}):e.jsx("div",{className:"logs-list",children:s.length>0?s.map(o=>e.jsx(k,{log:o},o.id)):e.jsx("div",{className:"no-logs",children:e.jsx("p",{children:"没有找到符合条件的错误日志"})})}),e.jsx(E,{isOpen:x,onClose:()=>h(!1),onConfirm:g,deleteDate:j,onDateChange:m})]})}export{M as default};
