name: Update Log on Dev Push

on:
  push:
    branches:
      - dev  # 仅在 dev 分支有新提交时触发

jobs:
  update-log:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 获取完整的提交历史

      # 2. 切换到 main 分支
      - name: Switch to main branch
        run: |
          git fetch origin main
          git checkout main

      # 3. 创建 articles 文件夹（如果不存在）
      - name: Create articles directory
        run: mkdir -p articles

      # 4. 获取最新提交信息
      - name: Get latest commit info
        id: commit
        run: |
          echo "::set-output name=date::$(git log -1 --format=%cd --date=short)"
          echo "::set-output name=author::$(git log -1 --format=%an)"
          echo "::set-output name=message::$(git log -1 --format=%s)"

      # 5. 创建或更新 log.md 文件
      - name: Update log.md
        run: |
          LOG_FILE="articles/log.md"
          if [ ! -f "$LOG_FILE" ]; then
            echo "# Commit Log" > "$LOG_FILE"
            echo "" >> "$LOG_FILE"
          fi
          echo "## $(git log -1 --format=%cd --date=short)" >> "$LOG_FILE"
          echo "- **Author**: $(git log -1 --format=%an)" >> "$LOG_FILE"
          echo "- **Message**: $(git log -1 --format=%s)" >> "$LOG_FILE"
          echo "" >> "$LOG_FILE"

      # 6. 提交更改到 main 分支
      - name: Commit changes to main branch
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          ls
          git add articles/log.md
          git commit -m "Update log.md with latest commit info"
          git push origin main
